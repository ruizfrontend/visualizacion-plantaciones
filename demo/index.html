<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<link href="https://fonts.googleapis.com/css?family=Merriweather:900|Open+Sans|Roboto:400,700,900" rel="stylesheet">
    
    <link rel="stylesheet" href="http://artesansatwork.com/eldiario/wp-content/themes/appress/css/bootstrap-3.3.5.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://artesansatwork.com/eldiario/wp-content/themes/appress/css/font-faces.css?v=1490716027">
    <link rel="stylesheet" href="http://artesansatwork.com/eldiario/wp-content/themes/appress/css/app-template.css?v=1490716027">
    <link rel="stylesheet" href="http://artesansatwork.com/eldiario/wp-content/themes/appress/style.css?v=1490716027">
    <link rel="stylesheet" href="http://artesansatwork.com/eldiario/wp-content/themes/appress/css/responsive.css?v=1490716028">
    <link rel="stylesheet" href="http://artesansatwork.com/eldiario/wp-content/themes/appress/css/slick.css">
    <link rel="stylesheet" href="http://artesansatwork.com/eldiario/wp-content/themes/appress/css/slick-theme.css">
    
    
    <script src="http://artesansatwork.com/eldiario/wp-content/themes/appress/js/jquery-2.1.4.min.js"></script>
    <script src="http://artesansatwork.com/eldiario/wp-content/themes/appress/js/bootstrap-3.3.5.min.js"></script>
    <script src="http://artesansatwork.com/eldiario/wp-content/themes/appress/js/slick.min.js"></script>
    <script src="http://artesansatwork.com/eldiario/wp-content/themes/appress/js/app-template-scripts.js?v=1490716028"></script>

	<script type="text/javascript" src="http://estaticos.lab.eldiario.es/estaticos/libs/jquery.autocomplete.js"></script>
	<script src="http://estaticos.lab.eldiario.es/libs/d3-4.7.1.min.js"></script>
    
    
    <link rel="shortcut icon" href="http://artesansatwork.com/eldiario/wp-content/themes/appress/images/favicon.png">
	
	<title>TITEL - eldiario.es</title>
	<meta name="description" content="DESC">
	<meta name="keywords" content="KEYWS">
	<meta charset="utf-8">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta http-equiv="Content-Language" content="es-es">

	<meta property="og:title" content="TTTIEL">
	<meta property="og:description" content="DESC">
	<meta property="og:url" content="URL">
	<meta property="og:site_name" content="TTTIEL" />

	<meta name="twitter:image:src" content="JPG">
	<meta property="og:image" content="JPG">

	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:site" content="@eldiarioes">
	<meta name="twitter:creator" content="@eldiarioes">
	<meta name="twitter:title" content="TTTIEL">
	<meta name="twitter:description" content="DESC">

	<meta property="fb:app_id" content="417471918268686">

	<meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<style>
body { font-size: 14px; }
#plantiGraph { width: 100%; overflow: hidden; font-family: 'Roboto'; }

	#plantiGraph h1 { margin: 0.4em 0 1.2em 0; padding: 0 0.4em; text-align: center; }
		#plantiGraph.fullGraph h1 { margin: 0.4em 0; text-align: left; }
	#plantiGraph h4 { font-family: roboto, sans-serif; font-size: 1.4em; font-weight: 900; }

#plantiGraph .btn { margin-left: 0; background: #999999; color: white; border-radius: 0; margin-bottom: 0.4em;
	        padding: 0.2em 0.4em 0.2em 0.4em; margin-right: 0.2em; font-weight: 900; }
	#plantiGraph .btn:hover { opacity: 0.8; }
	#plantiGraph .btn.act { background: #d35d33; color: white; }

	#type, #prods, #years { text-align: center; box-sizing: border-box; padding: 0 0.4em 1.4em 0.4em; }
	.fullGraph #type, .fullGraph #prods, .fullGraph #years { width: 33.33333333%; float: left;
			text-align: left; }
		.fullGraph #type { width: 30%; }
		.fullGraph #prods { width: 50%; }
		.fullGraph #years { width: 20%; }
		#type p, #prods p, #years p { margin-bottom: 0.6em; }
		
		#prods img { height: 25px; }
			.fullGraph #prods img { height: 20px; }
		#prods .btn { width: 50px; padding: 0.6em 0; }
			.fullGraph #prods .btn { width: auto; padding: 0.2em 0.4em 0.2em 0.4em; }
		#prods span { display: none; }
			.fullGraph #prods span { display: initial; padding-left: 0.4em; }

	#typeImp.act { background: #126567!important; }
	#typeExp.act { background: #d35d33!important; }

	#yearsSel a, #yearsSel div { display: inline-block; padding: 0.4em 0.6em; }
		#yearsSel a i { font-weight: 900; font-size: 1.4em; }
		#activeYear { border: 1px solid #ccc; }
		
		#years .disabled { cursor: inherit; color: #ccc; }

#graph { background: #efefef; position: relative; }

	#graph.hover .link, #graph.hover .circImp, #graph.hover .circExp { opacity: 0.2; }

	.link { fill: none; stroke: rgba(0,0,0,0.2); stroke: url(#linearGradient); opacity: 0.6;
				-webkit-transition: all .5s; -ms-transition: all .5s; transition: all .5s; }
		.link-left { stroke: url(#linearGradientInverse);}
		/* .link:hover, .link-act { stroke: rgba(60, 4, 4, 0.6); }*/

	.axes text { font-weight: 900; font-family: roboto; fill: #aaa; }
		.axes path { stroke-width: 0; }

	.circImp { fill: #126567; cursor: pointer; }
		.fullGraph .circImp {  -webkit-transition: all .5s; -ms-transition: all .5s; transition: all .5s; }

	.circImpAct, .circExpAct { opacity: 1!important; }
		.linkAct { opacity: .9!important; }

	.circExp { fill: #d35d33; cursor: pointer; }
		.fullGraph .circExp {  -webkit-transition: all .5s; -ms-transition: all .5s; transition: all .5s; }

	.text {  fill: white; font-weight: 900; font-family: arial, sans-serif; font-size: 10px; pointer-events: none; text-anchor: middle; }
		.fullGraph .text { -webkit-transition: stroke .5s; -ms-transition: stroke .5s; transition: stroke .5s; font-size: 12px; }

	.circLines { stroke-width: 1px; fill: white; cursor: pointer; }
	.circLinesWhite { stroke-width: 1px; stroke: white; fill: white; cursor: pointer; }
	.linesExp { stroke: #126567; }
	.linesImp { stroke: #d35d33; }
	.linesExpFill { fill: #126567; }
	.linesImpFill { fill: #d35d33; }

	#plantiGraph.fullGraph #pop { position: absolute; top: 0; height: 100%; overflow: auto; right: 0; width: 300px; max-width: 800px; background: #efefef; z-index: 1;
				-webkit-transition: all 1s; -ms-transition: all 1s; transition: all 1s; overflow-x: hidden;
			    border-left: 2px solid white; }
		#plantiGraph.fullGraph.actPop #pop { width: 100%; 
			-webkit-transition: all 1s; -ms-transition: all 1s; transition: all 1s; }
		#plantiGraph.fullGraph.actPop #viz { opacity: 0.6; pointer-events: none; 
			-webkit-transform: translateX(-200px); -ms-transform: translateX(-200px); transform: translateX(-200px); }

	#viz { -webkit-transition: all 1s; -ms-transition: all 1s; transition: all 1s; }
		#viz.blur { filter:url(#blur); } 

	#closePop { position: absolute; left: -100%;     position: absolute; top: 0; font-weight: 900;
			-webkit-transition: all 1s; -ms-transition: all 1s; transition: all 1s;
			cursor: pointer; padding: 1em; height: 100%; width: 100%; }
		#plantiGraph.fullGraph.actPop #closePop { left: 0; }
	
	#popWrap { padding: 1em; display: block; opacity: 0; -webkit-transition: all .2s; -ms-transition: all .3s; transition: all .3s; }
		.actPop #popWrap { opacity: 1; -webkit-transition-delay: .2s; -ms-transition-delay: .3s; transition-delay: .3s; }

	#search { padding: 1.4em; padding-bottom: 0; position: relative; max-width: 400px; line-height: 1.3em; }
		#search i { position: absolute; left: 1.6em; top: 1.6em; font-size: 1.2em; }
		#countryImput { padding-left: 30px; margin-bottom: 0.8em; }
			.fullGraph #countryImput { max-width: 200px; float: left; margin-right: 1em; }
		#searchSelected { display: none; }
			#searchSelected a { display: inline-block; background: #666666; padding: 0.5em 2.5em 0.6em 0.8em; position: relative; color: white; font-weight: 900; cursor: pointer; }
			#searchSelected a:hover { opacity: 0.8; }
				#searchSelected a:before { content: '\f00d'; display: block; font-family: FontAwesome; position: absolute; right: 0.8em; }
	
	#graphBars1, #graphBars2, #graphLines { width: 33.33333%; float: left; box-sizing: border-box; padding: 0.4em; padding-top: 0;
			    margin-bottom: 1em; display: none; }
		.fullGraph #graphBars1, .fullGraph #graphBars2, .fullGraph #graphLines { display: block; }
	#graphBars1 li, #graphBars2 li { list-style: none; line-height: 1.8em; }
	#graphBars1 .key, #graphBars2 .key { display: inline-block; width: 33px; text-align: center; font-weight: 900; text-transform: uppercase; line-height: 1.7em; }
	#popWrap .inn { padding: 1em; background: white; }
#pop h4 { font-size: 1em; font-family: roboto, sans-serif; font-weight: 900; }

.bar { background: #ccc; position: relative; display: inline-block; line-height: 1.5em; margin-left: 1em; height: 1.7em; vertical-align: middle; width: 0; }
		 .bar:hover { opacity: 0.8; }
	.bar span { position: absolute; right: 0; padding: 0.6em; line-height: 1em; }

	.bar-left span { right: inherit; left: 100%; }

	.activeBar .bar span { color: white; pointer-events: none; }
	.activeBar .bar-left span { color: #484848; }

	.graphBarsExp .activeBar .bar { background: #d35d33; }
	.graphBarsImp .activeBar .bar { background: #126567; }

#frases li { list-style: none; padding: 0.8em 50px 0.8em 0.8em; background: white; margin: 0 0.4em 0.8em 0.4em; position: relative; cursor: pointer; }
#frases li:hover { text-decoration: underline; }
#frases li i { position: absolute; right: 0; bottom: 0; padding: 0.4em; font-size: 1.6em; color: #00aced; text-decoration: none!important; }

.autocomplete-suggestions { padding: 1em; line-height: 1.2em; background: #ccc; cursor: pointer; color: #666; font-weight: 900; }
.autocomplete-suggestion { text-decoration: underline; line-height: 1.6em; }
	.autocomplete-suggestion:hover { color: #333; }

#plantiGraph .btn-cacao.act { background: #529fbc; }
#plantiGraph .btn-banana.act { background: #e0e233; }
#plantiGraph .btn-azucar.act { background: #96cb51; }
#plantiGraph .btn-aceite.act { background: #d3a016; }
#plantiGraph .btn-cafe.act { background: #b51629; }

.tooltip.top .tooltip-arrow { border-top-color: background-color: rgba(0,0,0,0.8); }
.tooltip-inner { background-color: rgba(0,0,0,0.8); }
</style>
<body>
<div id="plantiGraph">
	<h1>Comercio internacional</h1>

	<div id="head" class="clearfix">
		<div id="type">
			<h4>¿Qué datos quieres mostrar?</h4>
			<p>Filtra por datos de exportación o importación</p>

			<a href="#" data-type="imp" id="typeImp" class="btn">Importaciones</a>
			<a href="#" data-type="exp" id="typeExp" class="btn">Exportaciones</a>
		</div>
		<div id="prods">
			<h4>¿Por qué producto quieres filtrar?</h4>
			<p>Selecciona una opción</p>

			<a href="#" data-prod="cacao" class="btn btn-cacao"><img src="./icons/chocolate.svg"><span>Cacao</span></a>
			<a href="#" data-prod="banana" class="btn btn-banana"><img src="./icons/banana.svg"><span>Banano</span></a>
			<a href="#" data-prod="azucar" class="btn btn-azucar"><img src="./icons/sugar.svg"><span>Azúcar</span></a>
			<a href="#" data-prod="aceite" class="btn btn-aceite"><img src="./icons/palm_oil.svg"><span>Aceite de palma</span></a>
			<a href="#" data-prod="cafe" class="btn btn-cafe"><img src="./icons/coffee.svg"><span>Café</span></a>
		</div>
		<div id="years">
			<h4>Año</h4>
			<p>Selecciona un año</p>
			<div id="yearsSel">
				<a href="#" class="prevYear"><i class="fa fa-angle-left" aria-hidden="true"></i></a>
				<div id="activeYear"></div>
				<a href="#" class="nextYear disabled"><i class="fa fa-angle-right" aria-hidden="true"></i></a>
			</div>
		</div>
	</div>



	<div id="graph">
		<svg id="viz" class="blur">
			<defs><filter id="blur"><feGaussianBlur in="SourceGraphic" stdDeviation="0"></feGaussianBlur></filter></defs>
			<linearGradient id="linearGradient">
	            <stop offset="0%"  stop-color="#126567"/><stop offset="100%" stop-color="#d35d33"/>
	        </linearGradient>
	        <linearGradient id="linearGradientInverse">
	            <stop offset="0%"  stop-color="#d35d33"/><stop offset="100%" stop-color="#126567"/>
	        </linearGradient>
		</svg>
		<div id="closePop">
			< Volver a la visualización Global
		</div>

		<div id="pop">

			<div id="search">
				<i class="fa fa-search" aria-hidden="true"></i>
				<input placeholder="Busca un país" type="text" id="countryImput" class="form-control">
				<p id="searchHelp" style="width: 260px;"><strong>Selecciona un pais</strong> o <strong>búscalo</strong> para conocer sus datos de comercio de plantaciones.</p>
				<p id="searchSelected"></p>
				<div id="searchResults"></div>
			</div>
			<div id="popWrap">
				<div id="frases">
					
				</div>
				<div id="graphLines"><div class="inn"><svg></svg></div>
					
				</div>
				<div id="graphBars1"><div class="inn"></div>
					
				</div>
				<div id="graphBars2"><div class="inn"></div>
					
				</div>
			</div>
		</div>
		
	</div>
</div>

<script>
var plantiGraph = {

	pathData: './',
	pathPaises: './paisesTot.json',
	pathQuery: '?mls3',

	act:{
		year: 2014,
		prod: 'cafe',
		type: ['imp', 'exp'],
	},

	breakPoint: 800,
	breakPointClass: 'fullGraph',
	breakPointSmallScreen: null, 

	maxCircProp: 25, // relation winWidth to maxCircProp
	maxCirc: null, // generated max circle size 
	maxLineProp: 70,
	maxLine: null,

	minLineProp: 10, // relation of max circ
	minLine: null,
	minCircProp: 15, // relation of max circ
	minCirc: null,

	maxWidthText: 13,
	maxWidthTextMovil: 11,

	textYOffsetMovil: 3,
	textYOffset: 5,

	initYear: 1995,
	lastYear: 2014,

	graphsElms: 5,

	viz: {
		width: 0,
		height: 0,

		$wrap: '#plantiGraph',
		$elm: '#viz',
		svg: null,

		projection: null,
		path: null,
		map: null,
		circImp: null,
		circExp: null,
		texts: null,
		force: null,
		scale: {
			circImp: null,
			circExp: null,
			circImpExp: null,
			lines: null,
		}
	},

	data: {
		countries: null, // datos reales
		
		yearTopExp: null, // calculo de tops del año activo
		yearTopImp: null,

		totalExp: null,
		totalImp: null,
	},

	txt: {
		articulos: {
			cafe: 'el café',
			aceite: 'el aceite de palma',
			cacao: 'el cacao',
			banana: 'el banano',
			azucar: 'el azúcar'
		},

		productos: {
			cafe: 'café',
			aceite: 'aceite de palma',
			cacao: 'cacao',
			banana: 'banano',
			azucar: 'azúcar'
		}
	},

	init: function() {

		plantiGraph.viz.svg = d3.select(plantiGraph.viz.$elm);
		plantiGraph.viz.$elm = $(plantiGraph.viz.$elm);
		plantiGraph.viz.$wrap = $(plantiGraph.viz.$wrap);

		plantiGraph.countryPop.init();

		plantiGraph.tools.initJqueries();

		$(window).bind('orientationchange resize', throttle(plantiGraph.tools.handleResize, 300));

		plantiGraph.tools.handleResize();
	},

	tools: {

		handleResize: function() {
			plantiGraph.tools.loadCountries();
			plantiGraph.tools.updateProjection();
			plantiGraph.tools.update();
			// plantiGraph.tools.initBG();
		},

		updateProjection: function() {

		   	plantiGraph.viz.width = $(window).width();
		   	plantiGraph.viz.height = plantiGraph.viz.width / 2;
			
			if(plantiGraph.viz.width < plantiGraph.breakPoint) {
				$('#blur').remove();
				
				plantiGraph.viz.height = plantiGraph.viz.width / 1.4;
				plantiGraph.viz.$wrap.removeClass(plantiGraph.breakPointClass);
				plantiGraph.breakPointSmallScreen = true;

			} else {
				plantiGraph.viz.$wrap.addClass(plantiGraph.breakPointClass);

			   	plantiGraph.viz.width = plantiGraph.viz.width - 300;
			   	plantiGraph.viz.height = plantiGraph.viz.width / 2;

			   	plantiGraph.breakPointSmallScreen = false;
			}

		   	plantiGraph.viz.$elm.css({
		   		width: plantiGraph.viz.width,
		   		height: plantiGraph.viz.height
		   	});

		   	plantiGraph.viz.projection = d3.geoMercator()
		   		.scale(170 * (plantiGraph.viz.width / 1000))
		   		.translate([(plantiGraph.viz.width / 2) - (plantiGraph.viz.width / 14), (plantiGraph.viz.height / 2) + (plantiGraph.viz.height / 5)])
				.precision(51);

			plantiGraph.viz.path = d3.geoPath().projection(plantiGraph.viz.projection);

			if(plantiGraph.data.prod)
				for (var i = 0; i < plantiGraph.data.prod.length; i++) {
					plantiGraph.data.prod[i].x = plantiGraph.viz.projection([plantiGraph.data.prod[i].lon, plantiGraph.data.prod[i].lat])[0];
					plantiGraph.data.prod[i].y = plantiGraph.viz.projection([plantiGraph.data.prod[i].lon, plantiGraph.data.prod[i].lat])[1];
				};

			plantiGraph.maxCirc = parseInt(plantiGraph.viz.width / plantiGraph.maxCircProp);
			plantiGraph.minCirc = Math.ceil(plantiGraph.maxCirc / plantiGraph.minCircProp);
			plantiGraph.maxLine = parseInt(plantiGraph.viz.width / plantiGraph.maxLineProp);
			plantiGraph.minLine = plantiGraph.maxLine / plantiGraph.minLineProp;

		},
			// fondo de paises
		initBG: function() {

			d3.json("./world-50m.json", function(error, world) {
				if (error) throw error;

				var countries = topojson.feature(world, world.objects.countries).features;
				// var neighbors = topojson.neighbors(world.objects.countries.geometries);

				if(plantiGraph.viz.map) plantiGraph.viz.map.remove()

				plantiGraph.viz.map = plantiGraph.viz.svg.selectAll(".country")
					.data(countries)
					.enter()
						.insert("path", ".graticule")
							.attr('d', plantiGraph.viz.path)
							.attr('class', "country")
							.style('stroke', '#ccc')
							.style('fill', 'none')
							.style('stroke-width', '1');

			});
		},

		loadCountries: function(cb) {

			d3.json(plantiGraph.pathPaises, function(error, world) {
			  	
			  	if (error) throw error;

			  	var paises = [];
			  	var autoComplete = [];

			  	for (var key in world) {
				  if (world.hasOwnProperty(key)) {

				    var pais = world[key];

				    pais.key = key;
				    pais.posX = plantiGraph.viz.projection([pais.lon, pais.lat])[0];
				    pais.posY = plantiGraph.viz.projection([pais.lon, pais.lat])[1];
				    pais.x = pais.posX;
				    pais.y = pais.posY;

				    paises.push(pais);

				    if(pais.x && pais.y) { // limita paises chungos

					    autoComplete.push({
					    	value: pais.name,
					    	data: {
					    		id: pais.name,
					    		key: pais.key
					    	}
					    });

				    }

				  }
				};
				
				$('#countryImput').autocomplete({
		          lookup: autoComplete,
		          minChars: 3,
		          orientation: 'bottom',
		          autoSelectFirst: true,
		          showNoSuggestionNotice: true,
		          // appendTo: '#searchResults',
		          noSuggestionNotice: 'No se encontraron coincidencias',
		          groupBy: 'p',
		          onSelect: function (suggestion) {
		            plantiGraph.countryPop.activa(suggestion.data.key);
		          }
		        });

				plantiGraph.data.countries = paises;
				
				if(cb) cb();
			});
		},

		update: function() {
			d3.json(plantiGraph.pathData + plantiGraph.act.prod + '.json' + plantiGraph.pathQuery, function(error, data){
			    
			    if (error) throw error;

			    	// si no hay paises los carga asyncronos
				if(!plantiGraph.data.countries) plantiGraph.tools.loadCountries(function(){ 
					
					plantiGraph.tools.processData(data);

					return;
				});

				for (var i = plantiGraph.data.countries.length - 1; i >= 0; i--) {
					plantiGraph.data.countries[i].x = plantiGraph.data.countries[i].posX;
					plantiGraph.data.countries[i].y = plantiGraph.data.countries[i].posY;
				}
				plantiGraph.tools.processData(data);

				plantiGraph.countryPop.update();

			});
		},

		getCountry(key) {
	    	for (var i = 0; i < plantiGraph.data.countries.length; i++) {
	    		if(plantiGraph.data.countries[i].key == key) return plantiGraph.data.countries[i]
	    	}
	    	return false;
	    },

		getdataCountry: function(country) {
			d3.json(plantiGraph.pathData + plantiGraph.act.prod + '.json' + plantiGraph.pathQuery, function(error, data){			    
			    if (error) throw error;

			    var dataCountry = {
			    	actCountry: null,
			    	expByYear: [],
			    	impByYear: [],
			    };
			    if(plantiGraph.act.type.length == 1) {

			    		// exportaciones
			    	if(plantiGraph.act.type.indexOf('exp') != -1) {
			    		var exprts = [];

						for(exp in data[plantiGraph.act.year][country]) {
							if(data[plantiGraph.act.year][country].hasOwnProperty(exp)) {
								exprts.push({
									key: exp,
									val: data[plantiGraph.act.year][country][exp]
								})
							}
						}
						
						exprts.sort(function(x, y){
							return d3.descending(x.val, y.val);
						});

						dataCountry.exports = fixArrTop(exprts.slice(0, 5));
			    	}

			    		// importaciones
			    	if(plantiGraph.act.type.indexOf('imp') != -1) {
			    		var imprts = [];

						for(imp in data[plantiGraph.act.year]) {
							if(data[plantiGraph.act.year].hasOwnProperty(imp)) {
								if(data[plantiGraph.act.year][imp][country])
									imprts.push({
										key: imp,
										val: data[plantiGraph.act.year][imp][country]
									})
							}
						}
						
						imprts.sort(function(x, y){
							return d3.descending(x.val, y.val);
						});

						dataCountry.imports = fixArrTop(imprts.slice(0, 5));

			    	}
			    }
			    	// apaña el array para formatearlo como los otroso tops
			    function fixArrTop (array) {
			    	var outp = [];
			    	for (var i = 0; i < array.length; i++) {
			    		outp.push({
			    			data: {
			    				name: plantiGraph.tools.getCountry(array[i].key).name,
			    				key: array[i].key,
			    				val: array[i].val
			    			},
			    			pos: i
			    		})
			    	}
			    	return outp;
			    }

			    for (var i = plantiGraph.data.countries.length - 1; i >= 0; i--) {
					if(plantiGraph.data.countries[i].key == country) dataCountry.actCountry = plantiGraph.data.countries[i];
				}
				if(!dataCountry.actCountry) throw 'No se encontró el pais activo';

			  	for(var year = plantiGraph.initYear; year <= plantiGraph.lastYear; year++) {

			  		dataCountry.expByYear[year] = 0
			  		dataCountry.impByYear[year] = 0

					for (var i = plantiGraph.data.countries.length - 1; i >= 0; i--) {
						if(plantiGraph.data.countries[i].key == country) {
							for (var k = plantiGraph.data.countries.length - 1; k >= 0; k--) { 
								if(data[year][country] && data[year][country][plantiGraph.data.countries[k].key]) dataCountry.impByYear[year] += data[year][country][plantiGraph.data.countries[k].key];
							}
						} else if (data[year][plantiGraph.data.countries[i].key] && data[year][plantiGraph.data.countries[i].key][country]) {
							dataCountry.expByYear[year] += data[year][plantiGraph.data.countries[i].key][country];
						}
					}

			  	}

			  	plantiGraph.countryPop.draw(dataCountry);

			});
		},

		getTop(country, type) {
			
			var top = [];
			var topCountries = type == 'imp' ? plantiGraph.data.yearTopImp : plantiGraph.data.yearTopExp;
			var found = false;

			for (var i = 0; i < plantiGraph.graphsElms; i++) {
				
				if(topCountries[i].key == country) {
					found = true;
				}

				top.push({
					data: topCountries[i],
					pos: i
				});

			}

			if(found) return top;

			for (var i = topCountries.length - 1; i >= 0; i--) {
				if(topCountries[i].key == country) {
					
					top.push({
						data: topCountries[i],
						pos: i
					});

					return top;
				}
			}

		},

		getFrases(dataCountry) {

			var name = dataCountry.actCountry.name;
			var out = [];

			if(plantiGraph.act.type.length == 2) {

				var balance = dataCountry.actCountry.totalExp - dataCountry.actCountry.totalImp;
				var positionImp = plantiGraph.tools.getPosition(dataCountry, 'imp');
				var positionExp = plantiGraph.tools.getPosition(dataCountry, 'exp');

				if(balance > 0) {
					out.push('<strong>' + name + '</strong> exportó <strong>' + plantiGraph.tools.parseAmmount(balance) + ' más</strong> en <strong>' + plantiGraph.txt.productos[plantiGraph.act.prod] + '</strong> de los que importó.');
				} else {
					out.push('<strong>' + name + '</strong> importó <strong>' + plantiGraph.tools.parseAmmount(-1 * balance) + ' más</strong> en <strong>' + plantiGraph.txt.productos[plantiGraph.act.prod] + '</strong> de los que exportó.');
				}
				out.push('<strong>' + name + '</strong> ocupa el puesto número <strong>' + positionExp + '</strong> de países exportadores y el puesto número <strong>' + positionImp + '</strong> de paises importadores de <strong>' + plantiGraph.txt.productos[plantiGraph.act.prod] + '</strong>.');


			} else if(plantiGraph.act.type.indexOf('imp') != -1) {

				var position = plantiGraph.tools.fixPosition(plantiGraph.tools.getPosition(dataCountry, 'imp'));
				var percent = 100 * dataCountry.actCountry.totalImp / plantiGraph.data.totalImp;
				var total = 100 * dataCountry.actCountry.totalImp / dataCountry.actCountry.resumen.imps[plantiGraph.act.year];

				out.push('<strong>' + name + '</strong> ocupa el <strong>' + position + ' puesto</strong> en el ranking de países importadores de <strong>' + plantiGraph.txt.productos[plantiGraph.act.prod] + '</strong>.');
				out.push('<strong>' + name + '</strong> controla el <strong>' + percent.toFixed(1).replace('.', ',') + '%</strong> de las importaciones mundiales de <strong>' + plantiGraph.txt.productos[plantiGraph.act.prod] + '</strong>.');
				out.push('<strong>' + firstCapital(plantiGraph.txt.articulos[plantiGraph.act.prod]) + '</strong> supone el ' + total.toFixed(1).replace('.', ',') + '% de las importaciones de <strong>' + name +  '</strong>, ' + plantiGraph.tools.parseAmmount(dataCountry.actCountry.totalImp) + '</strong>.');

			} else {

				var position = plantiGraph.tools.fixPosition(plantiGraph.tools.getPosition(dataCountry, 'exp'));
				var percent = 100 * dataCountry.actCountry.totalExp / plantiGraph.data.totalExp;
				var total = 100 * dataCountry.actCountry.totalExp / dataCountry.actCountry.resumen.exps[plantiGraph.act.year];

				out.push('<strong>' + name + '</strong> ocupa el <strong>' + position + ' puesto</strong> en el ranking de países exportadores de <strong>' + plantiGraph.txt.productos[plantiGraph.act.prod] + '</strong>.');
				out.push('<strong>' + name + '</strong> controla el <strong>' + percent.toFixed(1).replace('.', ',') + '%</strong> de las exportaciones mundiales de <strong>' + plantiGraph.txt.productos[plantiGraph.act.prod] + '</strong>.');
				out.push('<strong>' + firstCapital(plantiGraph.txt.articulos[plantiGraph.act.prod]) + '</strong> supone el ' + total.toFixed(1).replace('.', ',') + '% de las exportaciones de <strong>' + name +  '</strong>, ' + plantiGraph.tools.parseAmmount(dataCountry.actCountry.totalExp) + '.');
			}

			return out;
		},

		parseAmmount(ammout) {
			if(ammout / 1000000 > 1) {
				return numberThousandsDots(Math.round(ammout / 1000000)) + ' millones de dólares';
			} else {
				return numberThousandsDots(ammout) + ' dólares';
			}
		},

		fixPosition (number) {
			switch(number){
				case 1: return 'primer'; break;
				case 2: return 'segundo'; break;
				case 3: return 'tercer'; break;
				default: return number + 'º'; break;
			}
		},

		getPosition(dataCountry, type) {
			if(type == 'imp') {
				for (var i = plantiGraph.data.yearTopImp.length - 1; i >= 0; i--) {
					if(plantiGraph.data.yearTopImp[i].key == dataCountry.actCountry.key) return i + 1;
				}
			} else {
				for (var i = plantiGraph.data.yearTopExp.length - 1; i >= 0; i--) {
					if(plantiGraph.data.yearTopExp[i].key == dataCountry.actCountry.key) return i + 1;
				}
			} 
			return null;
		},

		processData: function(data) {

			var countries = plantiGraph.data.countries; // alias
			var actData = data[plantiGraph.act.year];

			var links = [];
			var linksAll = [];
			var tops = {
				exp: [],
				imp: []
			}

			for (var i = countries.length - 1; i >= 0; i--) {
				countries[i].totalImp = 0;
				countries[i].totalExp = 0;
			}


			var imps = [];

			var max = 0;

			for (var i = countries.length - 1; i >= 0; i--) {
				if(actData[countries[i].key]) {

								// suma exportaciones
					for (var j = countries.length - 1; j >= 0; j--) {
						if(actData[countries[i].key][countries[j].key]) {

							var val = actData[countries[i].key][countries[j].key];

							countries[i].totalExp += val;
							countries[j].totalImp += val;

							imps.push(val);

							if(val > max) max = val;

							linksAll.push({
								source: countries[i],
								target: countries[j],
								val: val
							});

						}

					}

				}
			}

			for (var i = 0; i < linksAll.length; i++) {
				if(linksAll[i].val > max / 1000) links.push(linksAll[i]);
			}
			
			plantiGraph.data.totalExp = 0;
			plantiGraph.data.totalImp = 0;

			for (var i = countries.length - 1; i >= 0; i--) {

				plantiGraph.data.totalExp += countries[i].totalExp;
				plantiGraph.data.totalImp += countries[i].totalImp;

				tops.imp.push({
					key: countries[i].key,
					val: countries[i].totalImp,
					name: countries[i].name
				});

				tops.exp.push({
					key: countries[i].key,
					val: countries[i].totalExp,
					name: countries[i].name
				});
			}

			var maxImp = [];
			var maxExp = [];
			var maxImpExp = [];

			for (var i = countries.length - 1; i >= 0; i--) {
				if(countries[i].totalImp > 0) maxImp.push(countries[i].totalImp);
				if(countries[i].totalExp > 0) maxExp.push(countries[i].totalExp);
				if((countries[i].totalImp + countries[i].totalExp) > 0) maxImpExp.push(countries[i].totalImp + countries[i].totalExp);
			}

			plantiGraph.data.yearTopExp = tops.exp.sort(function(x, y){
				return d3.descending(x.val, y.val);
			})

			plantiGraph.data.yearTopImp = tops.imp.sort(function(x, y){
				return d3.descending(x.val, y.val);
			})

			plantiGraph.data.yearTopImp


			// console.log(maxImp, d3.max(maxImp), maxExp, d3.max(maxExp), maxImpExp, d3.max(maxImpExp), imps, d3.max(imps), countries, links);


				// scalas lineales
			// plantiGraph.viz.scale.circImp = 
			// 	d3.scaleLinear().domain([0,d3.max(maxImp)]).range([0,plantiGraph.maxCirc]);
			// plantiGraph.viz.scale.circExp = 
			// 	d3.scaleLinear().domain([0,d3.max(maxExp)]).range([0,plantiGraph.maxCirc]);
			// plantiGraph.viz.scale.circImpExp = 
			// 	d3.scaleLinear().domain([0,d3.max(maxImpExp)]).range([0,plantiGraph.maxCirc]);
			// plantiGraph.viz.scale.lines = 
			// 	d3.scaleLinear().domain([0,d3.max(imps)]).range([0,plantiGraph.maxLine]);

			plantiGraph.viz.scale.circImp = 
				d3.scalePow().exponent(.5).domain([0,d3.max(maxImp)]).range([0,plantiGraph.maxCirc]);
			plantiGraph.viz.scale.circExp = 
				d3.scalePow().exponent(.5).domain([0,d3.max(maxExp)]).range([0,plantiGraph.maxCirc]);
			plantiGraph.viz.scale.circImpExp = 
				d3.scalePow().exponent(.5).domain([0,d3.max(maxImpExp)]).range([0,plantiGraph.maxCirc]);
			plantiGraph.viz.scale.lines = 
				d3.scalePow().exponent(.9).domain([0,d3.max(imps)]).range([0,plantiGraph.maxLine]);

			for (var i = countries.length - 1; i >= 0; i--) {
				countries[i].rTot = plantiGraph.viz.scale.circImpExp(countries[i].totalImp + countries[i].totalExp);
				countries[i].rTotImp = plantiGraph.viz.scale.circImpExp(countries[i].totalImp);
				countries[i].rTotExp = plantiGraph.viz.scale.circImpExp(countries[i].totalExp);
				countries[i].rImp = plantiGraph.viz.scale.circImp(countries[i].totalImp);
				countries[i].rExp = plantiGraph.viz.scale.circExp(countries[i].totalExp);
			}

				// iniciación inicial de círculos y textos
			if(!plantiGraph.viz.circsImp) {

				plantiGraph.viz.links = plantiGraph.viz.svg
					.append('g').attr('class', 'linksWrap')
						.selectAll('.link').data(links).enter()
						.append('line')
							.attr('class', plantiGraph.evs.linksClass)
							.attr('stroke-width', function(d){ return plantiGraph.viz.scale.lines(d.val); })
							.on("mouseenter", plantiGraph.evs.linksEnter)
							.on("mouseout", plantiGraph.evs.circOut)

				plantiGraph.viz.circExp = plantiGraph.viz.svg
					.append('g').attr('class', 'circExpWrap')
						.selectAll('.circExp').data(countries).enter()
						.append('circle')
							.attr('class', 'circExp')
							.on("mouseenter", plantiGraph.evs.circExpEnter)
							.on("mousedown", plantiGraph.evs.circClick)
							.on("mouseout", plantiGraph.evs.circOut);

				plantiGraph.viz.circsImp = plantiGraph.viz.svg
					.append('g').attr('class', 'circImpWrap')
						.selectAll('.circImp').data(countries).enter()
						.append('circle')
							.attr('class', 'circImp')
							.on("mouseenter", plantiGraph.evs.circInEnter)
							.on("mousedown", plantiGraph.evs.circClick)
							.on("mouseout", plantiGraph.evs.circOut);

				plantiGraph.viz.texts = plantiGraph.viz.svg
					.append('g').attr('class', 'textsWrap')
						.selectAll('.text').data(countries).enter()
						.append('text')
							.attr('class', 'text')
							.text(function(d){ return d.key.toUpperCase(); });
			} else {

					// cargándonos las líenas cada vez
				plantiGraph.viz.links.remove();
				plantiGraph.viz.links = plantiGraph.viz.svg
					.select('.linksWrap')
						.selectAll('.link').data(links).enter()
						.append('line')
							.attr('class', plantiGraph.evs.linksClass)
							.attr('stroke-width', function(d){ return plantiGraph.viz.scale.lines(d.val); })
							.on("mouseenter", plantiGraph.evs.linksEnter)
							.on("mouseout", plantiGraph.evs.circOut)
			}

				// actualización de líneas
			plantiGraph.viz.links.data(links)
				.attr('stroke-width', function(d){ return plantiGraph.viz.scale.lines(d.val); })
				.attr('class', plantiGraph.evs.linksClass)
				.attr("visibility", plantiGraph.evs.linksVisibilityCheck)
  				.attr('opacity', 0)
  				.transition().duration(500).attr('opacity', 1);

				// actualización de círculos y textos
			plantiGraph.viz.circsImp.data(countries)
				.attr("visibility", plantiGraph.evs.circImpVisibilityCheck)
				.attr('r', plantiGraph.evs.circImpRadius)
				.attr('cx', function(d) { if(d.posX) return d.x; })
				.attr('cy', function(d) { if(d.posY) return d.y; });

			plantiGraph.viz.circExp.data(countries)
				.attr("visibility", plantiGraph.evs.circExpVisibilityCheck)
				.attr('r', plantiGraph.evs.circExpRadius)
				.attr('cx', function(d) { if(d.posX) return d.x; })
				.attr('cy', function(d) { if(d.posY) return d.y; });

			plantiGraph.viz.texts.data(countries)
				.attr("visibility", plantiGraph.evs.textVisibilityCheck)
				.attr('x', function(d) { if(d.posX) return d.x; })
				.attr('y', function(d) { if(d.posY) return d.y + (plantiGraph.breakPointSmallScreen ? 3 : 5); });

			plantiGraph.viz.force = d3.forceSimulation(countries)
				.force("link", d3.forceLink(links).strength(0.0000000000001))
				// .force("charge", d3.forceManyBody().strength(0.01))
    			.force("collide", d3.forceCollide().radius(plantiGraph.evs.collideRadiusFn).iterations(6).strength(1.2))
				// .force("link", d3.forceLink(links).strength(function(d){return d.val / 1000 }).distance(20))
				// .force("center", d3.forceCenter(plantiGraph.viz.width / 2, plantiGraph.viz.height / 2))

				.alphaDecay(plantiGraph.breakPointSmallScreen ? 0.8 : .6)
				.velocityDecay(.7)

				.on('tick', plantiGraph.tools.tick)
				.restart();

		},

			// each forze loop
		tick: function() {console.log('tick')

			plantiGraph.viz.circsImp
				.attr('cx', function(d) { return d.x; })
				.attr('cy', function(d) { return d.y; });

			plantiGraph.viz.circExp
				.attr('cx', function(d) { return d.x; })
				.attr('cy', function(d) { return d.y; });

			plantiGraph.viz.links
				.attr('x1', function(d) { return d.source.x; })
				.attr('x2', function(d) { return d.target.x; })
				.attr('y1', function(d) { return d.source.y; })
				.attr('y2', function(d) { return d.target.y; })
				.attr('class', plantiGraph.evs.linksClass)
				.attr("visibility", plantiGraph.evs.linksVisibilityCheck);

			plantiGraph.viz.texts
				.attr('x', function(d) { return d.x; })
				.attr('y', function(d) { return d.y + (plantiGraph.breakPointSmallScreen ? plantiGraph.textYOffset : plantiGraph.textYOffset); });
			
		},

		initJqueries: function() {

			$('#years')
				.find('.gotoYear').click(plantiGraph.evs.changeYear).end()
				.find('.nextYear').click(plantiGraph.evs.nextYear).end()
				.find('.prevYear').click(plantiGraph.evs.prevYear);

			$('#prods a').click(plantiGraph.evs.changeProduct);

			$('#type a').click(plantiGraph.evs.changeType);

			// $('#years a[data-year=' +  plantiGraph.act.year + ']').addClass('act');

			$('#activeYear').html(plantiGraph.act.year);
			$('#prods a[data-prod=' +  plantiGraph.act.prod + ']').addClass('act');

			$(plantiGraph.act.type).each(function(e, f){
				$('#type a[data-type=' +  f + ']').addClass('act');
			});

			$('body')
				.delegate('#frases li', 'click', function(){
					shareTweet($(this).text().slice(0, -1) + ' en ' + plantiGraph.act.year, 'http://www.eldiario.es/', 'pruebaHash', 'eldiarioes');
					return false;
				})
				.delegate('#searchSelected a', 'click', function(){
					plantiGraph.countryPop.hide();
					return false;
				})

		}
	},

	countryPop: {
		active: false,
		$elm: '#pop',
		$frases: '#frases',
		$graphLines: '#graphLines',
		$graphBars1: '#graphBars1',
		$graphBars2: '#graphBars2',

		init: function() {

			plantiGraph.countryPop.$elm = $(plantiGraph.countryPop.$elm);
			plantiGraph.countryPop.$frases = $(plantiGraph.countryPop.$frases);
			plantiGraph.countryPop.$graphLines = $(plantiGraph.countryPop.$graphLines).find('.inn');
			plantiGraph.countryPop.$graphBars1 = $(plantiGraph.countryPop.$graphBars1).find('.inn');
			plantiGraph.countryPop.$graphBars2 = $(plantiGraph.countryPop.$graphBars2).find('.inn');
			
			$('#closePop').click(plantiGraph.countryPop.hide);

				// clase genérica para mostrar popups
			plantiGraph.viz.$wrap
				.delegate('.activaCountry', 'click', function(e){
					e.preventDefault();

					var $elm = $(this);
					var target = $elm.data('country');

					if(!target) throw 'No se encontró el pais clickado';

					plantiGraph.countryPop.activa(target);
				})

					// clase genérica para mostrar popups
				.delegate('.activaYear', 'click', function(e){
					e.preventDefault();

					var $elm = $(this);
					var target = $elm.data('year');

					if(!target) throw 'No se encontró el año clickado';

					plantiGraph.evs.gotoYear(target);
				})
		},

		activa: function(countryKey) {
			
			plantiGraph.countryPop.clear();

			var countryData = plantiGraph.tools.getdataCountry(countryKey);
			
			plantiGraph.countryPop.active = countryKey;

			$('#searchHelp').hide();
			
			plantiGraph.viz.$wrap.addClass('actPop');

				// hasta aquí móvil
			if(plantiGraph.breakPointSmallScreen) return;

			setTimeout(function(){plantiGraph.countryPop.activaHover(countryKey); }, 100);

			d3.selectAll('feGaussianBlur').transition().attr('stdDeviation', 4);

		},

		activaHover: function(countryKey) {
			for (var i = 0; i < plantiGraph.data.countries.length; i++) {
				if (plantiGraph.data.countries[i].key == countryKey) {
					plantiGraph.evs.circsHover(plantiGraph.data.countries[i]);
					return;
				}
			};
		},	

		hide: function() {
			plantiGraph.countryPop.active = null;
			plantiGraph.viz.$wrap.removeClass('actPop');
			
			plantiGraph.countryPop.clear();

				// hasta aquí móvil
			if(plantiGraph.breakPointSmallScreen) return;

			d3.selectAll('feGaussianBlur').transition().attr('stdDeviation', 0);
			
			plantiGraph.evs.circOut();

		},

		clear: function() {

			plantiGraph.countryPop.active = null;

			plantiGraph.countryPop.$frases.find('*').remove();
			plantiGraph.countryPop.$graphBars2.find('*').remove();
			plantiGraph.countryPop.$graphBars1.find('*').remove();
			plantiGraph.countryPop.$graphLines.find('*').remove();
			plantiGraph.countryPop.$graphLines.append('<svg></svg>');

			$('#searchHelp').show();
			$('#searchSelected').hide().html('');

		},

		update: function() {
			if(plantiGraph.countryPop.active) plantiGraph.countryPop.activa(plantiGraph.countryPop.active);
		},
		

		draw: function(data) {

		  	var frases = plantiGraph.tools.getFrases(data);
		  	$.each(frases, function(e, f){
		  		plantiGraph.countryPop.$frases.append($('<li>' + f + '<i class="fa fa-twitter" aria-hidden="true"></i></li>'));
		  	});

			$('#searchSelected').show().html('<a href="#" class="clearPop">' + data.actCountry.name + '</a>');

				// en móvil, hasta aquí
		  	if(plantiGraph.breakPointSmallScreen) return;

		  		// Grafiquitas
		  		// esta siempre:
			plantiGraph.countryPop.drawEvol(plantiGraph.countryPop.$graphLines, data);

		  		// Las de barras cambian según lo activado
		  	if(plantiGraph.act.type.length == 2) {

		  		plantiGraph.countryPop.drawBarras(plantiGraph.tools.getTop(data.actCountry.key, 'exp'), data, plantiGraph.countryPop.$graphBars1, 'exp');
		  		plantiGraph.countryPop.drawBarras(plantiGraph.tools.getTop(data.actCountry.key, 'imp'), data, plantiGraph.countryPop.$graphBars2, 'imp');

		  	} else if($.inArray('imp', plantiGraph.act.type) == -1) {

		  		plantiGraph.countryPop.drawBarras(plantiGraph.tools.getTop(data.actCountry.key, 'exp'), data, plantiGraph.countryPop.$graphBars1, 'exp');
		  		plantiGraph.countryPop.drawBarras(data.exports, data, plantiGraph.countryPop.$graphBars2, 'expInternal');

		  	} else {
				
				plantiGraph.countryPop.drawBarras(plantiGraph.tools.getTop(data.actCountry.key, 'imp'), data, plantiGraph.countryPop.$graphBars1, 'imp');
		  		plantiGraph.countryPop.drawBarras(data.imports, data, plantiGraph.countryPop.$graphBars2, 'impInternal');
		  	}
	

		},

		drawBarras: function(top, data, $elm, type) {

			switch(type) {
				case 'exp':
					$elm.addClass('graphBarsExp')
						.append('<h4 style="text-transform: uppercase">Ranking de países <br>exportadores</h4><p style="margin-bottom: 0.8em">En millones de dolares</p>');
				break;
				case 'imp':
					$elm.addClass('graphBarsImp')
						.append('<h4 style="text-transform: uppercase">Ranking de países <br>importadores</h4><p style="margin-bottom: 0.8em">En millones de dolares</p>');
				break;
				case 'expInternal':
					$elm.addClass('graphBarsImp')
						.append('<h4 style="text-transform: uppercase">Principales paises<br>a los que exporta</h4><p style="margin-bottom: 0.8em">En millones de dolares</p>');
				break;
				case 'impInternal':
					$elm.addClass('graphBarsImp')
						.append('<h4 style="text-transform: uppercase">Principales paises<br>de los que importa</h4><p style="margin-bottom: 0.8em">En millones de dolares</p>');
				break;
			}

		  	var max = d3.max(top, function(e){ return e.data.val; });

		  	$.each(top, function(e, f){
		  		
		  		if(e == plantiGraph.graphsElms) plantiGraph.countryPop.$graphBars1.append('<li>....</li>');
		  		
		  		var $bar = null;
		  		if(type == 'exp' || type == 'imp') {
		  			$bar = $('<li><a data-toggle="tooltip" href="#" class="activaCountry' + (f.data.key == data.actCountry.key ? ' activeBar' : '' ) +'" data-country="' + f.data.key + '"><span class="key">' + f.data.key + '</span><div class="bar" title="' + f.data.name + ((type == 'imp') ? ' importó ' : ' exportó ') + plantiGraph.tools.parseAmmount(f.data.val) + ' de ' + plantiGraph.txt.productos[plantiGraph.act.prod] + ' en ' + plantiGraph.act.year + '" data-width=""><span class="text">' + millionsParser(f.data.val) + '</span></div></a></li>');
		  		} else {
		  			$bar = $('<li><a data-toggle="tooltip" href="#" class="activaCountry' + (f.data.key == data.actCountry.key ? ' activeBar' : '' ) +'" data-country="' + f.data.key + '"><span class="key">' + f.data.key + '</span><div class="bar" title="' + data.actCountry.name + ((type == 'impInternal') ? ' importó ' : ' exportó ') + plantiGraph.tools.parseAmmount(f.data.val) + ' de ' + plantiGraph.txt.productos[plantiGraph.act.prod] + ((type == 'impInternal') ? ' de ' : ' a ') + f.data.name + ' en ' + plantiGraph.act.year + '" data-width=""><span class="text">' + millionsParser(f.data.val) + '</span></div></a></li>');	
		  		}
		  		
		  		$elm.append($bar);

		  		var val = f.data.val * 100 / max;

		  		$bar.find('.bar').tooltip();
		  		$bar.find('.bar').stop(false, false).css('width', 0).animate({'width': val}, 1000);
		  		if(val < 40) $bar.find('.bar').addClass('bar-left');

		  	});
		},


	  	drawEvol: function($elm, data) {
	  		
		  		// gráfico de evolucion
		  	$elm.prepend('<h4 style="text-transform: uppercase">Evolución importaciones y exportaciones de ' + plantiGraph.txt.productos[plantiGraph.act.prod] + '</h4><p style="margin-bottom: 0.8em">En millones de dolares</p>');

		  	var max = d3.max([
		  		d3.max(d3.entries(data.expByYear), function(e){ return parseInt(e.value); }),
		  		d3.max(d3.entries(data.impByYear), function(e){ return parseInt(e.value); })
		  	]);

		  	var padding = 30;
		  	var paddingV = 5;

		  	var width = 210;
		  	var height = width * 0.6;
		  	var scale = d3
		  		.scaleLinear()
		  		.domain([0, max])
		  		.range([height, 0]);
		  	
		  	var axis = d3
		  		.axisLeft(scale)
		  			.ticks(4)
		  			.tickSize(0)
		  			.tickFormat(function(d) { return parseInt(d / 1000000);});

		  	var years = plantiGraph.lastYear - plantiGraph.initYear;
		  	var jump = (width - padding) / years;

		  	var tmpPath = 'M' + padding + ' ' + (height + paddingV) + ' L';
		  	var tmpPathLine = 'M';
		  	var finalImpPath = 'M' + padding + ' ' + (height + paddingV) + ' L';
		  	var finalImpLine = 'M';
		  	var finalExpPath = 'M' + padding + ' ' + (height + paddingV) + ' L';
		  	var finalExpLine = 'M';

		  	var graph = d3.select($elm.find('svg')[0])
  				.attr('width', width + 3).attr('height', height + (2 * paddingV));

		  	graph.append('g')
		  		.attr('transform', 'translate(' + (padding - 5) + ' ,' + paddingV + ')')
		  		.attr('class', 'axes')
		  		.call(axis);

  			var lines = graph.append('g').attr('class', 'lines');
  			var dots = graph.append('g').attr('class', 'dots');

		  	for (var i = 0; i <= years; i++) {
		  		
		  		var Px = padding + (jump * i);
		  		var PyExp = paddingV + scale(data.expByYear[plantiGraph.initYear + i]);
		  		var PyImp = paddingV + scale(data.impByYear[plantiGraph.initYear + i]);

		  		tmpPath += Px + ' ' + (height + paddingV) + ' L';
		  		tmpPathLine += Px + ' ' + (height + paddingV) + ' L';
		  		finalImpPath += Px + ' ' + PyImp + ' L';
		  		finalImpLine += Px + ' ' + PyImp + ' L';
		  		finalExpPath += Px + ' ' + PyExp + ' L';
		  		finalExpLine += Px + ' ' + PyExp + ' L';

		  		dots.append('circle')
		  			.attr('class', 'circLinesWhite')
		  			.attr('cx', Px)
		  			.attr('cy', PyExp)
		  			.attr('r', 4)
	  				.attr('opacity', 0)
	  				.transition().duration(2000).attr('opacity', 1);

		  		dots.append('circle')
		  			.on("mouseenter", plantiGraph.evs.circGraphTooltip)
		  			.on("mouseout", plantiGraph.evs.circGraphTooltipOut)
		  			.attr('class', 'circLines linesExp activaYear' + (plantiGraph.initYear + i == plantiGraph.act.year ? ' linesExpFill' : '') )
		  			.attr('data-year', plantiGraph.initYear + i)
		  			.attr('cx', Px)
		  			.attr('cy', PyExp)
		  			.attr('r', 3)
	  				.attr('stroke', '#126567')
	  				.attr('title', data.actCountry.name + ' importó ' + plantiGraph.tools.parseAmmount(data.expByYear[plantiGraph.initYear + i]) + ' de ' + plantiGraph.txt.productos[plantiGraph.act.prod] + ' en ' + (plantiGraph.initYear + i) + '.')
	  				.attr('opacity', 0)
	  				.transition().duration(2000).attr('opacity', 1);

		  		dots.append('circle')
		  			.attr('class', 'circLinesWhite')
		  			.attr('cx', Px)
		  			.attr('cy', PyImp)
		  			.attr('r', 4)
	  				.attr('opacity', 0)
	  				.transition().duration(2000).attr('opacity', 1);

		  		dots.append('circle')
		  			.on("mouseenter", plantiGraph.evs.circGraphTooltip)
		  			.on("mouseout", plantiGraph.evs.circGraphTooltipOut)
		  			.attr('class', 'circLines linesImp activaYear' + (plantiGraph.initYear + i == plantiGraph.act.year ? ' linesImpFill' : ''))
		  			.attr('data-year', plantiGraph.initYear + i)
		  			.attr('cx', Px)
		  			.attr('cy', PyImp)
		  			.attr('r', 3)
	  				.attr('title', data.actCountry.name + ' exportó ' + plantiGraph.tools.parseAmmount(data.impByYear[plantiGraph.initYear + i]) + ' de ' + plantiGraph.txt.productos[plantiGraph.act.prod] + ' en ' + (plantiGraph.initYear + i) + '.')
	  				.attr('opacity', 0)
	  				.transition().duration(2000).attr('opacity', 1);
		  	};

		  	tmpPath += (padding + width) + ' ' + (height + paddingV) + ' L' +  padding + ' 0 Z';
		  	finalImpPath += (padding + width) + ' ' + (height + paddingV) + ' Z';
		  	finalExpPath += (padding + width) + ' ' + (height + paddingV) + ' Z';

	  		lines.append('path')
	  				.attr('d', tmpPath)
	  				.attr('stroke', 'none')
	  				.attr('fill', 'rgba(211, 93, 51, 0.1)')
			  			.transition().duration(1000)
			  				.attr('d', finalImpPath);

	  		lines.append('path')
	  				.attr('d', tmpPath)
	  				.attr('stroke', 'none')
	  				.attr('fill', 'rgba(150, 203, 81, 0.1)')
			  			.transition().duration(1000)
			  				.attr('d', finalExpPath);

	  		lines.append('path')
	  				.attr('d', tmpPathLine.slice(0, -1))
	  				.attr('stroke', 'rgb(211, 93, 51)')
	  				.attr('stroke-width', '1')
	  				.attr('fill', 'none')
			  			.transition().duration(1000)
			  				.attr('d', finalImpLine.slice(0, -1));

	  		lines.append('path')
	  				.attr('d', tmpPathLine.slice(0, -1))
	  				.attr('stroke', '#126567')
	  				.attr('stroke-width', '1')
	  				.attr('fill', 'none')
			  			.transition().duration(1000)
			  				.attr('d', finalExpLine.slice(0, -1));
		},
	},

	evs: { // plantiGraph.evs.circInEnter

		circGraphTooltipOut: function() {
			$('#pop .tooltip').remove();
		},

		circGraphTooltip: function(e, f) {

			var $this = $(this);
			var $wrap = $('#pop');
			var posX = $this.offset().left - $wrap.offset().left;
			var posY = $wrap.height() - ($this.offset().top - $wrap.offset().top);
			
			var $tooltip = $('<div class="tooltip top" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner">' + $this.attr('title') + '</div></div>')
			
			$tooltip.css({ bottom: posY, left: posX - 98})
			$wrap.append($tooltip);
			$tooltip.animate({opacity: 1}, 400);

		},

		circTooltip: function(d) {

			var posY = d.y;
			var posX = d.x - 100;
			var textoTT = '';
			
			if(plantiGraph.act.type.length == 2) {
				textoTT = '<strong>' + d.name + '</strong> exportó ' + plantiGraph.tools.parseAmmount(d.totalExp) + ' e importó ' + plantiGraph.tools.parseAmmount(d.totalImp) + ' de <strong>' + plantiGraph.txt.productos[plantiGraph.act.prod] + '</strong> en ' + plantiGraph.act.year;
				posY -= (d.rTot + 4);
			} else {
				if(plantiGraph.act.type.indexOf('exp') != -1) {
					textoTT = '<strong>' + d.name + '</strong> exportó ' + plantiGraph.tools.parseAmmount(d.totalExp) + ' de <strong>' + plantiGraph.txt.productos[plantiGraph.act.prod] + '</strong> en ' + plantiGraph.act.year;
					posY -= (d.rExp + 4);
				} else {
					textoTT = '<strong>' + d.name + '</strong> importó ' + plantiGraph.tools.parseAmmount(d.totalImp) + ' de <strong>' + plantiGraph.txt.productos[plantiGraph.act.prod] + '</strong> en ' + plantiGraph.act.year;
					posY -= (d.rImp + 4);
				}
			}

			posY = $('#graph').height() - posY;
			
			var $tooltip = $('<div class="tooltip top" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner">' + textoTT + '</div></div>')

			$tooltip.css({ bottom: posY, left: posX, }).appendTo('#graph')
			$tooltip.animate({opacity: 1}, 400);


		},

		linksClass: function(d) {
			return (d.source.x > d.target.x ? 'link' : 'link link-left');
		},

		linksEnter: function(d) {

			if(plantiGraph.breakPointSmallScreen) return false;

			plantiGraph.evs.linesHover(d);
			plantiGraph.evs.linesTooltip(d);

		},

		linesHover: function(d) {
			$('#graph').addClass('hover');

			plantiGraph.viz.links
				.attr('class', function(e) {
					var base = e.source.x > e.target.x ? 'link' : 'link link-left';
					return e == d ? (base + ' linkAct') : base;
				})

			plantiGraph.viz.circExp
				.attr('class', function(e) {
					return (d.target == e || d.source == e) ? 'circExp circExpAct' : 'circExp';
				});

			plantiGraph.viz.circsImp
				.attr('class', function(e) {
					return (d.target == e || d.source == e) ? 'circImp circImpAct' : 'circImp';
				});

		},
		linesTooltip: function(d) {
				// links tooltip
			var posX = ((d.source.x + d.target.x) / 2) - 100;
			var posY = ((d.source.y + d.target.y) / 2) - 5;

			var textoTT = '<strong>' + d.source.name + '</strong> exportó ' + plantiGraph.tools.parseAmmount(d.val) +  ' de <strong>' + plantiGraph.txt.productos[plantiGraph.act.prod] + '</strong> a <strong>' + d.target.name + '</strong> en ' + plantiGraph.act.year;

			posY = $('#graph').height() - posY;
			
			var $tooltip = $('<div class="tooltip top" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner">' + textoTT + '</div></div>')
			
			$tooltip.css({ bottom: posY, left: posX, }).appendTo('#graph')
			$tooltip.animate({opacity: 1}, 400);

		},

		circsHover: function(d) {

			$('#graph').addClass('hover');

			plantiGraph.viz.circExp
				.attr('class', function(e) {
					
					if(e.key == d.key) return 'circExp circExpAct';
					
					var found = false;
					plantiGraph.viz.links.each(function(f){
						if((f.source.key == d.key && f.target.key == e.key) && (plantiGraph.viz.scale.lines(f.val) > plantiGraph.minLine)) found = true;
						if((f.source.key == e.key && f.target.key == d.key) && (plantiGraph.viz.scale.lines(f.val) > plantiGraph.minLine)) found = true;
					})
					return found ? 'circExp circExpAct' : 'circExp';
				});

			plantiGraph.viz.circsImp
				.attr('class', function(e) {
					
					if(e.key == d.key) return 'circImp circImpAct';

					var found = false;
					plantiGraph.viz.links.each(function(f){
						if((f.source.key == d.key && f.target.key == e.key) && (plantiGraph.viz.scale.lines(f.val) > plantiGraph.minLine)) found = true;
						if((f.source.key == e.key && f.target.key == d.key) && (plantiGraph.viz.scale.lines(f.val) > plantiGraph.minLine)) found = true;
					})
					return found ? 'circImp circImpAct' : 'circImp';
				});

			plantiGraph.viz.links
				.attr('class', function(e) {
					var base = e.source.x > e.target.x ? 'link' : 'link link-left';
					return (e.source.key == d.key || e.target.key == d.key) ? (base + ' linkAct') : base;
				})
		},

		circExpEnter: function(d) {

			$('#graph .tooltip').remove();

			if(plantiGraph.breakPointSmallScreen) return false;

			plantiGraph.evs.circsHover(d);
			plantiGraph.evs.circTooltip(d);

		},

		circInEnter: function(d) {
			if(plantiGraph.breakPointSmallScreen) return;
			
			plantiGraph.evs.circsHover(d);
			plantiGraph.evs.circTooltip(d);

		},

		circClick: function(d) {
			plantiGraph.countryPop.activa(d.key);
		},

		circOut: function(d){
			$('#graph .tooltip').remove();
			$('#graph').removeClass('hover');

			plantiGraph.viz.links
				.attr('class', plantiGraph.evs.linksClass);

			plantiGraph.viz.circExp
				.attr('class', 'circExp');
			plantiGraph.viz.circsImp
				.attr('class', 'circImp');
		},

		linksVisibilityCheck: function (d) {
			if(d.source.name && !d.source.posX) return "hidden";
			if(d.source.name && !d.target.posX) return "hidden";
			if(plantiGraph.act.type.length != 2) return "hidden";
	    	return (plantiGraph.viz.scale.lines(d.val) < plantiGraph.minLine) ? "hidden" : "visible";
	  	},

		textVisibilityCheck: function(d) {
			if(!d.posX) return "hidden";
			if(plantiGraph.act.type.length == 2) {
				return d.rTot < (plantiGraph.breakPointSmallScreen ? plantiGraph.maxWidthTextMovil : plantiGraph.maxWidthText) ? "hidden" : "visible";
			} else {
				if($.inArray('imp', plantiGraph.act.type) == -1) return d.rExp < (plantiGraph.breakPointSmallScreen ? plantiGraph.maxWidthTextMovil : plantiGraph.maxWidthText) ? "hidden" : "visible";
				return d.rImp < (plantiGraph.breakPointSmallScreen ? plantiGraph.maxWidthTextMovil : plantiGraph.maxWidthText) ? "hidden" : "visible";
			}
		},

		circImpVisibilityCheck: function(d) {
			if(!d.posX) return "hidden";
			if($.inArray('imp', plantiGraph.act.type) == -1) return "hidden";
	    	return (d.rImp < plantiGraph.minCirc) ? "hidden" : "visible";
		},

		circImpRadius: function(d) {
			if(!d.posX) return 0;
			if($.inArray('imp', plantiGraph.act.type) == -1) return 0;
			if(plantiGraph.act.type.length == 2) return d.rTotImp;
			else return d.rImp;
		},

		circExpVisibilityCheck: function(d) {
			if(!d.posX) return "hidden";
			if($.inArray('exp', plantiGraph.act.type) == -1) return "hidden";
	    	return (($.inArray('imp', plantiGraph.act.type) == -1 ? d.rExp : d.rTot) < plantiGraph.minCirc) ? "hidden" : "visible";
		},

		circExpRadius: function(d) {
			if(!d.posX) return 0;
			if($.inArray('exp', plantiGraph.act.type) == -1) return 0;
			return ($.inArray('imp', plantiGraph.act.type) == -1) ? d.rExp : d.rTot;
		},

		collideRadiusFn: function(d) {
			var param = d.rTot
			if(plantiGraph.act.type.length != 2) {
				param = $.inArray('imp', plantiGraph.act.type) == -1 ? d.rExp : d.rImp;
			}
			return param + 5;
		},

		changeProduct: function(e) {
			
			e.preventDefault();
			
			$('#prods .act').removeClass('act');

			var prod = $(this).addClass('act').data('prod');
			if(!prod || plantiGraph.act.prod == prod) { console.log('no hay producto'); return; };

			plantiGraph.act.prod = prod;

				// carga datos nuevos y pinta
			plantiGraph.tools.update();
		},

		gotoYear: function(year) {

			if(!year || plantiGraph.act.year == year || year > plantiGraph.lastYear || year < plantiGraph.initYear) return;

			plantiGraph.act.year = year;
			
			$('#years .act').removeClass('act');
			$('#years .disabled').removeClass('disabled');
			$('#years [data-year="' + year + '"]').addClass('act');

			if(year == plantiGraph.lastYear) $('#years .nextYear').addClass('disabled');
			if(year == plantiGraph.initYear) $('#years .prevYear').addClass('disabled');

			$('#activeYear').html(year);

				// actualiza el dibujo
			plantiGraph.tools.update();
		},

		changeYear: function(e) {
			
			e.preventDefault();

			plantiGraph.evs.gotoYear($(this).data('year'));
		},

		prevYear: function(e) {
			
			e.preventDefault();

			if(plantiGraph.act.year == plantiGraph.initYear) return;

			plantiGraph.evs.gotoYear(plantiGraph.act.year - 1);

		},

		nextYear: function(e) {
			
			e.preventDefault();

			if(plantiGraph.act.year == plantiGraph.lastYear) return;

			plantiGraph.evs.gotoYear(plantiGraph.act.year + 1);
		},

		changeType: function(e) {
			
			e.preventDefault();

			var $this = $(this);
			var type = $this.data('type');

			if($.inArray(type, plantiGraph.act.type) == -1){
					
				$this.addClass('act');
				plantiGraph.act.type.push(type);

			} else {

				if(plantiGraph.act.type.length == 1) {
					plantiGraph.act.type = ['imp', 'exp'];
					
					$('#type a').addClass('act');

				} else {
					plantiGraph.act.type = [type];
					
					$('#type a.act').removeClass('act');
					
					$this.addClass('act');

				}
			}

				// actualiza el dibujo
			plantiGraph.tools.update();

		}
	},

};

plantiGraph.init();

function throttle (callback, limit) {   // http://sampsonblog.com/749/simple-throttle-function modificado!
    var wait = false;                 // Initially, we're not waiting
    return function () {              // We return a throttled function
        if (!wait) {                  // If we're not waiting
                                       // Execute users function
            wait = true;              // Prevent future invocations
            setTimeout(function () {  // After a period of time
                callback.call();
                wait = false;         // And allow future invocations
            }, limit);
        }
    }
}

function numberThousandsDots (number) {
 	return number.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1.");
};

function firstCapital(string) {
	return string.charAt(0).toUpperCase() + string.slice(1);
};

function millionsParser (ammount) {
	var data = ammount / 1000000;
	if(data > 1) return numberThousandsDots(parseInt(data));
	return data.toFixed(2).replace('.', ',');
}


function shareTweet (texto, url, hash, via) {
    if(!texto) return false;

    var windowOptions = 'scrollbars=yes,resizable=yes,toolbar=no,location=yes',
        width = 550,
        height = 420,
        winHeight = screen.height,
        winWidth = screen.width;

    var left = Math.round((winWidth / 2) - (width / 2));
    var top = 0;

    if (winHeight > height) {
      top = Math.round((winHeight / 2) - (height / 2));
    }

    var target = 'https://twitter.com/intent/tweet?text=' + encodeURIComponent(texto)
    if(url && url != false) {
    	target += '&url=' + clearUrl(url);
    } else if (url != false) { target += '&url=' + encodeURIComponent(window.location.href); }
    
    if(hash) target += '&hashtags=' + encodeURIComponent(hash);
    if(via) target += '&via=' + encodeURIComponent(via);

    window.open(target, 'intent', windowOptions + ',width=' + width +
                                       ',height=' + height + ',left=' + left + ',top=' + top);

    function clearUrl(url) {
    	if(url.indexOf('#') != -1) url = url.substring(0, url.indexOf('#'));
    	if(url.indexOf('?') != -1) url = url.substring(0, url.indexOf('?'));
    	return url;
    }
};

</script>
</body>
</html>