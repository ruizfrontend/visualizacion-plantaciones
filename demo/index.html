<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="http://estaticos.lab.eldiario.es/libs/bootstrap.cerulean.3.3.5.min.css">
	
	<title>TITEL - eldiario.es</title>
	<meta name="description" content="DESC">
	<meta name="keywords" content="KEYWS">
	<meta charset="utf-8">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta http-equiv="Content-Language" content="es-es">

	<meta property="og:title" content="TTTIEL">
	<meta property="og:description" content="DESC">
	<meta property="og:url" content="URL">
	<meta property="og:site_name" content="TTTIEL" />

	<meta name="twitter:image:src" content="JPG">
	<meta property="og:image" content="JPG">

	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:site" content="@eldiarioes">
	<meta name="twitter:creator" content="@eldiarioes">
	<meta name="twitter:title" content="TTTIEL">
	<meta name="twitter:description" content="DESC">

	<meta property="fb:app_id" content="417471918268686">

	<meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<style>
body { background: #ccc; }
#viz { background: white; }

.btn { background: #999999; color: white;
	padding: 0.2em 0.8em; border-radius: 0;}
.btn.act { background: #d35d33; color: white; }

#prods img { height: 25px; }
#prods svg path { -webkit-transform: scale(0.22); -ms-transform-origin: left top;
	-webkit-transform: scale(0.22); -ms-transform-origin: left top;
	transform: scale(0.22); transform-origin: left top; }
#prods span { display: none; }
	.anim #prods span { display: initial; padding-left: 0.6em; }

#typeImp.act { background: #126567; }
#typeExp.act { background: #d35d33; }

#years .disabled { cursor: inherit; color: #333; }

#head {  }
	/*#type .act, #prods .act, #years .act { color: red; }*/

	#texto { position: absolute; right: 0; top: 0; color: red; }
#graph { background: #efefef; }

	.link {  fill: none; stroke: rgba(0,0,0,0.4); }
		.link:hover, .link-act { stroke: rgba(60, 4, 4, 0.6); }
		.anim .link { -webkit-transition: stroke .5s; -ms-transition: stroke .5s; transition: stroke .5s; }

	.circImp { fill: #126567; cursor: pointer; }
		.anim .circImp {  -webkit-transform-origin: center center; -ms-transform-origin: center center; transform-origin: center center;
				-webkit-transition: all .5s; -ms-transition: all .5s; transition: all .5s; }
		.anim .circImp:hover { /*fill: rgba(6, 3, 68, 0.4);*/
		  		-webkit-transform: -ms-scale(1.1); transform: scale(1.1); transform: scale(1.1); }

	.circExp { fill: #d35d33; cursor: pointer; }
		.anim .circExp {  -webkit-transform-origin: center center; -ms-transform-origin: center center; transform-origin: center center;
				-webkit-transition: all .5s; -ms-transition: all .5s; transition: all .5s; }
		.anim .circExp:hover { /*fill: rgba(6, 3, 68, 0.4);*/
				-webkit-transform: -ms-scale(1.1); transform: scale(1.1); transform: scale(1.1); }

	.text {  fill: white; font-weight: 900; font-family: arial, sans-serif; font-size: 12px; pointer-events: none; text-anchor: middle; }


	#pop { display: none; position: absolute; top: 82px; padding: 1em; right: 0; width: 100%; max-width: 500px; background: white; }

</style>
<body>

<h1>Comercio internacional</h1>

<div id="texto"></div>

<div id="type">
	<h2>¿Qué datos quieres mostrar?</h2>
	<p>Filtra por datos de exportación o importación</p>

	<a href="#" data-type="imp" id="typeImp" class="btn">Importaciones</a>
	<a href="#" data-type="exp" id="typeExp" class="btn">Exportaciones</a>
</div>
<div id="prods">
	<h2>¿Por qué producto quieres filtrar?</h2>
	<p>Selecciona una opción</p>

	<a href="#" data-prod="cacao" class="btn"><img src="./icons/chocolate.svg"><span>Cacao</span></a>
	<a href="#" data-prod="banana" class="btn"><img src="./icons/banana.svg"><span>Banana</span></a>
	<a href="#" data-prod="azucar" class="btn"><img src="./icons/sugar.svg"><span>Azucar</span></a>
	<a href="#" data-prod="aceite" class="btn"><img src="./icons/palm_oil.svg"><span>Aceite</span></a>
	<a href="#" data-prod="cafe" class="btn"><img src="./icons/coffee.svg"><span>Café</span></a>
</div>
<div id="years">
	<a href="#" class="prevYear btn"><</a>
	<a href="#" data-year="2004" class="gotoYear btn">2004</a>
	<a href="#" data-year="2005" class="gotoYear btn">2005</a>
	<a href="#" data-year="2006" class="gotoYear btn">2006</a>
	<a href="#" data-year="2007" class="gotoYear btn">2007</a>
	<a href="#" data-year="2008" class="gotoYear btn">2008</a>
	<a href="#" data-year="2009" class="gotoYear btn">2009</a>
	<a href="#" data-year="2010" class="gotoYear btn">2010</a>
	<a href="#" data-year="2011" class="gotoYear btn">2011</a>
	<a href="#" data-year="2012" class="gotoYear btn">2012</a>
	<a href="#" data-year="2013" class="gotoYear btn">2013</a>
	<a href="#" data-year="2014" class="gotoYear btn">2014</a>
	<a href="#" class="nextYear btn disabled">></a>
</div>


<input type="text" id="countryImput">
<select name="countrySelect" id="countrySelect">
	
</select>


<svg id="viz"></svg>

<div id="pop">
	<div id="closePop">Close</div>
	<div id="frases">
		
	</div>
	<div id="graphLines">
		
	</div>
	<div id="graphBars1">
		
	</div>
	<div id="graphBars2">
		
	</div>
</div>

<script src="http://estaticos.lab.eldiario.es/libs/jquery-1.10.2.min.js"></script>
<script type="text/javascript" src="http://estaticos.lab.eldiario.es/estaticos/libs/jquery.autocomplete.js"></script>
<script src="http://estaticos.lab.eldiario.es/libs/d3-4.7.1.min.js"></script>

<script>

var planta_graph = {

	pathData: './',
	pathPaises: './paisesTot.json',
	pathQuery: '?mls3',

	act:{
		year: 2014,
		prod: 'cafe',
		type: ['imp', 'exp'],
	},

	breakPoint: 400,

	maxCircProp: 20, // relation winWidth to maxCircProp
	maxCirc: null, // generated max circle size 
	maxLineProp: 100,
	maxLine: null,

	minLineProp: 4, // relation of max circ
	minLine: null,
	minCircProp: 10, // relation of max circ
	minCirc: null,

	graphsElms: 5,

	viz: {
		width: 0,
		height: 0,
		$elm: null,
		svg: null,
		projection: null,
		path: null,
		map: null,
		circImp: null,
		circExp: null,
		texts: null,
		force: null,
		scale: {
			circImp: null,
			circExp: null,
			circImpExp: null,
			lines: null,
		}
	},

	data: {
		countries: null, // datos reales
		
		yearTopExp: null, // calculo de tops del año activo
		yearTopImp: null,

		totalExp: null,
		totalImp: null,
	},
	txt: {
		articulos: {
			cafe: 'el cafe',
			aceite: 'el aceite',
			cacao: 'el cacao',
			banana: 'la banana',
			azucar: 'el azucar'
		}
	},

	init: function() {

		planta_graph.viz.$elm = $('#viz');
		planta_graph.viz.svg = d3.select('#viz');

		planta_graph.countryPop.init();
		
		// planta_graph.tools.loadCountries();

		planta_graph.tools.initJqueries();

		$(window).bind('orientationchange resize', throttle(planta_graph.tools.handleResize, 300));

		planta_graph.tools.handleResize();
	},

	tools: {

		handleResize: function() {
			planta_graph.tools.loadCountries();
			planta_graph.tools.updateProjection();
			planta_graph.tools.update();
			// planta_graph.tools.initBG();
		},

		updateProjection: function() {

		   	planta_graph.viz.width = $(window).width();
		   	planta_graph.viz.height = planta_graph.viz.width / 2;
			
			if(planta_graph.viz.width < planta_graph.breakPoint) {
				planta_graph.viz.height = planta_graph.viz.width / 1.4;
				$('body').removeClass('anim')
			} else {
				$('body').addClass('anim')
			}

		   	planta_graph.viz.$elm.css({
		   		width: planta_graph.viz.width,
		   		height: planta_graph.viz.height
		   	});

		   	planta_graph.viz.projection = d3.geoMercator()
		   		.scale(170 * (planta_graph.viz.width / 1000))
		   		.translate([(planta_graph.viz.width / 2) - (planta_graph.viz.width / 14), (planta_graph.viz.height / 2) + (planta_graph.viz.height / 5)])
				.precision(51);

			planta_graph.viz.path = d3.geoPath().projection(planta_graph.viz.projection);

			if(planta_graph.data.prod)
				for (var i = 0; i < planta_graph.data.prod.length; i++) {
					planta_graph.data.prod[i].x = planta_graph.viz.projection([planta_graph.data.prod[i].lon, planta_graph.data.prod[i].lat])[0];
					planta_graph.data.prod[i].y = planta_graph.viz.projection([planta_graph.data.prod[i].lon, planta_graph.data.prod[i].lat])[1];
				};

			planta_graph.maxCirc = parseInt(planta_graph.viz.width / planta_graph.maxCircProp);
			planta_graph.minCirc = Math.ceil(planta_graph.maxCirc / planta_graph.minCircProp);
			planta_graph.maxLine = parseInt(planta_graph.viz.width / planta_graph.maxLineProp);
			planta_graph.minLine = Math.ceil(planta_graph.maxLine / planta_graph.minLineProp);

		},
			// fondo de paises
		initBG: function() {

			d3.json("./world-50m.json", function(error, world) {
				if (error) throw error;

				var countries = topojson.feature(world, world.objects.countries).features;
				// var neighbors = topojson.neighbors(world.objects.countries.geometries);

				if(planta_graph.viz.map) planta_graph.viz.map.remove()

				planta_graph.viz.map = planta_graph.viz.svg.selectAll(".country")
					.data(countries)
					.enter()
						.insert("path", ".graticule")
							.attr('d', planta_graph.viz.path)
							.attr('class', "country")
							.style('stroke', '#ccc')
							.style('fill', 'none')
							.style('stroke-width', '1');

			});
		},

		loadCountries: function(cb) {

			d3.json(planta_graph.pathPaises, function(error, world) {
			  	
			  	if (error) throw error;

			  	var paises = [];
			  	var autoComplete = [];

			  	for (var key in world) {
				  if (world.hasOwnProperty(key)) {

				    var pais = world[key];

				    pais.key = key;
				    pais.posX = planta_graph.viz.projection([pais.lon, pais.lat])[0];
				    pais.posY = planta_graph.viz.projection([pais.lon, pais.lat])[1];
				    pais.x = pais.posX;
				    pais.y = pais.posY;

				    paises.push(pais);


				    autoComplete.push({
				    	value: pais.name,
				    	data: {
				    		id: pais.name,
				    		key: pais.key
				    	}
				    });


				    $('#countrySelect').append('<option value="' + pais.key + '">' + pais.name + '</option>')

				  }
				};
				
				$('#countryImput').autocomplete({
		          lookup: autoComplete,
		          minChars: 3,
		          orientation: 'bottom',
		          autoSelectFirst: true,
		          showNoSuggestionNotice: true,
		          noSuggestionNotice: 'No se encontraron coincidencias',
		          groupBy: 'p',
		          onSelect: function (suggestion) {
		            planta_graph.countryPop.activa(suggestion.data.key);
		          }
		        });

				planta_graph.data.countries = paises;
				
				if(cb) cb();
			});
		},

		update: function() {
			d3.json(planta_graph.pathData + planta_graph.act.prod + '.json' + planta_graph.pathQuery, function(error, data){
			    
			    if (error) throw error;

			    	// si no hay paises los carga asyncronos
				if(!planta_graph.data.countries) planta_graph.tools.loadCountries(function(){ 
					
					planta_graph.tools.processData(data);

					return;
				});

				planta_graph.tools.processData(data);

				planta_graph.countryPop.update();

			});
		},

		getdataCountry: function(country) {
			d3.json(planta_graph.pathData + planta_graph.act.prod + '.json' + planta_graph.pathQuery, function(error, data){			    
			    if (error) throw error;

			    var dataCountry = {
			    	actCountry: null,
			    	expByYear: [],
			    	impByYear: [],
			    };

			    for (var i = planta_graph.data.countries.length - 1; i >= 0; i--) {
					if(planta_graph.data.countries[i].key == country) dataCountry.actCountry = planta_graph.data.countries[i];
				}
				if(!dataCountry.actCountry) throw 'No se encontró el pais activo';

			  	for(var year = 2004; year <= 2014; year++) {

			  		dataCountry.expByYear[year] = 0
			  		dataCountry.impByYear[year] = 0

					for (var i = planta_graph.data.countries.length - 1; i >= 0; i--) {
						if(planta_graph.data.countries[i].key == country) {console.log(planta_graph.data.countries[i].key, country)
							for (var k = planta_graph.data.countries.length - 1; k >= 0; k--) { 
								if(data[year][country] && data[year][country][planta_graph.data.countries[k].key]) dataCountry.impByYear[year] += data[year][country][planta_graph.data.countries[k].key];
							}
						} else if (data[year][planta_graph.data.countries[i].key] && data[year][planta_graph.data.countries[i].key][country]) {
							dataCountry.expByYear[year] += data[year][planta_graph.data.countries[i].key][country];
						}
					}

			  	}

			  	planta_graph.countryPop.draw(dataCountry);

			});
		},

		getTop(country, type) {
			
			var top = [];
			var topCountries = type == 'imp' ? planta_graph.data.yearTopImp : planta_graph.data.yearTopExp;
			var found = false;

			for (var i = 0; i < planta_graph.graphsElms; i++) {
				
				if(topCountries[i].key == country) {
					found = true;
				}

				top.push({
					data: topCountries[i],
					pos: i
				});

			}

			if(found) return top;

			for (var i = topCountries.length - 1; i >= 0; i--) {
				if(topCountries[i].key == country) {
					
					top.push({
						data: topCountries[i],
						pos: i
					});

					return top;
				}
			}

		},

		getFrases(dataCountry) {

			var name = dataCountry.actCountry.name;
			var out = [];

			if(planta_graph.act.type.length == 2) {

				var balance = dataCountry.actCountry.totalExp - dataCountry.actCountry.totalImp;
				var positionImp = planta_graph.tools.getPosition(dataCountry, 'imp');
				var positionExp = planta_graph.tools.getPosition(dataCountry, 'exp');

				if(balance > 0) {
					out.push(name + ' exportó ' + planta_graph.tools.parseAmmount(balance) + ' más en ' + planta_graph.act.prod + ' de los que importó.');
				} else {
					out.push(name + ' importó ' + planta_graph.tools.parseAmmount(-1 * balance) + ' más en ' + planta_graph.act.prod + ' de los que exportó.');
				}
				out.push(name + ' ocupa el puesto número ' + positionExp + ' de países exportadores y el puesto número ' + positionImp + ' de paises exportadores de ' + planta_graph.act.prod + '.');


			} else if(planta_graph.act.type.indexOf('imp') != -1) {

				var position = planta_graph.tools.fixPosition(planta_graph.tools.getPosition(dataCountry, 'imp'));
				var percent = 100 * dataCountry.actCountry.totalImp / planta_graph.data.totalImp;
				var total = 100 * dataCountry.actCountry.totalImp / dataCountry.actCountry.resumen.imps[planta_graph.act.year];

				out.push(name + ' ocupa el ' + position + ' puesto en el ranking de países importadores de ' + planta_graph.act.prod + '.');
				out.push(name + ' controla el ' + percent.toFixed(2) + '% de las importaciones mundiales de ' + planta_graph.act.prod + '.');
				out.push(firstCapital(planta_graph.txt.articulos[planta_graph.act.prod]) + ' supone el ' + total.toFixed(2) + '% de las importaciones de ' + name +  ', ' + planta_graph.tools.parseAmmount(dataCountry.actCountry.totalImp) + '.');

			} else {

				var position = planta_graph.tools.fixPosition(planta_graph.tools.getPosition(dataCountry, 'exp'));
				var percent = 100 * dataCountry.actCountry.totalExp / planta_graph.data.totalExp;
				var total = 100 * dataCountry.actCountry.totalExp / dataCountry.actCountry.resumen.exps[planta_graph.act.year];

				out.push(name + ' ocupa el ' + position + ' puesto en el ranking de países exportadores de ' + planta_graph.act.prod + '.');
				out.push(name + ' controla el ' + percent.toFixed(2) + '% de las exportaciones mundiales de ' + planta_graph.act.prod + '.');
				out.push(firstCapital(planta_graph.txt.articulos[planta_graph.act.prod]) + ' supone el ' + total.toFixed(2) + '% de las exportaciones de ' + name +  ', ' + planta_graph.tools.parseAmmount(dataCountry.actCountry.totalImp) + '.');
			}

			return out;
		},

		parseAmmount(ammout) {
			if(ammout / 1000000 > 1) {
				return numberThousandsDots(parseInt(ammout / 1000000)) + ' millones de dólares';
			} else {
				return numberThousandsDots(ammout) + ' dólares';
			}
		},

		fixPosition (number) {
			switch(number){
				case 1: return 'primer'; break;
				case 2: return 'segundo'; break;
				case 3: return 'tercer'; break;
				default: return number + 'º'; break;
			}
		},

		getPosition(dataCountry, type) {
			if(type == 'imp') {
				for (var i = planta_graph.data.yearTopImp.length - 1; i >= 0; i--) {
					if(planta_graph.data.yearTopImp[i].key == dataCountry.actCountry.key) return i + 1;
				}
			} else {
				for (var i = planta_graph.data.yearTopExp.length - 1; i >= 0; i--) {
					if(planta_graph.data.yearTopExp[i].key == dataCountry.actCountry.key) return i + 1;
				}
			} 
			return null;
		},

		processData: function(data) {

			var countries = planta_graph.data.countries; // alias
			var actData = data[planta_graph.act.year];

			var links = [];
			var tops = {
				exp: [],
				imp: []
			}

			for (var i = countries.length - 1; i >= 0; i--) {
				countries[i].totalImp = 0;
				countries[i].totalExp = 0;
			}


			var imps = [];


			for (var i = countries.length - 1; i >= 0; i--) {
				if(actData[countries[i].key]) {

								// suma exportaciones
					for (var j = countries.length - 1; j >= 0; j--) {
						if(actData[countries[i].key][countries[j].key]) {

							countries[i].totalExp += actData[countries[i].key][countries[j].key];
							countries[j].totalImp += actData[countries[i].key][countries[j].key];

							imps.push(actData[countries[i].key][countries[j].key]);

							links.push({
								source: i,
								target: j,
								val: actData[countries[i].key][countries[j].key]
							});

						}

					}

				}
			}
			
			planta_graph.data.totalExp = 0;
			planta_graph.data.totalImp = 0;

			for (var i = countries.length - 1; i >= 0; i--) {

				planta_graph.data.totalExp += countries[i].totalExp;
				planta_graph.data.totalImp += countries[i].totalImp;

				tops.imp.push({
					key: countries[i].key,
					val: countries[i].totalImp,
					name: countries[i].name
				});

				tops.exp.push({
					key: countries[i].key,
					val: countries[i].totalExp,
					name: countries[i].name
				});
			}

			var maxImp = [];
			var maxExp = [];
			var maxImpExp = [];

			for (var i = countries.length - 1; i >= 0; i--) {
				if(countries[i].totalImp > 0) maxImp.push(countries[i].totalImp);
				if(countries[i].totalExp > 0) maxExp.push(countries[i].totalExp);
				if((countries[i].totalImp + countries[i].totalExp) > 0) maxImpExp.push(countries[i].totalImp + countries[i].totalExp);
			}

			planta_graph.data.yearTopExp = tops.exp.sort(function(x, y){
				return d3.descending(x.val, y.val);
			})

			planta_graph.data.yearTopImp = tops.imp.sort(function(x, y){
				return d3.descending(x.val, y.val);
			})

			planta_graph.data.yearTopImp


			// console.log(maxImp, d3.max(maxImp), maxExp, d3.max(maxExp), maxImpExp, d3.max(maxImpExp), imps, d3.max(imps), countries, links);


				// scalas lineales
			// planta_graph.viz.scale.circImp = 
			// 	d3.scaleLinear().domain([0,d3.max(maxImp)]).range([0,planta_graph.maxCirc]);
			// planta_graph.viz.scale.circExp = 
			// 	d3.scaleLinear().domain([0,d3.max(maxExp)]).range([0,planta_graph.maxCirc]);
			// planta_graph.viz.scale.circImpExp = 
			// 	d3.scaleLinear().domain([0,d3.max(maxImpExp)]).range([0,planta_graph.maxCirc]);
			// planta_graph.viz.scale.lines = 
			// 	d3.scaleLinear().domain([0,d3.max(imps)]).range([0,planta_graph.maxLine]);

			planta_graph.viz.scale.circImp = 
				d3.scalePow().exponent(.7).domain([0,d3.max(maxImp)]).range([0,planta_graph.maxCirc]);
			planta_graph.viz.scale.circExp = 
				d3.scalePow().exponent(.7).domain([0,d3.max(maxExp)]).range([0,planta_graph.maxCirc]);
			planta_graph.viz.scale.circImpExp = 
				d3.scalePow().exponent(.7).domain([0,d3.max(maxImpExp)]).range([0,planta_graph.maxCirc]);
			planta_graph.viz.scale.lines = 
				d3.scalePow().exponent(.9).domain([0,d3.max(imps)]).range([0,planta_graph.maxLine]);

			for (var i = countries.length - 1; i >= 0; i--) {
				countries[i].rTot = planta_graph.viz.scale.circImpExp(countries[i].totalImp + countries[i].totalExp);
				countries[i].rTotImp = planta_graph.viz.scale.circImpExp(countries[i].totalImp);
				countries[i].rTotExp = planta_graph.viz.scale.circImpExp(countries[i].totalExp);
				countries[i].rImp = planta_graph.viz.scale.circImp(countries[i].totalImp);
				countries[i].rExp = planta_graph.viz.scale.circExp(countries[i].totalExp);
			}

				// iniciación inicial de círculos y textos
			if(!planta_graph.viz.circsImp) {


				planta_graph.viz.links = planta_graph.viz.svg
					.selectAll('.link').data(links).enter()
					.append('line')
						.attr('class', 'link')
						.attr('stroke-width', function(d){ return planta_graph.viz.scale.lines(d.val); })
						.on("mouseenter", function(d){
							$('#texto').text('Importaciones de ' + d.source.name + ' a ' + d.target.name + ': ' + d.val + ' dollars');
						}).on("mouseout", function(d){
							$('#texto').text('');
						});

				planta_graph.viz.circExp = planta_graph.viz.svg
					.selectAll('.circExp').data(countries).enter()
					.append('circle')
						.attr('class', 'circExp')
						.on("mouseenter", planta_graph.evs.circExpEnter)
						.on("mousedown", planta_graph.evs.circClick)
						.on("mouseout", planta_graph.evs.circOut);

				planta_graph.viz.circsImp = planta_graph.viz.svg
					.selectAll('.circImp').data(countries).enter()
					.append('circle')
						.attr('class', 'circImp')
						.on("mouseenter", planta_graph.evs.circInEnter)
						.on("mousedown", planta_graph.evs.circClick)
						.on("mouseout", planta_graph.evs.circOut);

				planta_graph.viz.texts = planta_graph.viz.svg
					.selectAll('.text').data(countries).enter()
					.append('text')
						.attr('class', 'text')
						.text(function(d){ return d.key; });
			}

				// actualización de líneas
			planta_graph.viz.links.data(links)
				.attr('stroke-width', function(d){ return planta_graph.viz.scale.lines(d.val); })
				.attr("visibility", function (d) {
					if(planta_graph.act.type.length != 2) return "hidden";
			    	return (planta_graph.viz.scale.lines(d.val) < planta_graph.minLine) ? "hidden" : "visible";
			  	});

				// actualización de círculos y textos
			planta_graph.viz.circsImp.data(countries)
				.attr("visibility", planta_graph.evs.circImpVisibilityCheck)
				.attr('r', planta_graph.evs.circImpRadius)
				.attr('cx', function(d) { return d.x; })
				.attr('cy', function(d) { return d.y; });

			planta_graph.viz.circExp.data(countries)
				.attr("visibility", planta_graph.evs.circExpVisibilityCheck)
				.attr('r', planta_graph.evs.circExpRadius)
				.attr('cx', function(d) { return d.x; })
				.attr('cy', function(d) { return d.y; });

			planta_graph.viz.texts.data(countries)
				.attr("visibility", planta_graph.evs.textVisibilityCheck)
				.attr('x', function(d) { return d.x; })
				.attr('y', function(d) { return d.y + 5; });

			planta_graph.viz.force = d3.forceSimulation(countries)
				.force("link", d3.forceLink(links).strength(0.0000001))
				.force("charge", d3.forceManyBody().strength(0.01))
    			.force("collide", d3.forceCollide().radius(planta_graph.evs.collideRadiusFn).iterations(1).strength(2))
				// .force("link", d3.forceLink(links).strength(function(d){return d.val / 1000 }).distance(20))
				// .force("center", d3.forceCenter(planta_graph.viz.width / 2, planta_graph.viz.height / 2))

				.alphaDecay(.5)
				.velocityDecay(.7)

				.on('tick', planta_graph.tools.tick)
				// .on('end', function(){ console.log('end') })
				.restart();

		},

			// each forze loop
		tick: function() {
			// console.log('tick')

			planta_graph.viz.circsImp
				.attr('cx', function(d) { return d.x; })
				.attr('cy', function(d) { return d.y; });

			planta_graph.viz.circExp
				.attr('cx', function(d) { return d.x; })
				.attr('cy', function(d) { return d.y; });

			planta_graph.viz.links
				.attr('x1', function(d) { return d.source.x; })
				.attr('x2', function(d) { return d.target.x; })
				.attr('y1', function(d) { return d.source.y; })
				.attr('y2', function(d) { return d.target.y; });

			planta_graph.viz.texts
				.attr('x', function(d) { return d.x; })
				.attr('y', function(d) { return d.y + 5; });
			
		},

		initJqueries: function() {

			$('#years')
				.find('.gotoYear').click(planta_graph.evs.changeYear).end()
				.find('.nextYear').click(planta_graph.evs.nextYear).end()
				.find('.prevYear').click(planta_graph.evs.prevYear);

			$('#prods a').click(planta_graph.evs.changeProduct);

			$('#type a').click(planta_graph.evs.changeType);

			$('#years a[data-year=' +  planta_graph.act.year + ']').addClass('act');
			$('#prods a[data-prod=' +  planta_graph.act.prod + ']').addClass('act');

			$(planta_graph.act.type).each(function(e, f){
				$('#type a[data-type=' +  f + ']').addClass('act');
			});

			$('#countrySelect').change(function(e) { 
				planta_graph.countryPop.activa($('#countrySelect option:selected').attr('value'));
			});

		}
	},

	countryPop: {
		active: false,
		$elm: '#pop',
		$frases: '#frases',
		$graphLines: '#graphLines',
		$graphBars1: '#graphBars1',
		$graphBars2: '#graphBars2',

		init: function() {

			planta_graph.countryPop.$elm = $(planta_graph.countryPop.$elm);
			planta_graph.countryPop.$frases = $(planta_graph.countryPop.$frases);
			planta_graph.countryPop.$graphLines = $(planta_graph.countryPop.$graphLines);
			planta_graph.countryPop.$graphBars1 = $(planta_graph.countryPop.$graphBars1);
			planta_graph.countryPop.$graphBars2 = $(planta_graph.countryPop.$graphBars2);
			
			$('#closePop').click(function(){
				planta_graph.countryPop.hide();
			});

			$('body').delegate('.activaCountry', 'click', function(e){
				e.preventDefault();

				var $elm = $(this);
				var target = $elm.data('country');

				if(!target) throw 'No se encontró el pais clickado';

				planta_graph.countryPop.activa(target);
			})
		},

		activa: function(countryKey) {
			
			planta_graph.countryPop.clear();

			planta_graph.tools.getdataCountry(countryKey);
			
			planta_graph.countryPop.active = countryKey;
			
			$('#pop').fadeIn(400);
		},

		draw: function(data) {

		  	var frases = planta_graph.tools.getFrases(data);
		  	$.each(frases, function(e, f){
		  		planta_graph.countryPop.$frases.append($('<li>' + f + '</li>'));
		  	});

		  	var topExp = planta_graph.tools.getTop(data.actCountry.key, 'exp');
		  	var topImp = planta_graph.tools.getTop(data.actCountry.key, 'imp');


		  	planta_graph.countryPop.$graphBars1.append('<h2>Historico</h2>')
		  	planta_graph.countryPop.$graphBars1.append('<h3>exportaciones</h3>')
		  	
		  	$.each(data.actCountry.resumen.exps, function(e, f){
		  		planta_graph.countryPop.$graphBars1.append($('<li>' + e + ' - ' + planta_graph.tools.parseAmmount(f) + '</li>'));
		  	});

		  	planta_graph.countryPop.$graphBars1.append('<h3>importaciones</h3>')
		  	$.each(data.actCountry.resumen.imps, function(e, f){
		  		planta_graph.countryPop.$graphBars1.append($('<li>' + e + ' - ' + planta_graph.tools.parseAmmount(f) + '</li>'));
		  	});

		  	
		  	planta_graph.countryPop.$graphBars1.append('<h2>Principales exportadores</h2>');

		  	$.each(topExp, function(e, f){
		  		
		  		if(e == planta_graph.graphsElms) planta_graph.countryPop.$graphBars1.append('<li>....</li>');

		  		planta_graph.countryPop.$graphBars1.append($('<li><a href="#" class="activaCountry" data-country="' + f.data.key + '">' + (f.pos + 1) + ' - ' + f.data.name + ' - ' + planta_graph.tools.parseAmmount(f.data.val) + '</li>'));
		  	});


		  	planta_graph.countryPop.$graphBars1.append('<h2>Principales importadores</h2>')

		  	$.each(topImp, function(e, f){
		  		
		  		if(e == planta_graph.graphsElms) planta_graph.countryPop.$graphBars1.append('<li>....</li>');
		  		
		  		planta_graph.countryPop.$graphBars1.append($('<li><a href="#" class="activaCountry" data-country="' + f.data.key + '">' + (f.pos + 1) + ' - ' + f.data.name + ' - ' + planta_graph.tools.parseAmmount(f.data.val) + '</li>'));
		  	});

		},

		hide: function() {
			$('#pop').fadeOut(400, function(){
				planta_graph.countryPop.clear();
			});
		},

		clear: function() {

			planta_graph.countryPop.active = null;

			planta_graph.countryPop.$frases.html('');
			planta_graph.countryPop.$graphBars2.html('');
			planta_graph.countryPop.$graphBars1.html('');
			planta_graph.countryPop.$graphLines.html('');

		},

		update: function() {
			if(planta_graph.countryPop.active) planta_graph.countryPop.activa(planta_graph.countryPop.active);
		}
	},

	evs: { // planta_graph.evs.circInEnter


		desactivaCountry: function() {
		},

		circInEnter: function(d) {
			planta_graph.viz.links
				.attr('class', function(e){
					return e.source.name == d.name || e.target.name == d.name ? 'link link-act' : 'link';
				});

			$('#texto').text(d.name + ': Total importaciones ' + numberThousandsDots(d.totalImp) + ' dollars, total exportaciones ' + numberThousandsDots(d.totalExp) + ' dollars');
		},

		circExpEnter: function(d) {
			planta_graph.viz.links
				.attr('class', function(e){
					return e.source.name == d.name || e.target.name == d.name ? 'link link-act' : 'link';
				});

			$('#texto').text(d.name + ': Total importaciones ' + numberThousandsDots(d.totalImp) + ' dollars, total exportaciones ' + numberThousandsDots(d.totalExp) + ' dollars');
		},
		circClick: function(d) {
			planta_graph.countryPop.activa(d.key);
		},

		circOut: function(d){
			planta_graph.viz.links
				.attr('class', 'link');
			$('#texto').text('');
		},

		textVisibilityCheck: function(d) {
			if(planta_graph.act.type.length == 2) {
				return d.rTot < 13 ? "hidden" : "visible";
			} else {
				if($.inArray('imp', planta_graph.act.type) == -1) return d.rExp < 13 ? "hidden" : "visible";
				return d.rImp < 13 ? "hidden" : "visible";
			}
		},

		circImpVisibilityCheck: function(d) {
			if($.inArray('imp', planta_graph.act.type) == -1) return "hidden";
	    	return (d.rImp <  (planta_graph.maxCirc / 50)) ? "hidden" : "visible";
		},

		circImpRadius: function(d) {
			if(planta_graph.act.type.length == 2) return d.rTotImp;
			else return d.rImp;
		},

		circExpVisibilityCheck: function(d) {
			if($.inArray('exp', planta_graph.act.type) == -1) return "hidden";
	    	return (($.inArray('imp', planta_graph.act.type) == -1 ? d.rExp : d.rT) <  (planta_graph.maxCirc / 50)) ? "hidden" : "visible";
		},

		circExpRadius: function(d) {
			return ($.inArray('imp', planta_graph.act.type) == -1) ? d.rExp : d.rTot;
		},

		collideRadiusFn: function(d) {
			if(planta_graph.act.type.length == 2) {
				return d.rTot + 8;
			} else {
				if($.inArray('imp', planta_graph.act.type) == -1) return d.rExp + 5;
				return d.rImp + 5;
			}
			return d.rTot + 5;
		},

		changeProduct: function(e) {
			
			e.preventDefault();
			
			$('#prods .act').removeClass('act');

			var prod = $(this).addClass('act').data('prod');
			if(!prod || planta_graph.act.prod == prod) { console.log('no hay producto'); return; };

			planta_graph.act.prod = prod;

				// carga datos nuevos y pinta
			planta_graph.tools.update();
		},

		gotoYear: function(year) {

			if(!year || planta_graph.act.year == year || year > 2014 || year < 2004) return;

			planta_graph.act.year = year;
			
			$('#years .act').removeClass('act');
			$('#years .disabled').removeClass('disabled');
			$('#years [data-year="' + year + '"]').addClass('act');

			if(year == 2014) $('#years .nextYear').addClass('disabled');
			if(year == 2004) $('#years .prevYear').addClass('disabled');

				// actualiza el dibujo
			planta_graph.tools.update();
		},

		changeYear: function(e) {
			
			e.preventDefault();

			planta_graph.evs.gotoYear($(this).data('year'));
		},

		prevYear: function(e) {
			
			e.preventDefault();

			if(planta_graph.act.year == 2004) return;

			planta_graph.evs.gotoYear(planta_graph.act.year - 1);

		},

		nextYear: function(e) {
			
			e.preventDefault();

			if(planta_graph.act.year == 2014) return;

			planta_graph.evs.gotoYear(planta_graph.act.year + 1);
		},

		changeType: function(e) {
			
			e.preventDefault();

			var $this = $(this);
			var type = $this.data('type');

				// ya activado => desactiva
			if($.inArray(type, planta_graph.act.type) != -1){
					
					// para no quedarnos a 0
				if(planta_graph.act.type.length < 2) return;

				$this.removeClass('act');
				planta_graph.act.type.splice(planta_graph.act.type.indexOf(type), 1);

				// no activado => activa
			} else {

				$this.addClass('act');
				planta_graph.act.type.push(type);
			}

				// actualiza el dibujo
			planta_graph.tools.update();

		}
	},

};

planta_graph.init();

function throttle (callback, limit) {   // http://sampsonblog.com/749/simple-throttle-function modificado!
    var wait = false;                 // Initially, we're not waiting
    return function () {              // We return a throttled function
        if (!wait) {                  // If we're not waiting
                                       // Execute users function
            wait = true;              // Prevent future invocations
            setTimeout(function () {  // After a period of time
                callback.call();
                wait = false;         // And allow future invocations
            }, limit);
        }
    }
}

function numberThousandsDots (number) {
 	return number.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1.");
};

function firstCapital(string) {
	return string.charAt(0).toUpperCase() + string.slice(1);
};


function shareTweet (texto, url, hash, via) {
    if(!texto) return false;

    var windowOptions = 'scrollbars=yes,resizable=yes,toolbar=no,location=yes',
        width = 550,
        height = 420,
        winHeight = screen.height,
        winWidth = screen.width;

    var left = Math.round((winWidth / 2) - (width / 2));
    var top = 0;

    if (winHeight > height) {
      top = Math.round((winHeight / 2) - (height / 2));
    }

    var target = 'https://twitter.com/intent/tweet?text=' + texto
    if(url && url != false) {
    	target += '&url=' + clearUrl(url);
    } else if (url != false) { target += '&url=' + encodeURIComponent(window.location.href); }
    
    if(hash) target += '&hashtags=' + hash;
    if(via) target += '&via=' + via;

    window.open(target, 'intent', windowOptions + ',width=' + width +
                                       ',height=' + height + ',left=' + left + ',top=' + top);

    function clearUrl(url) {
    	if(url.indexOf('#') != -1) url = url.substring(0, url.indexOf('#'));
    	if(url.indexOf('?') != -1) url = url.substring(0, url.indexOf('?'));
    	return url;
    }
};


function shareFacebook (url) {

    var windowOptions = 'scrollbars=yes,resizable=yes,toolbar=no,location=yes',
        width = 550,
        height = 420,
        winHeight = screen.height,
        winWidth = screen.width;

    var left = Math.round((winWidth / 2) - (width / 2));
    var top = 0;

    if (winHeight > height) {
      top = Math.round((winHeight / 2) - (height / 2));
    }

    var target = 'https://www.facebook.com/sharer/sharer.php?app_id=435567026494540&u=' + url
    window.open(target, 'intent', windowOptions + ',width=' + width +
                                       ',height=' + height + ',left=' + left + ',top=' + top);

};

</script>
</body>
</html>