<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<link href="https://fonts.googleapis.com/css?family=Merriweather:900|Open+Sans|Roboto:400,700,900" rel="stylesheet">
    
    <link rel="stylesheet" href="http://artesansatwork.com/eldiario/wp-content/themes/appress/css/bootstrap-3.3.5.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="http://artesansatwork.com/eldiario/wp-content/themes/appress/css/font-faces.css?v=1490716027">
    <link rel="stylesheet" href="http://artesansatwork.com/eldiario/wp-content/themes/appress/css/app-template.css?v=1490716027">
    <link rel="stylesheet" href="http://artesansatwork.com/eldiario/wp-content/themes/appress/style.css?v=1490716027">
    <link rel="stylesheet" href="http://artesansatwork.com/eldiario/wp-content/themes/appress/css/responsive.css?v=1490716028">
    <link rel="stylesheet" href="http://artesansatwork.com/eldiario/wp-content/themes/appress/css/slick.css">
    <link rel="stylesheet" href="http://artesansatwork.com/eldiario/wp-content/themes/appress/css/slick-theme.css">
    
    
    <script src="http://artesansatwork.com/eldiario/wp-content/themes/appress/js/jquery-2.1.4.min.js"></script>
    <script src="http://artesansatwork.com/eldiario/wp-content/themes/appress/js/bootstrap-3.3.5.min.js"></script>
    <script src="http://artesansatwork.com/eldiario/wp-content/themes/appress/js/slick.min.js"></script>
    <script src="http://artesansatwork.com/eldiario/wp-content/themes/appress/js/app-template-scripts.js?v=1490716028"></script>

	<script type="text/javascript" src="http://estaticos.lab.eldiario.es/estaticos/libs/jquery.autocomplete.js"></script>
	<script src="http://estaticos.lab.eldiario.es/libs/d3-4.7.1.min.js"></script>
    
    
    <link rel="shortcut icon" href="http://artesansatwork.com/eldiario/wp-content/themes/appress/images/favicon.png">
	
	<title>TITEL - eldiario.es</title>
	<meta name="description" content="DESC">
	<meta name="keywords" content="KEYWS">
	<meta charset="utf-8">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta http-equiv="Content-Language" content="es-es">

	<meta property="og:title" content="TTTIEL">
	<meta property="og:description" content="DESC">
	<meta property="og:url" content="URL">
	<meta property="og:site_name" content="TTTIEL" />

	<meta name="twitter:image:src" content="JPG">
	<meta property="og:image" content="JPG">

	<meta name="twitter:card" content="summary_large_image">
	<meta name="twitter:site" content="@eldiarioes">
	<meta name="twitter:creator" content="@eldiarioes">
	<meta name="twitter:title" content="TTTIEL">
	<meta name="twitter:description" content="DESC">

	<meta property="fb:app_id" content="417471918268686">

	<meta name="viewport" content="width=device-width, initial-scale=1"/>
</head>
<style>
#plantiGraph { width: 100%; overflow: hidden; }

.btn { background: #999999; color: white;
	padding: 0.2em 0.8em; border-radius: 0;}
.btn.act { background: #d35d33; color: white; }

#prods img { height: 25px; }
#prods svg path { -webkit-transform: scale(0.22); -ms-transform-origin: left top;
	-webkit-transform: scale(0.22); -ms-transform-origin: left top;
	transform: scale(0.22); transform-origin: left top; }
#prods span { display: none; }
	.fullGraph #prods span { display: initial; padding-left: 0.6em; }

#typeImp.act { background: #126567; }
#typeExp.act { background: #d35d33; }

#years .disabled { cursor: inherit; color: #333; }

#head {  }
	#type, #prods, #years { width: 33.33333333%; float: left; }

#graph { background: #efefef; position: relative; }

	.link {  fill: none; stroke: rgba(0,0,0,0.4); }
		.link:hover, .link-act { stroke: rgba(60, 4, 4, 0.6); }
		.fullGraph .link { -webkit-transition: stroke .5s; -ms-transition: stroke .5s; transition: stroke .5s; }

	.circImp { fill: #126567; cursor: pointer; }
		.fullGraph .circImp {  -webkit-transform-origin: center center; -ms-transform-origin: center center; transform-origin: center center;
				-webkit-transition: all .5s; -ms-transition: all .5s; transition: all .5s; }
		.fullGraph .circImp:hover { /*fill: rgba(6, 3, 68, 0.4);*/
		  		-webkit-transform: -ms-scale(1.1); transform: scale(1.1); transform: scale(1.1); }

	.circExp { fill: #d35d33; cursor: pointer; }
		.fullGraph .circExp {  -webkit-transform-origin: center center; -ms-transform-origin: center center; transform-origin: center center;
				-webkit-transition: all .5s; -ms-transition: all .5s; transition: all .5s; }
		.fullGraph .circExp:hover { /*fill: rgba(6, 3, 68, 0.4);*/
				-webkit-transform: -ms-scale(1.1); transform: scale(1.1); transform: scale(1.1); }

	.text {  fill: white; font-weight: 900; font-family: arial, sans-serif; font-size: 12px; pointer-events: none; text-anchor: middle; }
		.fullGraph .text { -webkit-transition: stroke .5s; -ms-transition: stroke .5s; transition: stroke .5s; }

	#plantiGraph.fullGraph #pop { position: absolute; top: 0; height: 100%; overflow: auto; right: -100%; width: 100%; max-width: 800px; background: #efefef; z-index: 1;
				-webkit-transition: all 1s; -ms-transition: all 1s; transition: all 1s;
			    border-left: 2px solid white; }
		#plantiGraph.fullGraph.actPop #pop { right: 0; }
		#plantiGraph.fullGraph.actPop #viz { opacity: 0.6; -webkit-transform: translateX(-800px); -webkit-transform: translateX(-800px); transform: translateX(-800px); }
	#viz { -webkit-transition: all 1s; -ms-transition: all 1s; transition: all 1s; }
	#closePop { position: absolute; left: -300px; top: 1em; font-weight: 900; -webkit-transition: all 1s; -ms-transition: all 1s; transition: all 1s; }
		#plantiGraph.fullGraph.actPop #closePop { left: 1em; }
	
	#popWrap { padding: 1em; }
	#graphBars1, #graphBars2, #graphLines { width: 33%; float: left; box-sizing: border-box; padding: 0.4em; padding-top: 0; }
	#graphBars1 li, #graphBars2 li { list-style: none; line-height: 1.8em; }
	#graphBars1 .key, #graphBars2 .key { display: inline-block; width: 33px; text-align: center; font-weight: 900; text-transform: uppercase; line-height: 1.7em; }
	#popWrap .inn { padding: 1em; background: white; }
#pop h4 { font-size: 1em; font-family: roboto, sans-serif; font-weight: 900; }

.bar { background: #ccc; position: relative; display: inline-block; line-height: 1.5em; margin-left: 1em; height: 1.7em; vertical-align: middle; width: 0; }
	.bar span { position: absolute; right: 0; padding: 0.7em; line-height: 1em; }

	.bar-left span { right: inherit; left: 100%; }

	.activeBar .bar span { color: white; }
	.activeBar .bar-left span { color: #484848; }

	#graphBars1 .activeBar .bar { background: #d35d33; }
	#graphBars2 .activeBar .bar { background: #126567; }

#frases li { list-style: none; padding: 0.8em 50px 0.8em 0.8em; background: white; margin: 0 0.4em 0.8em 0.4em; position: relative; cursor: pointer; }
#frases li:hover { text-decoration: underline; }
#frases li i { position: absolute; right: 0; bottom: 0; padding: 0.4em; font-size: 1.6em; color: #00aced; text-decoration: none!important; }
</style>
<body>
<div id="plantiGraph">
	<h1>Lorem ipsum dolor sit amet</h1>

	<div id="type">
		<h4>¿Qué datos quieres mostrar?</h4>
		<p>Filtra por datos de exportación o importación</p>

		<a href="#" data-type="imp" id="typeImp" class="btn">Importaciones</a>
		<a href="#" data-type="exp" id="typeExp" class="btn">Exportaciones</a>
	</div>
	<div id="prods">
		<h4>¿Por qué producto quieres filtrar?</h4>
		<p>Selecciona una opción</p>

		<a href="#" data-prod="cacao" class="btn"><img src="./icons/chocolate.svg"><span>Cacao</span></a>
		<a href="#" data-prod="banana" class="btn"><img src="./icons/banana.svg"><span>Banana</span></a>
		<a href="#" data-prod="azucar" class="btn"><img src="./icons/sugar.svg"><span>Azucar</span></a>
		<a href="#" data-prod="aceite" class="btn"><img src="./icons/palm_oil.svg"><span>Aceite</span></a>
		<a href="#" data-prod="cafe" class="btn"><img src="./icons/coffee.svg"><span>Café</span></a>
	</div>
	<div id="years">
		<a href="#" class="prevYear btn"><</a>
		<a href="#" data-year="2004" class="gotoYear btn">2004</a>
		<a href="#" data-year="2005" class="gotoYear btn">2005</a>
		<a href="#" data-year="2006" class="gotoYear btn">2006</a>
		<a href="#" data-year="2007" class="gotoYear btn">2007</a>
		<a href="#" data-year="2008" class="gotoYear btn">2008</a>
		<a href="#" data-year="2009" class="gotoYear btn">2009</a>
		<a href="#" data-year="2010" class="gotoYear btn">2010</a>
		<a href="#" data-year="2011" class="gotoYear btn">2011</a>
		<a href="#" data-year="2012" class="gotoYear btn">2012</a>
		<a href="#" data-year="2013" class="gotoYear btn">2013</a>
		<a href="#" data-year="2014" class="gotoYear btn">2014</a>
		<a href="#" class="nextYear btn disabled">></a>
	</div>


	<input type="text" id="countryImput">
	<select name="countrySelect" id="countrySelect">
		
	</select>

	<div id="graph">
		<svg id="viz"></svg>
		<div id="closePop">< Volver a la visualización Global</div>

		<div id="pop">
			<div id="popWrap">
				<div id="frases">
					
				</div>
				<div id="graphLines"><div class="inn"></div>
					
				</div>
				<div id="graphBars1"><div class="inn"></div>
					
				</div>
				<div id="graphBars2"><div class="inn"></div>
					
				</div>
			</div>
		</div>
		
	</div>
</div>

<script>

var plantiGraph = {

	pathData: './',
	pathPaises: './paisesTot.json',
	pathQuery: '?mls3',

	act:{
		year: 2014,
		prod: 'cafe',
		type: ['imp', 'exp'],
	},

	breakPoint: 800,
	breakPointClass: 'fullGraph',

	maxCircProp: 20, // relation winWidth to maxCircProp
	maxCirc: null, // generated max circle size 
	maxLineProp: 100,
	maxLine: null,

	minLineProp: 4, // relation of max circ
	minLine: null,
	minCircProp: 10, // relation of max circ
	minCirc: null,

	graphsElms: 5,

	viz: {
		width: 0,
		height: 0,

		$wrap: '#plantiGraph',
		$elm: '#viz',
		svg: null,

		projection: null,
		path: null,
		map: null,
		circImp: null,
		circExp: null,
		texts: null,
		force: null,
		scale: {
			circImp: null,
			circExp: null,
			circImpExp: null,
			lines: null,
		}
	},

	data: {
		countries: null, // datos reales
		
		yearTopExp: null, // calculo de tops del año activo
		yearTopImp: null,

		totalExp: null,
		totalImp: null,
	},
	txt: {
		articulos: {
			cafe: 'el cafe',
			aceite: 'el aceite',
			cacao: 'el cacao',
			banana: 'la banana',
			azucar: 'el azucar'
		}
	},

	init: function() {

		plantiGraph.viz.svg = d3.select(plantiGraph.viz.$elm);
		plantiGraph.viz.$elm = $(plantiGraph.viz.$elm);
		plantiGraph.viz.$wrap = $(plantiGraph.viz.$wrap);

		plantiGraph.countryPop.init();
		
		// plantiGraph.tools.loadCountries();

		plantiGraph.tools.initJqueries();

		$(window).bind('orientationchange resize', throttle(plantiGraph.tools.handleResize, 300));

		plantiGraph.tools.handleResize();
	},

	tools: {

		handleResize: function() {
			plantiGraph.tools.loadCountries();
			plantiGraph.tools.updateProjection();
			plantiGraph.tools.update();
			// plantiGraph.tools.initBG();
		},

		updateProjection: function() {

		   	plantiGraph.viz.width = $(window).width();
		   	plantiGraph.viz.height = plantiGraph.viz.width / 2;
			
			if(plantiGraph.viz.width < plantiGraph.breakPoint) {
				plantiGraph.viz.height = plantiGraph.viz.width / 1.4;
				plantiGraph.viz.$wrap.removeClass(plantiGraph.breakPointClass)
			} else {
				plantiGraph.viz.$wrap.addClass(plantiGraph.breakPointClass)
			}

		   	plantiGraph.viz.$elm.css({
		   		width: plantiGraph.viz.width,
		   		height: plantiGraph.viz.height
		   	});

		   	plantiGraph.viz.projection = d3.geoMercator()
		   		.scale(170 * (plantiGraph.viz.width / 1000))
		   		.translate([(plantiGraph.viz.width / 2) - (plantiGraph.viz.width / 14), (plantiGraph.viz.height / 2) + (plantiGraph.viz.height / 5)])
				.precision(51);

			plantiGraph.viz.path = d3.geoPath().projection(plantiGraph.viz.projection);

			if(plantiGraph.data.prod)
				for (var i = 0; i < plantiGraph.data.prod.length; i++) {
					plantiGraph.data.prod[i].x = plantiGraph.viz.projection([plantiGraph.data.prod[i].lon, plantiGraph.data.prod[i].lat])[0];
					plantiGraph.data.prod[i].y = plantiGraph.viz.projection([plantiGraph.data.prod[i].lon, plantiGraph.data.prod[i].lat])[1];
				};

			plantiGraph.maxCirc = parseInt(plantiGraph.viz.width / plantiGraph.maxCircProp);
			plantiGraph.minCirc = Math.ceil(plantiGraph.maxCirc / plantiGraph.minCircProp);
			plantiGraph.maxLine = parseInt(plantiGraph.viz.width / plantiGraph.maxLineProp);
			plantiGraph.minLine = Math.ceil(plantiGraph.maxLine / plantiGraph.minLineProp);

		},
			// fondo de paises
		initBG: function() {

			d3.json("./world-50m.json", function(error, world) {
				if (error) throw error;

				var countries = topojson.feature(world, world.objects.countries).features;
				// var neighbors = topojson.neighbors(world.objects.countries.geometries);

				if(plantiGraph.viz.map) plantiGraph.viz.map.remove()

				plantiGraph.viz.map = plantiGraph.viz.svg.selectAll(".country")
					.data(countries)
					.enter()
						.insert("path", ".graticule")
							.attr('d', plantiGraph.viz.path)
							.attr('class', "country")
							.style('stroke', '#ccc')
							.style('fill', 'none')
							.style('stroke-width', '1');

			});
		},

		loadCountries: function(cb) {

			d3.json(plantiGraph.pathPaises, function(error, world) {
			  	
			  	if (error) throw error;

			  	var paises = [];
			  	var autoComplete = [];

			  	for (var key in world) {
				  if (world.hasOwnProperty(key)) {

				    var pais = world[key];

				    pais.key = key;
				    pais.posX = plantiGraph.viz.projection([pais.lon, pais.lat])[0];
				    pais.posY = plantiGraph.viz.projection([pais.lon, pais.lat])[1];
				    pais.x = pais.posX;
				    pais.y = pais.posY;

				    paises.push(pais);


				    autoComplete.push({
				    	value: pais.name,
				    	data: {
				    		id: pais.name,
				    		key: pais.key
				    	}
				    });


				    $('#countrySelect').append('<option value="' + pais.key + '">' + pais.name + '</option>')

				  }
				};
				
				$('#countryImput').autocomplete({
		          lookup: autoComplete,
		          minChars: 3,
		          orientation: 'bottom',
		          autoSelectFirst: true,
		          showNoSuggestionNotice: true,
		          noSuggestionNotice: 'No se encontraron coincidencias',
		          groupBy: 'p',
		          onSelect: function (suggestion) {
		            plantiGraph.countryPop.activa(suggestion.data.key);
		          }
		        });

				plantiGraph.data.countries = paises;
				
				if(cb) cb();
			});
		},

		update: function() {
			d3.json(plantiGraph.pathData + plantiGraph.act.prod + '.json' + plantiGraph.pathQuery, function(error, data){
			    
			    if (error) throw error;

			    	// si no hay paises los carga asyncronos
				if(!plantiGraph.data.countries) plantiGraph.tools.loadCountries(function(){ 
					
					plantiGraph.tools.processData(data);

					return;
				});

				plantiGraph.tools.processData(data);

				plantiGraph.countryPop.update();

			});
		},

		getdataCountry: function(country) {
			d3.json(plantiGraph.pathData + plantiGraph.act.prod + '.json' + plantiGraph.pathQuery, function(error, data){			    
			    if (error) throw error;

			    var dataCountry = {
			    	actCountry: null,
			    	expByYear: [],
			    	impByYear: [],
			    };

			    for (var i = plantiGraph.data.countries.length - 1; i >= 0; i--) {
					if(plantiGraph.data.countries[i].key == country) dataCountry.actCountry = plantiGraph.data.countries[i];
				}
				if(!dataCountry.actCountry) throw 'No se encontró el pais activo';

			  	for(var year = 2004; year <= 2014; year++) {

			  		dataCountry.expByYear[year] = 0
			  		dataCountry.impByYear[year] = 0

					for (var i = plantiGraph.data.countries.length - 1; i >= 0; i--) {
						if(plantiGraph.data.countries[i].key == country) {
							for (var k = plantiGraph.data.countries.length - 1; k >= 0; k--) { 
								if(data[year][country] && data[year][country][plantiGraph.data.countries[k].key]) dataCountry.impByYear[year] += data[year][country][plantiGraph.data.countries[k].key];
							}
						} else if (data[year][plantiGraph.data.countries[i].key] && data[year][plantiGraph.data.countries[i].key][country]) {
							dataCountry.expByYear[year] += data[year][plantiGraph.data.countries[i].key][country];
						}
					}

			  	}

			  	plantiGraph.countryPop.draw(dataCountry);

			});
		},

		getTop(country, type) {
			
			var top = [];
			var topCountries = type == 'imp' ? plantiGraph.data.yearTopImp : plantiGraph.data.yearTopExp;
			var found = false;

			for (var i = 0; i < plantiGraph.graphsElms; i++) {
				
				if(topCountries[i].key == country) {
					found = true;
				}

				top.push({
					data: topCountries[i],
					pos: i
				});

			}

			if(found) return top;

			for (var i = topCountries.length - 1; i >= 0; i--) {
				if(topCountries[i].key == country) {
					
					top.push({
						data: topCountries[i],
						pos: i
					});

					return top;
				}
			}

		},

		getFrases(dataCountry) {

			var name = dataCountry.actCountry.name;
			var out = [];

			if(plantiGraph.act.type.length == 2) {

				var balance = dataCountry.actCountry.totalExp - dataCountry.actCountry.totalImp;
				var positionImp = plantiGraph.tools.getPosition(dataCountry, 'imp');
				var positionExp = plantiGraph.tools.getPosition(dataCountry, 'exp');

				if(balance > 0) {
					out.push('<strong>' + name + '</strong> exportó <strong>' + plantiGraph.tools.parseAmmount(balance) + ' más</strong> en <strong>' + plantiGraph.act.prod + '</strong> de los que importó.');
				} else {
					out.push('<strong>' + name + '</strong> importó <strong>' + plantiGraph.tools.parseAmmount(-1 * balance) + ' más</strong> en <strong>' + plantiGraph.act.prod + '</strong> de los que exportó.');
				}
				out.push('<strong>' + name + '</strong> ocupa el puesto número <strong>' + positionExp + '</strong> de países exportadores y el puesto número <strong>' + positionImp + '</strong> de paises exportadores de <strong>' + plantiGraph.act.prod + '</strong>.');


			} else if(plantiGraph.act.type.indexOf('imp') != -1) {

				var position = plantiGraph.tools.fixPosition(plantiGraph.tools.getPosition(dataCountry, 'imp'));
				var percent = 100 * dataCountry.actCountry.totalImp / plantiGraph.data.totalImp;
				var total = 100 * dataCountry.actCountry.totalImp / dataCountry.actCountry.resumen.imps[plantiGraph.act.year];

				out.push('<strong>' + name + '</strong> ocupa el <strong>' + position + ' puesto</strong> en el ranking de países importadores de <strong>' + plantiGraph.act.prod + '</strong>.');
				out.push('<strong>' + name + '</strong> controla el <strong>' + percent.toFixed(2) + '%</strong> de las importaciones mundiales de <strong>' + plantiGraph.act.prod + '</strong>.');
				out.push('<strong>' + firstCapital(plantiGraph.txt.articulos[plantiGraph.act.prod]) + '</strong> supone el ' + total.toFixed(2) + '% de las importaciones de <strong>' + name +  '</strong>, ' + plantiGraph.tools.parseAmmount(dataCountry.actCountry.totalImp) + '</strong>.');

			} else {

				var position = plantiGraph.tools.fixPosition(plantiGraph.tools.getPosition(dataCountry, 'exp'));
				var percent = 100 * dataCountry.actCountry.totalExp / plantiGraph.data.totalExp;
				var total = 100 * dataCountry.actCountry.totalExp / dataCountry.actCountry.resumen.exps[plantiGraph.act.year];

				out.push('<strong>' + name + '</strong> ocupa el <strong>' + position + ' puesto</strong> en el ranking de países exportadores de <strong>' + plantiGraph.act.prod + '</strong>.');
				out.push('<strong>' + name + '</strong> controla el <strong>' + percent.toFixed(2) + '%</strong> de las exportaciones mundiales de <strong>' + plantiGraph.act.prod + '</strong>.');
				out.push('<strong>' + firstCapital(plantiGraph.txt.articulos[plantiGraph.act.prod]) + ' supone el ' + total.toFixed(2) + '% de las exportaciones de <strong>' + name +  '</strong>, ' + plantiGraph.tools.parseAmmount(dataCountry.actCountry.totalImp) + '.');
			}

			return out;
		},

		parseAmmount(ammout) {
			if(ammout / 1000000 > 1) {
				return numberThousandsDots(parseInt(ammout / 1000000)) + ' millones de dólares';
			} else {
				return numberThousandsDots(ammout) + ' dólares';
			}
		},

		fixPosition (number) {
			switch(number){
				case 1: return 'primer'; break;
				case 2: return 'segundo'; break;
				case 3: return 'tercer'; break;
				default: return number + 'º'; break;
			}
		},

		getPosition(dataCountry, type) {
			if(type == 'imp') {
				for (var i = plantiGraph.data.yearTopImp.length - 1; i >= 0; i--) {
					if(plantiGraph.data.yearTopImp[i].key == dataCountry.actCountry.key) return i + 1;
				}
			} else {
				for (var i = plantiGraph.data.yearTopExp.length - 1; i >= 0; i--) {
					if(plantiGraph.data.yearTopExp[i].key == dataCountry.actCountry.key) return i + 1;
				}
			} 
			return null;
		},

		processData: function(data) {

			var countries = plantiGraph.data.countries; // alias
			var actData = data[plantiGraph.act.year];

			var links = [];
			var tops = {
				exp: [],
				imp: []
			}

			for (var i = countries.length - 1; i >= 0; i--) {
				countries[i].totalImp = 0;
				countries[i].totalExp = 0;
			}


			var imps = [];


			for (var i = countries.length - 1; i >= 0; i--) {
				if(actData[countries[i].key]) {

								// suma exportaciones
					for (var j = countries.length - 1; j >= 0; j--) {
						if(actData[countries[i].key][countries[j].key]) {

							countries[i].totalExp += actData[countries[i].key][countries[j].key];
							countries[j].totalImp += actData[countries[i].key][countries[j].key];

							imps.push(actData[countries[i].key][countries[j].key]);

							links.push({
								source: i,
								target: j,
								val: actData[countries[i].key][countries[j].key]
							});

						}

					}

				}
			}
			
			plantiGraph.data.totalExp = 0;
			plantiGraph.data.totalImp = 0;

			for (var i = countries.length - 1; i >= 0; i--) {

				plantiGraph.data.totalExp += countries[i].totalExp;
				plantiGraph.data.totalImp += countries[i].totalImp;

				tops.imp.push({
					key: countries[i].key,
					val: countries[i].totalImp,
					name: countries[i].name
				});

				tops.exp.push({
					key: countries[i].key,
					val: countries[i].totalExp,
					name: countries[i].name
				});
			}

			var maxImp = [];
			var maxExp = [];
			var maxImpExp = [];

			for (var i = countries.length - 1; i >= 0; i--) {
				if(countries[i].totalImp > 0) maxImp.push(countries[i].totalImp);
				if(countries[i].totalExp > 0) maxExp.push(countries[i].totalExp);
				if((countries[i].totalImp + countries[i].totalExp) > 0) maxImpExp.push(countries[i].totalImp + countries[i].totalExp);
			}

			plantiGraph.data.yearTopExp = tops.exp.sort(function(x, y){
				return d3.descending(x.val, y.val);
			})

			plantiGraph.data.yearTopImp = tops.imp.sort(function(x, y){
				return d3.descending(x.val, y.val);
			})

			plantiGraph.data.yearTopImp


			// console.log(maxImp, d3.max(maxImp), maxExp, d3.max(maxExp), maxImpExp, d3.max(maxImpExp), imps, d3.max(imps), countries, links);


				// scalas lineales
			// plantiGraph.viz.scale.circImp = 
			// 	d3.scaleLinear().domain([0,d3.max(maxImp)]).range([0,plantiGraph.maxCirc]);
			// plantiGraph.viz.scale.circExp = 
			// 	d3.scaleLinear().domain([0,d3.max(maxExp)]).range([0,plantiGraph.maxCirc]);
			// plantiGraph.viz.scale.circImpExp = 
			// 	d3.scaleLinear().domain([0,d3.max(maxImpExp)]).range([0,plantiGraph.maxCirc]);
			// plantiGraph.viz.scale.lines = 
			// 	d3.scaleLinear().domain([0,d3.max(imps)]).range([0,plantiGraph.maxLine]);

			plantiGraph.viz.scale.circImp = 
				d3.scalePow().exponent(.7).domain([0,d3.max(maxImp)]).range([0,plantiGraph.maxCirc]);
			plantiGraph.viz.scale.circExp = 
				d3.scalePow().exponent(.7).domain([0,d3.max(maxExp)]).range([0,plantiGraph.maxCirc]);
			plantiGraph.viz.scale.circImpExp = 
				d3.scalePow().exponent(.7).domain([0,d3.max(maxImpExp)]).range([0,plantiGraph.maxCirc]);
			plantiGraph.viz.scale.lines = 
				d3.scalePow().exponent(.9).domain([0,d3.max(imps)]).range([0,plantiGraph.maxLine]);

			for (var i = countries.length - 1; i >= 0; i--) {
				countries[i].rTot = plantiGraph.viz.scale.circImpExp(countries[i].totalImp + countries[i].totalExp);
				countries[i].rTotImp = plantiGraph.viz.scale.circImpExp(countries[i].totalImp);
				countries[i].rTotExp = plantiGraph.viz.scale.circImpExp(countries[i].totalExp);
				countries[i].rImp = plantiGraph.viz.scale.circImp(countries[i].totalImp);
				countries[i].rExp = plantiGraph.viz.scale.circExp(countries[i].totalExp);
			}

				// iniciación inicial de círculos y textos
			if(!plantiGraph.viz.circsImp) {


				plantiGraph.viz.links = plantiGraph.viz.svg
					.selectAll('.link').data(links).enter()
					.append('line')
						.attr('class', 'link')
						.attr('stroke-width', function(d){ return plantiGraph.viz.scale.lines(d.val); })
						.on("mouseenter", plantiGraph.evs.linksEnter)
						.on("mouseout", plantiGraph.evs.circOut)

				plantiGraph.viz.circExp = plantiGraph.viz.svg
					.selectAll('.circExp').data(countries).enter()
					.append('circle')
						.attr('class', 'circExp')
						.on("mouseenter", plantiGraph.evs.circExpEnter)
						.on("mousedown", plantiGraph.evs.circClick)
						.on("mouseout", plantiGraph.evs.circOut);

				plantiGraph.viz.circsImp = plantiGraph.viz.svg
					.selectAll('.circImp').data(countries).enter()
					.append('circle')
						.attr('class', 'circImp')
						.on("mouseenter", plantiGraph.evs.circInEnter)
						.on("mousedown", plantiGraph.evs.circClick)
						.on("mouseout", plantiGraph.evs.circOut);

				plantiGraph.viz.texts = plantiGraph.viz.svg
					.selectAll('.text').data(countries).enter()
					.append('text')
						.attr('class', 'text')
						.text(function(d){ return d.key; });
			}

				// actualización de líneas
			plantiGraph.viz.links.data(links)
				.attr('stroke-width', function(d){ return plantiGraph.viz.scale.lines(d.val); })
				.attr("visibility", function (d) {
					if(plantiGraph.act.type.length != 2) return "hidden";
			    	return (plantiGraph.viz.scale.lines(d.val) < plantiGraph.minLine) ? "hidden" : "visible";
			  	});

				// actualización de círculos y textos
			plantiGraph.viz.circsImp.data(countries)
				.attr("visibility", plantiGraph.evs.circImpVisibilityCheck)
				.attr('r', plantiGraph.evs.circImpRadius)
				.attr('cx', function(d) { return d.x; })
				.attr('cy', function(d) { return d.y; });

			plantiGraph.viz.circExp.data(countries)
				.attr("visibility", plantiGraph.evs.circExpVisibilityCheck)
				.attr('r', plantiGraph.evs.circExpRadius)
				.attr('cx', function(d) { return d.x; })
				.attr('cy', function(d) { return d.y; });

			plantiGraph.viz.texts.data(countries)
				.attr("visibility", plantiGraph.evs.textVisibilityCheck)
				.attr('x', function(d) { return d.x; })
				.attr('y', function(d) { return d.y + 5; });

			plantiGraph.viz.force = d3.forceSimulation(countries)
				.force("link", d3.forceLink(links).strength(0.0000001))
				.force("charge", d3.forceManyBody().strength(0.01))
    			.force("collide", d3.forceCollide().radius(plantiGraph.evs.collideRadiusFn).iterations(1).strength(2))
				// .force("link", d3.forceLink(links).strength(function(d){return d.val / 1000 }).distance(20))
				// .force("center", d3.forceCenter(plantiGraph.viz.width / 2, plantiGraph.viz.height / 2))

				.alphaDecay(.5)
				.velocityDecay(.7)

				.on('tick', plantiGraph.tools.tick)
				.restart();

		},

			// each forze loop
		tick: function() {

			plantiGraph.viz.circsImp
				.attr('cx', function(d) { return d.x; })
				.attr('cy', function(d) { return d.y; });

			plantiGraph.viz.circExp
				.attr('cx', function(d) { return d.x; })
				.attr('cy', function(d) { return d.y; });

			plantiGraph.viz.links
				.attr('x1', function(d) { return d.source.x; })
				.attr('x2', function(d) { return d.target.x; })
				.attr('y1', function(d) { return d.source.y; })
				.attr('y2', function(d) { return d.target.y; });

			plantiGraph.viz.texts
				.attr('x', function(d) { return d.x; })
				.attr('y', function(d) { return d.y + 5; });
			
		},

		initJqueries: function() {

			$('#years')
				.find('.gotoYear').click(plantiGraph.evs.changeYear).end()
				.find('.nextYear').click(plantiGraph.evs.nextYear).end()
				.find('.prevYear').click(plantiGraph.evs.prevYear);

			$('#prods a').click(plantiGraph.evs.changeProduct);

			$('#type a').click(plantiGraph.evs.changeType);

			$('#years a[data-year=' +  plantiGraph.act.year + ']').addClass('act');
			$('#prods a[data-prod=' +  plantiGraph.act.prod + ']').addClass('act');

			$(plantiGraph.act.type).each(function(e, f){
				$('#type a[data-type=' +  f + ']').addClass('act');
			});

			$('#countrySelect').change(function(e) { 
				plantiGraph.countryPop.activa($('#countrySelect option:selected').attr('value'));
			});

			$('body').delegate('#frases li', 'click', function(){
				shareTweet($(this).text().slice(0, -1) + ' en el año ' + plantiGraph.act.year, 'http://www.eldiario.es/', 'pruebaHash', 'eldiarioes');
			})

		}
	},

	countryPop: {
		active: false,
		$elm: '#pop',
		$frases: '#frases',
		$graphLines: '#graphLines',
		$graphBars1: '#graphBars1',
		$graphBars2: '#graphBars2',

		init: function() {

			plantiGraph.countryPop.$elm = $(plantiGraph.countryPop.$elm);
			plantiGraph.countryPop.$frases = $(plantiGraph.countryPop.$frases);
			plantiGraph.countryPop.$graphLines = $(plantiGraph.countryPop.$graphLines).find('.inn');
			plantiGraph.countryPop.$graphBars1 = $(plantiGraph.countryPop.$graphBars1).find('.inn');
			plantiGraph.countryPop.$graphBars2 = $(plantiGraph.countryPop.$graphBars2).find('.inn');
			
			$('#closePop').click(plantiGraph.countryPop.hide);

			plantiGraph.viz.$wrap.delegate('.activaCountry', 'click', function(e){
				e.preventDefault();

				var $elm = $(this);
				var target = $elm.data('country');

				if(!target) throw 'No se encontró el pais clickado';

				plantiGraph.countryPop.activa(target);
			})
		},

		activa: function(countryKey) {
			
			plantiGraph.countryPop.clear();

			plantiGraph.tools.getdataCountry(countryKey);
			
			plantiGraph.countryPop.active = countryKey;
			
			plantiGraph.viz.$wrap.addClass('actPop');
		},

		draw: function(data) {

		  	var frases = plantiGraph.tools.getFrases(data);
		  	$.each(frases, function(e, f){
		  		plantiGraph.countryPop.$frases.append($('<li>' + f + '<i class="fa fa-twitter" aria-hidden="true"></i></li>'));
		  	});

		  	var topExp = plantiGraph.tools.getTop(data.actCountry.key, 'exp');
		  	var topImp = plantiGraph.tools.getTop(data.actCountry.key, 'imp');


		  	plantiGraph.countryPop.$graphBars1.append('<h4 style="text-transform: uppercase">Ranking de países <br>exportadores</h4><p style="margin-bottom: 0.8em">En millones de dolares</p>');

		  	var max = d3.max(topExp, function(e){ return e.data.val; });

		  	$.each(topExp, function(e, f){
		  		
		  		if(e == plantiGraph.graphsElms) plantiGraph.countryPop.$graphBars1.append('<li>....</li>');
		  		
		  		var val = f.data.val * 100 / max;console.log(val)
		  		
		  		var $elm = $('<li><a data-toggle="tooltip" href="#" class="activaCountry' + (f.data.key == data.actCountry.key ? ' activeBar' : '' ) +'" data-country="' + f.data.key + '"><span class="key">' + f.data.key + '</span><div class="bar" title="' + f.data.name + ' exportó ' + plantiGraph.tools.parseAmmount(f.data.val) + ' de ' + plantiGraph.act.prod + ' en el año ' + plantiGraph.act.year + '" data-width=""><span class="text">' + millionsParser(f.data.val) + '</span></div></a></li>');
		  		
		  		plantiGraph.countryPop.$graphBars1.append($elm);

		  		$elm.find('.bar').tooltip();
		  		$elm.find('.bar').stop(false, false).css('width', 0).animate({'width': val}, 1000);
		  		if(val < 40) $elm.find('.bar').addClass('bar-left');

		  	});


		  	plantiGraph.countryPop.$graphBars2.append('<h4 style="text-transform: uppercase">Ranking de países <br>importadores</h4><p style="margin-bottom: 0.8em">En millones de dolares</p>');

		  	var max = d3.max(topImp, function(e){ return e.data.val; });

		  	$.each(topImp, function(e, f){
		  		
		  		if(e == plantiGraph.graphsElms) plantiGraph.countryPop.$graphBars2.append('<li>....</li>');
		  		
		  		var val = f.data.val * 100 / max;
		  		
		  		var $elm = $('<li><a data-toggle="tooltip" href="#" class="activaCountry' + (f.data.key == data.actCountry.key ? ' activeBar' : '' ) +'" data-country="' + f.data.key + '"><span class="key">' + f.data.key + '</span><div class="bar"title="' + f.data.name + ' importó ' + plantiGraph.tools.parseAmmount(f.data.val) + ' de ' + plantiGraph.act.prod + ' en el año ' + plantiGraph.act.year + '"  data-width=""><span class="text">' + millionsParser(f.data.val) + '</span></div></a></li>');
		  		
		  		plantiGraph.countryPop.$graphBars2.append($elm);

		  		$elm.find('.bar').tooltip();
		  		$elm.find('.bar').stop(false, false).css('width', 0).animate({'width': val}, 1000);
		  		if(val < 40) $elm.find('.bar').addClass('bar-left');

		  	});


		  	plantiGraph.countryPop.$graphLines.append('<h4 style="text-transform: uppercase">Evolución importaciones y exportaciones de ' + plantiGraph.act.prod + '</h4><p style="margin-bottom: 0.8em">En millones de dolares</p>');

		  	var max = d3.max([d3.max(d3.entries(data.actCountry.resumen.exps), function(e){ console.log(e); return parseInt(e.value); }), d3.max(d3.entries(data.actCountry.resumen.imps), function(e){ return parseInt(e.value); })]);

		  	// plantiGraph.countryPop.$graphBars1.append('<h3>importaciones</h3>')
		  	// $.each(data.actCountry.resumen.imps, function(e, f){
		  	// 	plantiGraph.countryPop.$graphBars1.append($('<li>' + e + ' - ' + plantiGraph.tools.parseAmmount(f) + '</li>'));
		  	// });

		  	// $.each(data.actCountry.resumen.exps, function(e, f){
		  	// 	plantiGraph.countryPop.$graphBars1.append($('<li><span class="sigla">' + e + '</span>' + plantiGraph.tools.parseAmmount(f) + '</li>'));
		  	// });


		},

		hide: function() {
			plantiGraph.countryPop.active = null;
			plantiGraph.viz.$wrap.removeClass('actPop');
		},

		clear: function() {

			plantiGraph.countryPop.active = null;

			plantiGraph.countryPop.$frases.find('*').remove();
			plantiGraph.countryPop.$graphBars2.find('*').remove();
			plantiGraph.countryPop.$graphBars1.find('*').remove();
			plantiGraph.countryPop.$graphLines.find('*').remove();

		},

		update: function() {
			if(plantiGraph.countryPop.active) plantiGraph.countryPop.activa(plantiGraph.countryPop.active);
		}
	},

	evs: { // plantiGraph.evs.circInEnter


		desactivaCountry: function() {
		},

		circTooltip: function(d) {

			var posY = d.y;
			var posX = d.x - 100;
			var textoTT = '';
			
			if(plantiGraph.act.type.length == 2) {
				textoTT = '<strong>' + d.name + '</strong> exportó ' + plantiGraph.tools.parseAmmount(d.totalExp) + ' e importó ' + plantiGraph.tools.parseAmmount(d.totalImp) + ' de <strong>' + plantiGraph.act.prod + '</strong> en el año ' + plantiGraph.act.year;
				posY -= (d.rTot + 4);
			} else {
				if(plantiGraph.act.type.indexOf('imp') != -1) {
					textoTT = '<strong>' + d.name + '</strong> exportó ' + plantiGraph.tools.parseAmmount(d.totalExp) + ' de <strong>' + plantiGraph.act.prod + '</strong> en el año ' + plantiGraph.act.year;
					posY -= (d.rImp + 4);
				} else {
					textoTT = '<strong>' + d.name + '</strong> importó ' + plantiGraph.tools.parseAmmount(d.totalImp) + ' de <strong>' + plantiGraph.act.prod + '</strong> en el año ' + plantiGraph.act.year;
					posY -= (d.rExp + 4);
				}
			}

			posY = $('#graph').height() - posY;
			
			var $tooltip = $('<div class="tooltip top" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner">' + textoTT + '</div></div>')
			
			$tooltip.css({ bottom: posY, left: posX, }).appendTo('#graph')
			$tooltip.animate({opacity: 1}, 400);
		},

		linksEnter: function(d) {

			var posX = ((d.source.x + d.target.x) / 2) - 100;
			var posY = ((d.source.y + d.target.y) / 2) - 5;

			var textoTT = '<strong>' + d.source.name + '</strong> exportó ' + plantiGraph.tools.parseAmmount(d.val) +  ' de <strong>' + plantiGraph.act.prod + '</strong> a <strong>' + d.target.name + '</strong> en el año ' + plantiGraph.act.year;

			posY = $('#graph').height() - posY;
			
			var $tooltip = $('<div class="tooltip top" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner">' + textoTT + '</div></div>')
			
			$tooltip.css({ bottom: posY, left: posX, }).appendTo('#graph')
			$tooltip.animate({opacity: 1}, 400);
		},

		circExpEnter: function(d) {
			$('#graph .tooltip').remove();

			plantiGraph.viz.links
				.attr('class', function(e){
					return e.source.name == d.name || e.target.name == d.name ? 'link link-act' : 'link';
				});

			plantiGraph.evs.circTooltip(d);
		},

		circInEnter: function(d) {
			plantiGraph.viz.links
				.attr('class', function(e){
					return e.source.name == d.name || e.target.name == d.name ? 'link link-act' : 'link';
				});

			plantiGraph.evs.circTooltip(d);
		},

		circClick: function(d) {
			plantiGraph.countryPop.activa(d.key);
		},

		circOut: function(d){
			plantiGraph.viz.links
				.attr('class', 'link');

			$('#graph .tooltip').remove();
		},

		textVisibilityCheck: function(d) {
			if(plantiGraph.act.type.length == 2) {
				return d.rTot < 13 ? "hidden" : "visible";
			} else {
				if($.inArray('imp', plantiGraph.act.type) == -1) return d.rExp < 13 ? "hidden" : "visible";
				return d.rImp < 13 ? "hidden" : "visible";
			}
		},

		circImpVisibilityCheck: function(d) {
			if($.inArray('imp', plantiGraph.act.type) == -1) return "hidden";
	    	return (d.rImp <  (plantiGraph.maxCirc / 50)) ? "hidden" : "visible";
		},

		circImpRadius: function(d) {
			if(plantiGraph.act.type.length == 2) return d.rTotImp;
			else return d.rImp;
		},

		circExpVisibilityCheck: function(d) {
			if($.inArray('exp', plantiGraph.act.type) == -1) return "hidden";
	    	return (($.inArray('imp', plantiGraph.act.type) == -1 ? d.rExp : d.rT) <  (plantiGraph.maxCirc / 50)) ? "hidden" : "visible";
		},

		circExpRadius: function(d) {
			return ($.inArray('imp', plantiGraph.act.type) == -1) ? d.rExp : d.rTot;
		},

		collideRadiusFn: function(d) {
			if(plantiGraph.act.type.length == 2) {
				return d.rTot + 8;
			} else {
				if($.inArray('imp', plantiGraph.act.type) == -1) return d.rExp + 5;
				return d.rImp + 5;
			}
			return d.rTot + 5;
		},

		changeProduct: function(e) {
			
			e.preventDefault();
			
			$('#prods .act').removeClass('act');

			var prod = $(this).addClass('act').data('prod');
			if(!prod || plantiGraph.act.prod == prod) { console.log('no hay producto'); return; };

			plantiGraph.act.prod = prod;

				// carga datos nuevos y pinta
			plantiGraph.tools.update();
		},

		gotoYear: function(year) {

			if(!year || plantiGraph.act.year == year || year > 2014 || year < 2004) return;

			plantiGraph.act.year = year;
			
			$('#years .act').removeClass('act');
			$('#years .disabled').removeClass('disabled');
			$('#years [data-year="' + year + '"]').addClass('act');

			if(year == 2014) $('#years .nextYear').addClass('disabled');
			if(year == 2004) $('#years .prevYear').addClass('disabled');

				// actualiza el dibujo
			plantiGraph.tools.update();
		},

		changeYear: function(e) {
			
			e.preventDefault();

			plantiGraph.evs.gotoYear($(this).data('year'));
		},

		prevYear: function(e) {
			
			e.preventDefault();

			if(plantiGraph.act.year == 2004) return;

			plantiGraph.evs.gotoYear(plantiGraph.act.year - 1);

		},

		nextYear: function(e) {
			
			e.preventDefault();

			if(plantiGraph.act.year == 2014) return;

			plantiGraph.evs.gotoYear(plantiGraph.act.year + 1);
		},

		changeType: function(e) {
			
			e.preventDefault();

			var $this = $(this);
			var type = $this.data('type');

				// ya activado => desactiva
			if($.inArray(type, plantiGraph.act.type) != -1){
					
					// para no quedarnos a 0
				if(plantiGraph.act.type.length < 2) return;

				$this.removeClass('act');
				plantiGraph.act.type.splice(plantiGraph.act.type.indexOf(type), 1);

				// no activado => activa
			} else {

				$this.addClass('act');
				plantiGraph.act.type.push(type);
			}

				// actualiza el dibujo
			plantiGraph.tools.update();

		}
	},

};

plantiGraph.init();

function throttle (callback, limit) {   // http://sampsonblog.com/749/simple-throttle-function modificado!
    var wait = false;                 // Initially, we're not waiting
    return function () {              // We return a throttled function
        if (!wait) {                  // If we're not waiting
                                       // Execute users function
            wait = true;              // Prevent future invocations
            setTimeout(function () {  // After a period of time
                callback.call();
                wait = false;         // And allow future invocations
            }, limit);
        }
    }
}

function numberThousandsDots (number) {
 	return number.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1.");
};

function firstCapital(string) {
	return string.charAt(0).toUpperCase() + string.slice(1);
};

function millionsParser (ammount) {
	var data = ammount / 1000000;
	if(data > 1) return numberThousandsDots(parseInt(data));
	return data.toFixed(2);
}


function shareTweet (texto, url, hash, via) {
    if(!texto) return false;

    var windowOptions = 'scrollbars=yes,resizable=yes,toolbar=no,location=yes',
        width = 550,
        height = 420,
        winHeight = screen.height,
        winWidth = screen.width;

    var left = Math.round((winWidth / 2) - (width / 2));
    var top = 0;

    if (winHeight > height) {
      top = Math.round((winHeight / 2) - (height / 2));
    }

    var target = 'https://twitter.com/intent/tweet?text=' + texto
    if(url && url != false) {
    	target += '&url=' + clearUrl(url);
    } else if (url != false) { target += '&url=' + encodeURIComponent(window.location.href); }
    
    if(hash) target += '&hashtags=' + hash;
    if(via) target += '&via=' + via;

    window.open(target, 'intent', windowOptions + ',width=' + width +
                                       ',height=' + height + ',left=' + left + ',top=' + top);

    function clearUrl(url) {
    	if(url.indexOf('#') != -1) url = url.substring(0, url.indexOf('#'));
    	if(url.indexOf('?') != -1) url = url.substring(0, url.indexOf('?'));
    	return url;
    }
};


// function shareFacebook (url) {

//     var windowOptions = 'scrollbars=yes,resizable=yes,toolbar=no,location=yes',
//         width = 550,
//         height = 420,
//         winHeight = screen.height,
//         winWidth = screen.width;

//     var left = Math.round((winWidth / 2) - (width / 2));
//     var top = 0;

//     if (winHeight > height) {
//       top = Math.round((winHeight / 2) - (height / 2));
//     }

//     var target = 'https://www.facebook.com/sharer/sharer.php?app_id=435567026494540&u=' + url
//     window.open(target, 'intent', windowOptions + ',width=' + width +
//                                        ',height=' + height + ',left=' + left + ',top=' + top);

// };

</script>
</body>
</html>