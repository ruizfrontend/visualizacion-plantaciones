// http://latierraesclava.eldiario.es/ Copyright @eldiarioes 2017
// Visualización @ruizfrontend
function throttle(t,a){var e=!1
return function(){e||(e=!0,setTimeout(function(){t.call(),e=!1},a))}}function numberThousandsDots(t){return(""+t).replace(/(d)(?=(ddd)+(?!d))/g,"$1.")}function firstCapital(t){return t.charAt(0).toUpperCase()+t.slice(1)}function millionsParser(t){var a=t/1e6
return a>1?numberThousandsDots(parseInt(a,10)):a.toFixed(2).replace(".",",")}function shareTweet(t,a,e,r){function p(t){return-1!=t.indexOf("#")&&(t=t.substring(0,t.indexOf("#"))),-1!=t.indexOf("?")&&(t=t.substring(0,t.indexOf("?"))),t}if(!t)return!1
var o="scrollbars=yes,resizable=yes,toolbar=no,location=yes",n=550,i=420,s=screen.height,c=screen.width,l=Math.round(c/2-n/2),d=0
s>i&&(d=Math.round(s/2-i/2))
var u="https://twitter.com/intent/tweet?text="+encodeURIComponent(t)
a&&a!==!1?u+="&url="+p(a):a!==!1&&(u+="&url="+encodeURIComponent(window.location.href)),e&&(u+="&hashtags="+encodeURIComponent(e)),r&&(u+="&via="+encodeURIComponent(r)),window.open(u,"intent",o+",width="+n+",height="+i+",left="+l+",top="+d)}var pG={pathData:"http://estaticos.lab.eldiario.es/estaticos/plantaciones/",pathPaises:"paisesTot.json",pathQuery:"?mls3",act:{year:2014,prod:"cafe",type:["imp","exp"]},breakPoint:800,breakPointClass:"fullGraph",breakPointSmallScreen:null,maxCircProp:25,maxCirc:null,maxLineProp:70,maxLine:null,minLineProp:10,minLine:null,minCircProp:15,minCirc:null,maxWidthText:13,maxWidthTextMovil:11,textYOffsetMovil:3,textYOffset:5,initYear:1995,lastYear:2014,graphsElms:5,viz:{width:0,height:0,$wrap:"#pG",$elm:"#viz",svg:null,projection:null,path:null,map:null,circImp:null,circExp:null,texts:null,force:null,scale:{circImp:null,circExp:null,circImpExp:null,lines:null}},data:{countries:null,yearTopExp:null,yearTopImp:null,totalExp:null,totalImp:null},txt:{articulos:{cafe:"el café",aceite:"el aceite de palma",cacao:"el cacao",banana:"el banano",azucar:"el azúcar"},productos:{cafe:"café",aceite:"aceite de palma",cacao:"cacao",banana:"banano",azucar:"azúcar"}},init:function(){pG.viz.svg=d3.select(pG.viz.$elm),pG.viz.$elm=$(pG.viz.$elm),pG.viz.$wrap=$(pG.viz.$wrap),pG.countryPop.init(),pG.tools.initJqueries(),$(window).bind("orientationchange resize",throttle(pG.tools.handleResize,300)).resize()},tools:{handleResize:function(){pG.tools.loadCountries(),pG.tools.updateProjection(),pG.tools.update()},updateProjection:function(){if(pG.viz.width=$(window).width(),pG.viz.height=pG.viz.width/2,pG.viz.width<pG.breakPoint?($("#blur").remove(),pG.viz.height=pG.viz.width/1.4,pG.viz.$wrap.removeClass(pG.breakPointClass),pG.breakPointSmallScreen=!0):(pG.viz.$wrap.addClass(pG.breakPointClass),pG.viz.width=pG.viz.width-300,pG.viz.height=pG.viz.width/2,pG.breakPointSmallScreen=!1),pG.viz.$elm.css({width:pG.viz.width,height:pG.viz.height}),pG.viz.projection=d3.geoMercator().scale(170*(pG.viz.width/1e3)).translate([pG.viz.width/2-pG.viz.width/14,pG.viz.height/2+pG.viz.height/5]).precision(51),pG.viz.path=d3.geoPath().projection(pG.viz.projection),pG.data.prod)for(var t=0;t<pG.data.prod.length;t++)pG.data.prod[t].x=pG.viz.projection([pG.data.prod[t].lon,pG.data.prod[t].lat])[0],pG.data.prod[t].y=pG.viz.projection([pG.data.prod[t].lon,pG.data.prod[t].lat])[1]
pG.maxCirc=parseInt(pG.viz.width/pG.maxCircProp,10),pG.minCirc=Math.ceil(pG.maxCirc/pG.minCircProp),pG.maxLine=parseInt(pG.viz.width/pG.maxLineProp,10),pG.minLine=pG.maxLine/pG.minLineProp},loadCountries:function(t){d3.json(pG.pathData+pG.pathPaises+pG.pathQuery,function(a,e){if(a)throw a
var r=[],p=[]
for(var o in e)if(e.hasOwnProperty(o)){var n=e[o]
n.key=o,n.posX=pG.viz.projection([n.lon,n.lat])[0],n.posY=pG.viz.projection([n.lon,n.lat])[1],n.x=n.posX,n.y=n.posY,r.push(n),n.x&&n.y&&p.push({value:n.name,data:{id:n.name,key:n.key}})}$("#countryImput").autocomplete({lookup:p,minChars:3,orientation:"bottom",autoSelectFirst:!0,showNoSuggestionNotice:!0,noSuggestionNotice:"No se encontraron coincidencias",groupBy:"p",onSelect:function(t){pG.countryPop.activa(t.data.key)}}),pG.data.countries=r,t&&t()})},update:function(){d3.json(pG.pathData+pG.act.prod+".json"+pG.pathQuery,function(t,a){if(t)throw t
pG.data.countries||pG.tools.loadCountries(function(){pG.tools.processData(a)}),pG.tools.processData(a),pG.countryPop.update()})},getCountry:function(t){for(var a=0;a<pG.data.countries.length;a++)if(pG.data.countries[a].key==t)return pG.data.countries[a]
return!1},getdataCountry:function(t){d3.json(pG.pathData+pG.act.prod+".json"+pG.pathQuery,function(a,e){function r(t){for(var a=[],e=0;e<t.length;e++)a.push({data:{name:pG.tools.getCountry(t[e].key).name,key:t[e].key,val:t[e].val},pos:e})
return a}if(a)throw a
var p={actCountry:null,expByYear:[],impByYear:[]}
if(1==pG.act.type.length){if(-1!=pG.act.type.indexOf("exp")){var o=[]
for(var n in e[pG.act.year][t])e[pG.act.year][t].hasOwnProperty(n)&&o.push({key:n,val:e[pG.act.year][t][n]})
o.sort(function(t,a){return d3.descending(t.val,a.val)}),p.exports=r(o.slice(0,5))}if(-1!=pG.act.type.indexOf("imp")){var i=[]
for(var s in e[pG.act.year])e[pG.act.year].hasOwnProperty(s)&&e[pG.act.year][s][t]&&i.push({key:s,val:e[pG.act.year][s][t]})
i.sort(function(t,a){return d3.descending(t.val,a.val)}),p.imports=r(i.slice(0,5))}}for(var c=pG.data.countries.length-1;c>=0;c--)pG.data.countries[c].key==t&&(p.actCountry=pG.data.countries[c])
if(!p.actCountry)throw"No se encontró el pais activo"
for(var l=pG.initYear;l<=pG.lastYear;l++){p.expByYear[l]=0,p.impByYear[l]=0
for(var c=pG.data.countries.length-1;c>=0;c--)if(pG.data.countries[c].key==t)for(var d=pG.data.countries.length-1;d>=0;d--)e[l][t]&&e[l][t][pG.data.countries[d].key]&&(p.impByYear[l]+=e[l][t][pG.data.countries[d].key])
else e[l][pG.data.countries[c].key]&&e[l][pG.data.countries[c].key][t]&&(p.expByYear[l]+=e[l][pG.data.countries[c].key][t])}pG.countryPop.draw(p)})},getTop:function(t,a){for(var e=[],r="imp"==a?pG.data.yearTopImp:pG.data.yearTopExp,p=!1,o=0;o<pG.graphsElms;o++)r[o].key==t&&(p=!0),e.push({data:r[o],pos:o})
if(p)return e
for(var o=r.length-1;o>=0;o--)if(r[o].key==t)return e.push({data:r[o],pos:o}),e},getFrases:function(t){var a=t.actCountry.name,e=[]
if(2==pG.act.type.length){var r=t.actCountry.totalExp-t.actCountry.totalImp,p=pG.tools.getPosition(t,"imp"),o=pG.tools.getPosition(t,"exp")
r>0?e.push("<strong>"+a+"</strong> exportó <strong>"+pG.tools.parseAmmount(r)+" más</strong> en <strong>"+pG.txt.productos[pG.act.prod]+"</strong> de los que importó."):e.push("<strong>"+a+"</strong> importó <strong>"+pG.tools.parseAmmount(-1*r)+" más</strong> en <strong>"+pG.txt.productos[pG.act.prod]+"</strong> de los que exportó."),e.push("<strong>"+a+"</strong> ocupa el puesto número <strong>"+o+"</strong> de países exportadores y el puesto número <strong>"+p+"</strong> de paises importadores de <strong>"+pG.txt.productos[pG.act.prod]+"</strong>.")}else if(-1!=pG.act.type.indexOf("imp")){var n=pG.tools.fixPosition(pG.tools.getPosition(t,"imp")),i=100*t.actCountry.totalImp/pG.data.totalImp,s=100*t.actCountry.totalImp/t.actCountry.resumen.imps[pG.act.year]
e.push("<strong>"+a+"</strong> ocupa el <strong>"+n+" puesto</strong> en el ranking de países importadores de <strong>"+pG.txt.productos[pG.act.prod]+"</strong>."),e.push("<strong>"+a+"</strong> controla el <strong>"+i.toFixed(1).replace(".",",")+"%</strong> de las importaciones mundiales de <strong>"+pG.txt.productos[pG.act.prod]+"</strong>."),e.push("<strong>"+firstCapital(pG.txt.articulos[pG.act.prod])+"</strong> supone el "+s.toFixed(1).replace(".",",")+"% de las importaciones de <strong>"+a+"</strong>, "+pG.tools.parseAmmount(t.actCountry.totalImp)+"</strong>.")}else{var c=pG.tools.fixPosition(pG.tools.getPosition(t,"exp")),l=100*t.actCountry.totalExp/pG.data.totalExp,d=100*t.actCountry.totalExp/t.actCountry.resumen.exps[pG.act.year]
e.push("<strong>"+a+"</strong> ocupa el <strong>"+c+" puesto</strong> en el ranking de países exportadores de <strong>"+pG.txt.productos[pG.act.prod]+"</strong>."),e.push("<strong>"+a+"</strong> controla el <strong>"+l.toFixed(1).replace(".",",")+"%</strong> de las exportaciones mundiales de <strong>"+pG.txt.productos[pG.act.prod]+"</strong>."),e.push("<strong>"+firstCapital(pG.txt.articulos[pG.act.prod])+"</strong> supone el "+d.toFixed(1).replace(".",",")+"% de las exportaciones de <strong>"+a+"</strong>, "+pG.tools.parseAmmount(t.actCountry.totalExp)+".")}return e},parseAmmount:function(t){return t/1e6>1?numberThousandsDots(Math.round(t/1e6))+" millones de dólares":numberThousandsDots(t)+" dólares"},fixPosition:function(t){switch(t){case 1:return"primer"
case 2:return"segundo"
case 3:return"tercer"
default:return t+"º"}},getPosition:function(t,a){if("imp"==a){for(var e=pG.data.yearTopImp.length-1;e>=0;e--)if(pG.data.yearTopImp[e].key==t.actCountry.key)return e+1}else for(var e=pG.data.yearTopExp.length-1;e>=0;e--)if(pG.data.yearTopExp[e].key==t.actCountry.key)return e+1
return null},processData:function(t){for(var a=pG.data.countries,e=t[pG.act.year],r=[],p=[],o={exp:[],imp:[]},n=a.length-1;n>=0;n--)a[n].totalImp=0,a[n].totalExp=0
for(var i=[],s=0,n=a.length-1;n>=0;n--)if(e[a[n].key])for(var c=a.length-1;c>=0;c--)if(e[a[n].key][a[c].key]){var l=e[a[n].key][a[c].key]
a[n].totalExp+=l,a[c].totalImp+=l,i.push(l),l>s&&(s=l),p.push({source:a[n],target:a[c],val:l})}for(var n=0;n<p.length;n++)p[n].val>s/1e3&&r.push(p[n])
pG.data.totalExp=0,pG.data.totalImp=0
for(var n=a.length-1;n>=0;n--)pG.data.totalExp+=a[n].totalExp,pG.data.totalImp+=a[n].totalImp,o.imp.push({key:a[n].key,val:a[n].totalImp,name:a[n].name}),o.exp.push({key:a[n].key,val:a[n].totalExp,name:a[n].name})
for(var d=[],u=[],G=[],n=a.length-1;n>=0;n--)a[n].totalImp>0&&d.push(a[n].totalImp),a[n].totalExp>0&&u.push(a[n].totalExp),a[n].totalImp+a[n].totalExp>0&&G.push(a[n].totalImp+a[n].totalExp)
pG.data.yearTopExp=o.exp.sort(function(t,a){return d3.descending(t.val,a.val)}),pG.data.yearTopImp=o.imp.sort(function(t,a){return d3.descending(t.val,a.val)}),pG.viz.scale.circImp=d3.scalePow().exponent(.5).domain([0,d3.max(d)]).range([0,pG.maxCirc]),pG.viz.scale.circExp=d3.scalePow().exponent(.5).domain([0,d3.max(u)]).range([0,pG.maxCirc]),pG.viz.scale.circImpExp=d3.scalePow().exponent(.5).domain([0,d3.max(G)]).range([0,pG.maxCirc]),pG.viz.scale.lines=d3.scalePow().exponent(.9).domain([0,d3.max(i)]).range([0,pG.maxLine])
for(var n=a.length-1;n>=0;n--)a[n].rTot=pG.viz.scale.circImpExp(a[n].totalImp+a[n].totalExp),a[n].rTotImp=pG.viz.scale.circImpExp(a[n].totalImp),a[n].rTotExp=pG.viz.scale.circImpExp(a[n].totalExp),a[n].rImp=pG.viz.scale.circImp(a[n].totalImp),a[n].rExp=pG.viz.scale.circExp(a[n].totalExp)
pG.viz.circsImp?(pG.viz.links.remove(),pG.viz.links=pG.viz.svg.select(".linksWrap").selectAll(".link").data(r).enter().append("line").attr("class",pG.evs.linksClass).attr("stroke-width",function(t){return pG.viz.scale.lines(t.val)}).on("mouseenter",pG.evs.linksEnter).on("mouseout",pG.evs.circOut)):(pG.viz.links=pG.viz.svg.append("g").attr("class","linksWrap").selectAll(".link").data(r).enter().append("line").attr("class",pG.evs.linksClass).attr("stroke-width",function(t){return pG.viz.scale.lines(t.val)}).on("mouseenter",pG.evs.linksEnter).on("mouseout",pG.evs.circOut),pG.viz.circExp=pG.viz.svg.append("g").attr("class","circExpWrap").selectAll(".circExp").data(a).enter().append("circle").attr("class","circExp").on("mouseenter",pG.evs.circExpEnter).on("mousedown",pG.evs.circClick).on("mouseout",pG.evs.circOut),pG.viz.circsImp=pG.viz.svg.append("g").attr("class","circImpWrap").selectAll(".circImp").data(a).enter().append("circle").attr("class","circImp").on("mouseenter",pG.evs.circInEnter).on("mousedown",pG.evs.circClick).on("mouseout",pG.evs.circOut),pG.viz.texts=pG.viz.svg.append("g").attr("class","textsWrap").selectAll(".text").data(a).enter().append("text").attr("class","text").text(function(t){return t.key.toUpperCase()})),pG.viz.links.data(r).attr("stroke-width",function(t){return pG.viz.scale.lines(t.val)}).attr("class",pG.evs.linksClass).attr("visibility",pG.evs.linksVisibilityCheck).attr("opacity",0).transition().duration(500).attr("opacity",1),pG.viz.circsImp.data(a).attr("visibility",pG.evs.circImpVisibilityCheck).attr("r",pG.evs.circImpRadius).attr("cx",function(t){return t.posX?t.x:void 0}).attr("cy",function(t){return t.posY?t.y:void 0}),pG.viz.circExp.data(a).attr("visibility",pG.evs.circExpVisibilityCheck).attr("r",pG.evs.circExpRadius).attr("cx",function(t){return t.posX?t.x:void 0}).attr("cy",function(t){return t.posY?t.y:void 0}),pG.viz.texts.data(a).attr("visibility",pG.evs.textVisibilityCheck).attr("x",function(t){return t.posX?t.x:void 0}).attr("y",function(t){return t.posY?t.y+(pG.breakPointSmallScreen?3:5):void 0}),pG.viz.force=d3.forceSimulation(a).force("link",d3.forceLink(r).strength(1e-13)).force("collide",d3.forceCollide().radius(pG.evs.collideRadiusFn).iterations(6).strength(1.2)).alphaDecay(pG.breakPointSmallScreen?.8:.6).velocityDecay(.7).on("tick",pG.tools.tick)},tick:function(){pG.viz.circsImp.attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}),pG.viz.circExp.attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}),pG.viz.links.attr("x1",function(t){return t.source.x}).attr("x2",function(t){return t.target.x}).attr("y1",function(t){return t.source.y}).attr("y2",function(t){return t.target.y}).attr("class",pG.evs.linksClass).attr("visibility",pG.evs.linksVisibilityCheck),pG.viz.texts.attr("x",function(t){return t.x}).attr("y",function(t){return t.y+(pG.breakPointSmallScreen?pG.textYOffset:pG.textYOffset)})},initJqueries:function(){$("#years").find(".gotoYear").click(pG.evs.changeYear).end().find(".nextYear").click(pG.evs.nextYear).end().find(".prevYear").click(pG.evs.prevYear),$("#prods a").click(pG.evs.changeProduct),$("#type a").click(pG.evs.changeType),$("#activeYear").html(pG.act.year),$("#prods a[data-prod="+pG.act.prod+"]").addClass("act"),$(pG.act.type).each(function(t,a){$("#type a[data-type="+a+"]").addClass("act")}),$("body").delegate("#frases li","click",function(){return shareTweet($(this).text().slice(0,-1)+" en "+pG.act.year,"http://latierraesclava.eldiario.es/", "latierraesclava", "eldiarioes"),!1}).delegate("#searchSelected a","click",function(){return pG.countryPop.hide(),!1})}},countryPop:{active:!1,$elm:"#pop",$frases:"#frases",$graphLines:"#graphLines",$graphBars1:"#graphBars1",$graphBars2:"#graphBars2",init:function(){pG.countryPop.$elm=$(pG.countryPop.$elm),pG.countryPop.$frases=$(pG.countryPop.$frases),pG.countryPop.$graphLines=$(pG.countryPop.$graphLines).find(".inn"),pG.countryPop.$graphBars1=$(pG.countryPop.$graphBars1).find(".inn"),pG.countryPop.$graphBars2=$(pG.countryPop.$graphBars2).find(".inn"),$("#closePop").click(pG.countryPop.hide),pG.viz.$wrap.delegate(".activaCountry","click",function(t){t.preventDefault()
var a=$(this),e=a.data("country")
if(!e)throw"No se encontró el pais clickado"
pG.countryPop.activa(e)}).delegate(".activaYear","click",function(t){t.preventDefault()
var a=$(this),e=a.data("year")
if(!e)throw"No se encontró el año clickado"
pG.evs.gotoYear(e)})},activa:function(t){pG.countryPop.clear()
pG.tools.getdataCountry(t)
pG.countryPop.active=t,$("#searchHelp").hide(),pG.viz.$wrap.addClass("actPop"),pG.breakPointSmallScreen||(setTimeout(function(){pG.countryPop.activaHover(t)},100),d3.selectAll("feGaussianBlur").transition().attr("stdDeviation",4))},activaHover:function(t){for(var a=0;a<pG.data.countries.length;a++)if(pG.data.countries[a].key==t)return void pG.evs.circsHover(pG.data.countries[a])},hide:function(){pG.countryPop.active=null,pG.viz.$wrap.removeClass("actPop"),pG.countryPop.clear(),pG.breakPointSmallScreen||(d3.selectAll("feGaussianBlur").transition().attr("stdDeviation",0),pG.evs.circOut())},clear:function(){pG.countryPop.active=null,pG.countryPop.$frases.find("*").remove(),pG.countryPop.$graphBars2.find("*").remove(),pG.countryPop.$graphBars1.find("*").remove(),pG.countryPop.$graphLines.find("*").remove(),pG.countryPop.$graphLines.append("<svg></svg>"),$("#searchHelp").show(),$("#searchSelected").hide().html("")},update:function(){pG.countryPop.active&&pG.countryPop.activa(pG.countryPop.active)},draw:function(t){var a=pG.tools.getFrases(t)
$.each(a,function(t,a){pG.countryPop.$frases.append($("<li>"+a+'<i class="fa fa-twitter" aria-hidden="true"></i></li>'))}),$("#searchSelected").show().html('<a href="#" class="clearPop">'+t.actCountry.name+"</a>"),pG.breakPointSmallScreen||(pG.countryPop.drawEvol(pG.countryPop.$graphLines,t),2==pG.act.type.length?(pG.countryPop.drawBarras(pG.tools.getTop(t.actCountry.key,"exp"),t,pG.countryPop.$graphBars1,"exp"),pG.countryPop.drawBarras(pG.tools.getTop(t.actCountry.key,"imp"),t,pG.countryPop.$graphBars2,"imp")):-1==$.inArray("imp",pG.act.type)?(pG.countryPop.drawBarras(pG.tools.getTop(t.actCountry.key,"exp"),t,pG.countryPop.$graphBars1,"exp"),pG.countryPop.drawBarras(t.exports,t,pG.countryPop.$graphBars2,"expInternal")):(pG.countryPop.drawBarras(pG.tools.getTop(t.actCountry.key,"imp"),t,pG.countryPop.$graphBars1,"imp"),pG.countryPop.drawBarras(t.imports,t,pG.countryPop.$graphBars2,"impInternal")))},drawBarras:function(t,a,e,r){switch(r){case"exp":e.addClass("graphBarsExp").append('<h4 style="text-transform: uppercase">Ranking de países <br>exportadores</h4><p style="margin-bottom: 0.8em">En millones de dolares</p>')
break
case"imp":e.addClass("graphBarsImp").append('<h4 style="text-transform: uppercase">Ranking de países <br>importadores</h4><p style="margin-bottom: 0.8em">En millones de dolares</p>')
break
case"expInternal":e.addClass("graphBarsImp").append('<h4 style="text-transform: uppercase">Principales paises<br>a los que exporta</h4><p style="margin-bottom: 0.8em">En millones de dolares</p>')
break
case"impInternal":e.addClass("graphBarsImp").append('<h4 style="text-transform: uppercase">Principales paises<br>de los que importa</h4><p style="margin-bottom: 0.8em">En millones de dolares</p>')}var p=d3.max(t,function(t){return t.data.val})
$.each(t,function(t,o){t==pG.graphsElms&&pG.countryPop.$graphBars1.append("<li>....</li>")
var n=null
n="exp"==r||"imp"==r?$('<li><a data-toggle="tooltip" href="#" class="activaCountry'+(o.data.key==a.actCountry.key?" activeBar":"")+'" data-country="'+o.data.key+'"><span class="key">'+o.data.key+'</span><div class="bar" title="'+o.data.name+("imp"==r?" importó ":" exportó ")+pG.tools.parseAmmount(o.data.val)+" de "+pG.txt.productos[pG.act.prod]+" en "+pG.act.year+'" data-width=""><span class="text">'+millionsParser(o.data.val)+"</span></div></a></li>"):$('<li><a data-toggle="tooltip" href="#" class="activaCountry'+(o.data.key==a.actCountry.key?" activeBar":"")+'" data-country="'+o.data.key+'"><span class="key">'+o.data.key+'</span><div class="bar" title="'+a.actCountry.name+("impInternal"==r?" importó ":" exportó ")+pG.tools.parseAmmount(o.data.val)+" de "+pG.txt.productos[pG.act.prod]+("impInternal"==r?" de ":" a ")+o.data.name+" en "+pG.act.year+'" data-width=""><span class="text">'+millionsParser(o.data.val)+"</span></div></a></li>"),e.append(n)
var i=100*o.data.val/p
n.find(".bar").tooltip(),n.find(".bar").stop(!1,!1).css("width",0).animate({width:i},1e3),40>i&&n.find(".bar").addClass("bar-left")})},drawEvol:function(t,a){t.prepend('<h4 style="text-transform: uppercase">Evolución importaciones y exportaciones de '+pG.txt.productos[pG.act.prod]+'</h4><p style="margin-bottom: 0.8em">En millones de dolares</p>')
var e=d3.max([d3.max(d3.entries(a.expByYear),function(t){return parseInt(t.value,10)}),d3.max(d3.entries(a.impByYear),function(t){return parseInt(t.value,10)})]),r=30,p=5,o=210,n=.6*o,i=d3.scaleLinear().domain([0,e]).range([n,0]),s=d3.axisLeft(i).ticks(4).tickSize(0).tickFormat(function(t){return parseInt(t/1e6,10)}),c=pG.lastYear-pG.initYear,l=(o-r)/c,d="M"+r+" "+(n+p)+" L",u="M",G="M"+r+" "+(n+p)+" L",v="M",m="M"+r+" "+(n+p)+" L",y="M",h=d3.select(t.find("svg")[0]).attr("width",o+3).attr("height",n+2*p)
h.append("g").attr("transform","translate("+(r-5)+" ,"+p+")").attr("class","axes").call(s)
for(var g=h.append("g").attr("class","lines"),f=h.append("g").attr("class","dots"),x=0;c>=x;x++){var k=r+l*x,$=p+i(a.expByYear[pG.initYear+x]),P=p+i(a.impByYear[pG.initYear+x])
d+=k+" "+(n+p)+" L",u+=k+" "+(n+p)+" L",G+=k+" "+P+" L",v+=k+" "+P+" L",m+=k+" "+$+" L",y+=k+" "+$+" L",f.append("circle").attr("class","circLinesWhite").attr("cx",k).attr("cy",$).attr("r",4).attr("opacity",0).transition().duration(2e3).attr("opacity",1),f.append("circle").on("mouseenter",pG.evs.circGraphTooltip).on("mouseout",pG.evs.circGraphTooltipOut).attr("class","circLines linesExp activaYear"+(pG.initYear+x==pG.act.year?" linesExpFill":"")).attr("data-year",pG.initYear+x).attr("cx",k).attr("cy",$).attr("r",3).attr("stroke","#126567").attr("title",a.actCountry.name+" importó "+pG.tools.parseAmmount(a.expByYear[pG.initYear+x])+" de "+pG.txt.productos[pG.act.prod]+" en "+(pG.initYear+x)+".").attr("opacity",0).transition().duration(2e3).attr("opacity",1),f.append("circle").attr("class","circLinesWhite").attr("cx",k).attr("cy",P).attr("r",4).attr("opacity",0).transition().duration(2e3).attr("opacity",1),f.append("circle").on("mouseenter",pG.evs.circGraphTooltip).on("mouseout",pG.evs.circGraphTooltipOut).attr("class","circLines linesImp activaYear"+(pG.initYear+x==pG.act.year?" linesImpFill":"")).attr("data-year",pG.initYear+x).attr("cx",k).attr("cy",P).attr("r",3).attr("title",a.actCountry.name+" exportó "+pG.tools.parseAmmount(a.impByYear[pG.initYear+x])+" de "+pG.txt.productos[pG.act.prod]+" en "+(pG.initYear+x)+".").attr("opacity",0).transition().duration(2e3).attr("opacity",1)}d+=r+o+" "+(n+p)+" L"+r+" 0 Z",G+=r+o+" "+(n+p)+" Z",m+=r+o+" "+(n+p)+" Z",g.append("path").attr("d",d).attr("stroke","none").attr("fill","rgba(211, 93, 51, 0.1)").transition().duration(1e3).attr("d",G),g.append("path").attr("d",d).attr("stroke","none").attr("fill","rgba(150, 203, 81, 0.1)").transition().duration(1e3).attr("d",m),g.append("path").attr("d",u.slice(0,-1)).attr("stroke","rgb(211, 93, 51)").attr("stroke-width","1").attr("fill","none").transition().duration(1e3).attr("d",v.slice(0,-1)),g.append("path").attr("d",u.slice(0,-1)).attr("stroke","#126567").attr("stroke-width","1").attr("fill","none").transition().duration(1e3).attr("d",y.slice(0,-1))}},evs:{circGraphTooltipOut:function(){$("#pop .tooltip").remove()},circGraphTooltip:function(t,a){var e=$(this),r=$("#pop"),p=e.offset().left-r.offset().left,o=r.height()-(e.offset().top-r.offset().top),n=$('<div class="tooltip top" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner">'+e.attr("title")+"</div></div>")
n.css({bottom:o,left:p-98}),r.append(n),n.animate({opacity:1},400)},circTooltip:function(t){var a=t.y,e=t.x-100,r=""
2==pG.act.type.length?(r="<strong>"+t.name+"</strong> exportó "+pG.tools.parseAmmount(t.totalExp)+" e importó "+pG.tools.parseAmmount(t.totalImp)+" de <strong>"+pG.txt.productos[pG.act.prod]+"</strong> en "+pG.act.year,a-=t.rTot+4):-1!=pG.act.type.indexOf("exp")?(r="<strong>"+t.name+"</strong> exportó "+pG.tools.parseAmmount(t.totalExp)+" de <strong>"+pG.txt.productos[pG.act.prod]+"</strong> en "+pG.act.year,a-=t.rExp+4):(r="<strong>"+t.name+"</strong> importó "+pG.tools.parseAmmount(t.totalImp)+" de <strong>"+pG.txt.productos[pG.act.prod]+"</strong> en "+pG.act.year,a-=t.rImp+4),a=$("#graph").height()-a
var p=$('<div class="tooltip top" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner">'+r+"</div></div>")
p.css({bottom:a,left:e}).appendTo("#graph"),p.animate({opacity:1},400)},linksClass:function(t){return t.source.x>t.target.x?"link":"link link-left"},linksEnter:function(t){return pG.breakPointSmallScreen?!1:(pG.evs.linesHover(t),void pG.evs.linesTooltip(t))},linesHover:function(t){$("#graph").addClass("hover"),pG.viz.links.attr("class",function(a){var e=a.source.x>a.target.x?"link":"link link-left"
return a==t?e+" linkAct":e}),pG.viz.circExp.attr("class",function(a){return t.target==a||t.source==a?"circExp circExpAct":"circExp"}),pG.viz.circsImp.attr("class",function(a){return t.target==a||t.source==a?"circImp circImpAct":"circImp"})},linesTooltip:function(t){var a=(t.source.x+t.target.x)/2-100,e=(t.source.y+t.target.y)/2-5,r="<strong>"+t.source.name+"</strong> exportó "+pG.tools.parseAmmount(t.val)+" de <strong>"+pG.txt.productos[pG.act.prod]+"</strong> a <strong>"+t.target.name+"</strong> en "+pG.act.year
e=$("#graph").height()-e
var p=$('<div class="tooltip top" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner">'+r+"</div></div>")
p.css({bottom:e,left:a}).appendTo("#graph"),p.animate({opacity:1},400)},circsHover:function(t){$("#graph").addClass("hover"),pG.viz.circExp.attr("class",function(a){if(a.key==t.key)return"circExp circExpAct"
var e=!1
return pG.viz.links.each(function(r){r.source.key==t.key&&r.target.key==a.key&&pG.viz.scale.lines(r.val)>pG.minLine&&(e=!0),r.source.key==a.key&&r.target.key==t.key&&pG.viz.scale.lines(r.val)>pG.minLine&&(e=!0)}),e?"circExp circExpAct":"circExp"}),pG.viz.circsImp.attr("class",function(a){if(a.key==t.key)return"circImp circImpAct"
var e=!1
return pG.viz.links.each(function(r){r.source.key==t.key&&r.target.key==a.key&&pG.viz.scale.lines(r.val)>pG.minLine&&(e=!0),r.source.key==a.key&&r.target.key==t.key&&pG.viz.scale.lines(r.val)>pG.minLine&&(e=!0)}),e?"circImp circImpAct":"circImp"}),pG.viz.links.attr("class",function(a){var e=a.source.x>a.target.x?"link":"link link-left"
return a.source.key==t.key||a.target.key==t.key?e+" linkAct":e})},circExpEnter:function(t){return $("#graph .tooltip").remove(),pG.breakPointSmallScreen?!1:(pG.evs.circsHover(t),void pG.evs.circTooltip(t))},circInEnter:function(t){pG.breakPointSmallScreen||(pG.evs.circsHover(t),pG.evs.circTooltip(t))},circClick:function(t){pG.countryPop.activa(t.key)},circOut:function(t){$("#graph .tooltip").remove(),$("#graph").removeClass("hover"),pG.viz.links.attr("class",pG.evs.linksClass),pG.viz.circExp.attr("class","circExp"),pG.viz.circsImp.attr("class","circImp")},linksVisibilityCheck:function(t){return t.source.name&&!t.source.posX?"hidden":t.source.name&&!t.target.posX?"hidden":2!=pG.act.type.length?"hidden":pG.viz.scale.lines(t.val)<pG.minLine?"hidden":"visible"},textVisibilityCheck:function(t){return t.posX?2==pG.act.type.length?t.rTot<(pG.breakPointSmallScreen?pG.maxWidthTextMovil:pG.maxWidthText)?"hidden":"visible":-1==$.inArray("imp",pG.act.type)?t.rExp<(pG.breakPointSmallScreen?pG.maxWidthTextMovil:pG.maxWidthText)?"hidden":"visible":t.rImp<(pG.breakPointSmallScreen?pG.maxWidthTextMovil:pG.maxWidthText)?"hidden":"visible":"hidden"},circImpVisibilityCheck:function(t){return t.posX?-1==$.inArray("imp",pG.act.type)?"hidden":t.rImp<pG.minCirc?"hidden":"visible":"hidden"},circImpRadius:function(t){return t.posX?-1==$.inArray("imp",pG.act.type)?0:2==pG.act.type.length?t.rTotImp:t.rImp:0},circExpVisibilityCheck:function(t){return t.posX?-1==$.inArray("exp",pG.act.type)?"hidden":(-1==$.inArray("imp",pG.act.type)?t.rExp:t.rTot)<pG.minCirc?"hidden":"visible":"hidden"},circExpRadius:function(t){return t.posX?-1==$.inArray("exp",pG.act.type)?0:-1==$.inArray("imp",pG.act.type)?t.rExp:t.rTot:0},collideRadiusFn:function(t){var a=t.rTot
return 2!=pG.act.type.length&&(a=-1==$.inArray("imp",pG.act.type)?t.rExp:t.rImp),a+5},changeProduct:function(t){t.preventDefault(),$("#prods .act").removeClass("act")
var a=$(this).addClass("act").data("prod")
return a&&pG.act.prod!=a?(pG.act.prod=a,void pG.tools.update()):void console.log("no hay producto")},gotoYear:function(t){!t||pG.act.year==t||t>pG.lastYear||t<pG.initYear||(pG.act.year=t,$("#years .act").removeClass("act"),$("#years .disabled").removeClass("disabled"),$('#years [data-year="'+t+'"]').addClass("act"),t==pG.lastYear&&$("#years .nextYear").addClass("disabled"),t==pG.initYear&&$("#years .prevYear").addClass("disabled"),$("#activeYear").html(t),pG.tools.update())},changeYear:function(t){t.preventDefault(),pG.evs.gotoYear($(this).data("year"))},prevYear:function(t){t.preventDefault(),pG.act.year!=pG.initYear&&pG.evs.gotoYear(pG.act.year-1)},nextYear:function(t){t.preventDefault(),pG.act.year!=pG.lastYear&&pG.evs.gotoYear(pG.act.year+1)},changeType:function(t){t.preventDefault()
var a=$(this),e=a.data("type");-1==$.inArray(e,pG.act.type)?(a.addClass("act"),pG.act.type.push(e)):1==pG.act.type.length?(pG.act.type=["imp","exp"],$("#type a").addClass("act")):(pG.act.type=[e],$("#type a.act").removeClass("act"),a.addClass("act")),pG.tools.update()}}}
pG.init()
