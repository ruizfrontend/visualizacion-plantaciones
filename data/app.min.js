// http://latierraesclava.eldiario.es/ Copyright @eldiarioes 2017
// Visualización @ruizfrontend
function throttle(a,b){var c=!1;return function(){c||(c=!0,setTimeout(function(){a.call(),c=!1},b))}}function numberThousandsDots(a){return a.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1.")}function firstCapital(a){return a.charAt(0).toUpperCase()+a.slice(1)}function millionsParser(a){var b=a/1e6;return b>1?numberThousandsDots(parseInt(b,10)):b.toFixed(2).replace(".",",")}function shareTweet(a,b,c,d){function e(a){return-1!=a.indexOf("#")&&(a=a.substring(0,a.indexOf("#"))),-1!=a.indexOf("?")&&(a=a.substring(0,a.indexOf("?"))),a}if(!a)return!1;var f="scrollbars=yes,resizable=yes,toolbar=no,location=yes",g=550,h=420,i=screen.height,j=screen.width,k=Math.round(j/2-g/2),l=0;i>h&&(l=Math.round(i/2-h/2));var m="https://twitter.com/intent/tweet?text="+encodeURIComponent(a);b&&b!==!1?m+="&url="+e(b):b!==!1&&(m+="&url="+encodeURIComponent(window.location.href)),c&&(m+="&hashtags="+encodeURIComponent(c)),d&&(m+="&via="+encodeURIComponent(d)),window.open(m,"intent",f+",width="+g+",height="+h+",left="+k+",top="+l)}var pG={pathData:"http://estaticos.lab.eldiario.es/estaticos/plantaciones/",pathPaises:"paisesTot.json",pathQuery:"?mls3",act:{year:2014,prod:"cafe",type:["imp","exp"]},breakPoint:800,breakPointClass:"fullGraph",breakPointSmallScreen:null,maxCircProp:25,maxCirc:null,maxLineProp:70,maxLine:null,minLineProp:10,minLine:null,minCircProp:15,minCirc:null,maxWidthText:13,maxWidthTextMovil:11,textYOffsetMovil:3,textYOffset:5,initYear:1995,lastYear:2014,graphsElms:5,viz:{width:0,height:0,$wrap:"#pG",$elm:"#viz",svg:null,projection:null,path:null,map:null,circImp:null,circExp:null,texts:null,force:null,scale:{circImp:null,circExp:null,circImpExp:null,lines:null}},data:{countries:null,yearTopExp:null,yearTopImp:null,totalExp:null,totalImp:null},txt:{articulos:{cafe:"el café",aceite:"el aceite de palma",cacao:"el cacao",banana:"el banano",azucar:"el azúcar"},productos:{cafe:"café",aceite:"aceite de palma",cacao:"cacao",banana:"banano",azucar:"azúcar"}},init:function(){pG.viz.svg=d3.select(pG.viz.$elm),pG.viz.$elm=$(pG.viz.$elm),pG.viz.$wrap=$(pG.viz.$wrap),pG.countryPop.init(),pG.tools.initJqueries(),$(window).bind("orientationchange resize",throttle(pG.tools.handleResize,300)).resize(),-1!=navigator.userAgent.toLowerCase().indexOf("safari/")&&$("body").addClass("safari").find("feGaussianBlur").remove()},tools:{handleResize:function(){pG.tools.loadCountries(),pG.tools.updateProjection(),pG.tools.update()},updateProjection:function(){if(pG.viz.width=$(window).width(),pG.viz.height=pG.viz.width/2,pG.viz.width<pG.breakPoint?($("#blur").remove(),pG.viz.height=pG.viz.width/1.4,pG.viz.$wrap.removeClass(pG.breakPointClass),pG.breakPointSmallScreen=!0):(pG.viz.$wrap.addClass(pG.breakPointClass),pG.viz.width=pG.viz.width-300,pG.viz.height=pG.viz.width/2,pG.breakPointSmallScreen=!1),pG.viz.$elm.css({width:pG.viz.width,height:pG.viz.height}),pG.viz.projection=d3.geoMercator().scale(170*(pG.viz.width/1e3)).translate([pG.viz.width/2-pG.viz.width/14,pG.viz.height/2+pG.viz.height/5]).precision(51),pG.viz.path=d3.geoPath().projection(pG.viz.projection),pG.data.prod)for(var a=0;a<pG.data.prod.length;a++)pG.data.prod[a].x=pG.viz.projection([pG.data.prod[a].lon,pG.data.prod[a].lat])[0],pG.data.prod[a].y=pG.viz.projection([pG.data.prod[a].lon,pG.data.prod[a].lat])[1];pG.maxCirc=parseInt(pG.viz.width/pG.maxCircProp,10),pG.minCirc=Math.ceil(pG.maxCirc/pG.minCircProp),pG.maxLine=parseInt(pG.viz.width/pG.maxLineProp,10),pG.minLine=pG.maxLine/pG.minLineProp},loadCountries:function(a){d3.json(pG.pathData+pG.pathPaises+pG.pathQuery,function(b,c){if(b)throw b;var d=[],e=[];for(var f in c)if(c.hasOwnProperty(f)){var g=c[f];g.key=f,g.posX=pG.viz.projection([g.lon,g.lat])[0],g.posY=pG.viz.projection([g.lon,g.lat])[1],g.x=g.posX,g.y=g.posY,d.push(g),g.x&&g.y&&e.push({value:g.name,data:{id:g.name,key:g.key}})}$("#countryImput").autocomplete({lookup:e,minChars:3,orientation:"bottom",autoSelectFirst:!0,showNoSuggestionNotice:!0,noSuggestionNotice:"No se encontraron coincidencias",groupBy:"p",onSelect:function(a){pG.countryPop.activa(a.data.key)}}),pG.data.countries=d,a&&a()})},update:function(){d3.json(pG.pathData+pG.act.prod+".json"+pG.pathQuery,function(a,b){if(a)throw a;pG.data.countries||pG.tools.loadCountries(function(){pG.tools.processData(b)}),pG.tools.processData(b),pG.countryPop.update()})},getCountry:function(a){for(var b=0;b<pG.data.countries.length;b++)if(pG.data.countries[b].key==a)return pG.data.countries[b];return!1},getdataCountry:function(a){d3.json(pG.pathData+pG.act.prod+".json"+pG.pathQuery,function(b,c){function d(a){for(var b=[],c=0;c<a.length;c++)b.push({data:{name:pG.tools.getCountry(a[c].key).name,key:a[c].key,val:a[c].val},pos:c});return b}if(b)throw b;var e={actCountry:null,expByYear:[],impByYear:[]};if(1==pG.act.type.length){if(-1!=pG.act.type.indexOf("exp")){var f=[];for(var g in c[pG.act.year][a])c[pG.act.year][a].hasOwnProperty(g)&&f.push({key:g,val:c[pG.act.year][a][g]});f.sort(function(a,b){return d3.descending(a.val,b.val)}),e.exports=d(f.slice(0,5))}if(-1!=pG.act.type.indexOf("imp")){var h=[];for(var i in c[pG.act.year])c[pG.act.year].hasOwnProperty(i)&&c[pG.act.year][i][a]&&h.push({key:i,val:c[pG.act.year][i][a]});h.sort(function(a,b){return d3.descending(a.val,b.val)}),e.imports=d(h.slice(0,5))}}for(var j=pG.data.countries.length-1;j>=0;j--)pG.data.countries[j].key==a&&(e.actCountry=pG.data.countries[j]);if(!e.actCountry)throw"No se encontró el pais activo";for(var k=pG.initYear;k<=pG.lastYear;k++){e.expByYear[k]=0,e.impByYear[k]=0;for(var j=pG.data.countries.length-1;j>=0;j--)if(pG.data.countries[j].key==a)for(var l=pG.data.countries.length-1;l>=0;l--)c[k][a]&&c[k][a][pG.data.countries[l].key]&&(e.impByYear[k]+=c[k][a][pG.data.countries[l].key]);else c[k][pG.data.countries[j].key]&&c[k][pG.data.countries[j].key][a]&&(e.expByYear[k]+=c[k][pG.data.countries[j].key][a])}pG.countryPop.draw(e)})},getTop:function(a,b){for(var c=[],d="imp"==b?pG.data.yearTopImp:pG.data.yearTopExp,e=!1,f=0;f<pG.graphsElms;f++)d[f].key==a&&(e=!0),c.push({data:d[f],pos:f});if(e)return c;for(var f=d.length-1;f>=0;f--)if(d[f].key==a)return c.push({data:d[f],pos:f}),c},getFrases:function(a){var b=a.actCountry.name,c=[];if(2==pG.act.type.length){var d=a.actCountry.totalExp-a.actCountry.totalImp,e=pG.tools.getPosition(a,"imp"),f=pG.tools.getPosition(a,"exp");c.push(d>0?"<strong>"+b+"</strong> exportó <strong>"+pG.tools.parseAmmount(d)+" más</strong> en <strong>"+pG.txt.productos[pG.act.prod]+"</strong> de los que importó.":"<strong>"+b+"</strong> importó <strong>"+pG.tools.parseAmmount(-1*d)+" más</strong> en <strong>"+pG.txt.productos[pG.act.prod]+"</strong> de los que exportó."),c.push("<strong>"+b+"</strong> ocupa el puesto número <strong>"+f+"</strong> de países exportadores y el puesto número <strong>"+e+"</strong> de paises importadores de <strong>"+pG.txt.productos[pG.act.prod]+"</strong>.")}else if(-1!=pG.act.type.indexOf("imp")){var g=pG.tools.fixPosition(pG.tools.getPosition(a,"imp")),h=100*a.actCountry.totalImp/pG.data.totalImp,i=100*a.actCountry.totalImp/a.actCountry.resumen.imps[pG.act.year];c.push("<strong>"+b+"</strong> ocupa el <strong>"+g+" puesto</strong> en el ranking de países importadores de <strong>"+pG.txt.productos[pG.act.prod]+"</strong>."),c.push("<strong>"+b+"</strong> controla el <strong>"+h.toFixed(1).replace(".",",")+"%</strong> de las importaciones mundiales de <strong>"+pG.txt.productos[pG.act.prod]+"</strong>."),c.push("<strong>"+firstCapital(pG.txt.articulos[pG.act.prod])+"</strong> supone el "+i.toFixed(1).replace(".",",")+"% de las importaciones de <strong>"+b+"</strong>, "+pG.tools.parseAmmount(a.actCountry.totalImp)+"</strong>.")}else{var j=pG.tools.fixPosition(pG.tools.getPosition(a,"exp")),k=100*a.actCountry.totalExp/pG.data.totalExp,l=100*a.actCountry.totalExp/a.actCountry.resumen.exps[pG.act.year];c.push("<strong>"+b+"</strong> ocupa el <strong>"+j+" puesto</strong> en el ranking de países exportadores de <strong>"+pG.txt.productos[pG.act.prod]+"</strong>."),c.push("<strong>"+b+"</strong> controla el <strong>"+k.toFixed(1).replace(".",",")+"%</strong> de las exportaciones mundiales de <strong>"+pG.txt.productos[pG.act.prod]+"</strong>."),c.push("<strong>"+firstCapital(pG.txt.articulos[pG.act.prod])+"</strong> supone el "+l.toFixed(1).replace(".",",")+"% de las exportaciones de <strong>"+b+"</strong>, "+pG.tools.parseAmmount(a.actCountry.totalExp)+".")}return c},parseAmmount:function(a){return a/1e6>1?numberThousandsDots(Math.round(a/1e6))+" millones de dólares":numberThousandsDots(a)+" dólares"},fixPosition:function(a){switch(a){case 1:return"primer";case 2:return"segundo";case 3:return"tercer";default:return a+"º"}},getPosition:function(a,b){if("imp"==b){for(var c=pG.data.yearTopImp.length-1;c>=0;c--)if(pG.data.yearTopImp[c].key==a.actCountry.key)return c+1}else for(var c=pG.data.yearTopExp.length-1;c>=0;c--)if(pG.data.yearTopExp[c].key==a.actCountry.key)return c+1;return null},processData:function(a){for(var b=pG.data.countries,c=a[pG.act.year],d=[],e=[],f={exp:[],imp:[]},g=b.length-1;g>=0;g--)b[g].totalImp=0,b[g].totalExp=0;for(var h=[],i=0,g=b.length-1;g>=0;g--)if(c[b[g].key])for(var j=b.length-1;j>=0;j--)if(c[b[g].key][b[j].key]){var k=c[b[g].key][b[j].key];b[g].totalExp+=k,b[j].totalImp+=k,h.push(k),k>i&&(i=k),e.push({source:b[g],target:b[j],val:k})}for(var g=0;g<e.length;g++)e[g].val>i/1e3&&d.push(e[g]);pG.data.totalExp=0,pG.data.totalImp=0;for(var g=b.length-1;g>=0;g--)pG.data.totalExp+=b[g].totalExp,pG.data.totalImp+=b[g].totalImp,f.imp.push({key:b[g].key,val:b[g].totalImp,name:b[g].name}),f.exp.push({key:b[g].key,val:b[g].totalExp,name:b[g].name});for(var l=[],m=[],n=[],g=b.length-1;g>=0;g--)b[g].totalImp>0&&l.push(b[g].totalImp),b[g].totalExp>0&&m.push(b[g].totalExp),b[g].totalImp+b[g].totalExp>0&&n.push(b[g].totalImp+b[g].totalExp);pG.data.yearTopExp=f.exp.sort(function(a,b){return d3.descending(a.val,b.val)}),pG.data.yearTopImp=f.imp.sort(function(a,b){return d3.descending(a.val,b.val)}),pG.viz.scale.circImp=d3.scalePow().exponent(.5).domain([0,d3.max(l)]).range([0,pG.maxCirc]),pG.viz.scale.circExp=d3.scalePow().exponent(.5).domain([0,d3.max(m)]).range([0,pG.maxCirc]),pG.viz.scale.circImpExp=d3.scalePow().exponent(.5).domain([0,d3.max(n)]).range([0,pG.maxCirc]),pG.viz.scale.lines=d3.scalePow().exponent(.9).domain([0,d3.max(h)]).range([0,pG.maxLine]);for(var g=b.length-1;g>=0;g--)b[g].rTot=pG.viz.scale.circImpExp(b[g].totalImp+b[g].totalExp),b[g].rTotImp=pG.viz.scale.circImpExp(b[g].totalImp),b[g].rTotExp=pG.viz.scale.circImpExp(b[g].totalExp),b[g].rImp=pG.viz.scale.circImp(b[g].totalImp),b[g].rExp=pG.viz.scale.circExp(b[g].totalExp);pG.viz.circsImp?(pG.viz.links.remove(),pG.viz.links=pG.viz.svg.select(".linksWrap").selectAll(".link").data(d).enter().append("line").attr("class",pG.evs.linksClass).attr("stroke-width",function(a){return pG.viz.scale.lines(a.val)}).on("mouseenter",pG.evs.linksEnter).on("mouseout",pG.evs.circOut)):(pG.viz.links=pG.viz.svg.append("g").attr("class","linksWrap").selectAll(".link").data(d).enter().append("line").attr("class",pG.evs.linksClass).attr("stroke-width",function(a){return pG.viz.scale.lines(a.val)}).on("mouseenter",pG.evs.linksEnter).on("mouseout",pG.evs.circOut),pG.viz.circExp=pG.viz.svg.append("g").attr("class","circExpWrap").selectAll(".circExp").data(b).enter().append("circle").attr("class","circExp").on("mouseenter",pG.evs.circExpEnter).on("mousedown",pG.evs.circClick).on("mouseout",pG.evs.circOut),pG.viz.circsImp=pG.viz.svg.append("g").attr("class","circImpWrap").selectAll(".circImp").data(b).enter().append("circle").attr("class","circImp").on("mouseenter",pG.evs.circInEnter).on("mousedown",pG.evs.circClick).on("mouseout",pG.evs.circOut),pG.viz.texts=pG.viz.svg.append("g").attr("class","textsWrap").selectAll(".text").data(b).enter().append("text").attr("class","text").text(function(a){return a.key.toUpperCase()})),pG.viz.links.data(d).attr("stroke-width",function(a){return pG.viz.scale.lines(a.val)}).attr("class",pG.evs.linksClass).attr("visibility",pG.evs.linksVisibilityCheck).attr("opacity",0).transition().duration(500).attr("opacity",1),pG.viz.circsImp.data(b).attr("visibility",pG.evs.circImpVisibilityCheck).attr("r",pG.evs.circImpRadius).attr("cx",function(a){return a.posX?a.x:void 0}).attr("cy",function(a){return a.posY?a.y:void 0}),pG.viz.circExp.data(b).attr("visibility",pG.evs.circExpVisibilityCheck).attr("r",pG.evs.circExpRadius).attr("cx",function(a){return a.posX?a.x:void 0}).attr("cy",function(a){return a.posY?a.y:void 0}),pG.viz.texts.data(b).attr("visibility",pG.evs.textVisibilityCheck).attr("x",function(a){return a.posX?a.x:void 0}).attr("y",function(a){return a.posY?a.y+(pG.breakPointSmallScreen?3:5):void 0}),pG.viz.force=d3.forceSimulation(b).force("link",d3.forceLink(d).strength(1e-13)).force("collide",d3.forceCollide().radius(pG.evs.collideRadiusFn).iterations(6).strength(1.2)).alphaDecay(pG.breakPointSmallScreen?.8:.6).velocityDecay(.7).on("tick",pG.tools.tick)},tick:function(){pG.viz.circsImp.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}),pG.viz.circExp.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}),pG.viz.links.attr("x1",function(a){return a.source.x}).attr("x2",function(a){return a.target.x}).attr("y1",function(a){return a.source.y}).attr("y2",function(a){return a.target.y}).attr("class",pG.evs.linksClass).attr("visibility",pG.evs.linksVisibilityCheck),pG.viz.texts.attr("x",function(a){return a.x}).attr("y",function(a){return a.y+(pG.breakPointSmallScreen?pG.textYOffset:pG.textYOffset)})},initJqueries:function(){$("#years").find(".gotoYear").click(pG.evs.changeYear).end().find(".nextYear").click(pG.evs.nextYear).end().find(".prevYear").click(pG.evs.prevYear),$("#prods a").click(pG.evs.changeProduct),$("#type a").click(pG.evs.changeType),$("#activeYear").html(pG.act.year),$("#prods a[data-prod="+pG.act.prod+"]").addClass("act"),$(pG.act.type).each(function(a,b){$("#type a[data-type="+b+"]").addClass("act")}),$("body").delegate("#frases li","click",function(){return shareTweet($(this).text().slice(0,-1)+" en "+pG.act.year,"http://latierraesclava.eldiario.es/","latierraesclava","eldiarioes"),!1}).delegate("#searchSelected a","click",function(){return pG.countryPop.hide(),!1})}},countryPop:{active:!1,$elm:"#pop",$frases:"#frases",$graphLines:"#graphLines",$graphBars1:"#graphBars1",$graphBars2:"#graphBars2",init:function(){pG.countryPop.$elm=$(pG.countryPop.$elm),pG.countryPop.$frases=$(pG.countryPop.$frases),pG.countryPop.$graphLines=$(pG.countryPop.$graphLines).find(".inn"),pG.countryPop.$graphBars1=$(pG.countryPop.$graphBars1).find(".inn"),pG.countryPop.$graphBars2=$(pG.countryPop.$graphBars2).find(".inn"),$("#closePop").click(pG.countryPop.hide),pG.viz.$wrap.delegate(".activaCountry","click",function(a){a.preventDefault();var b=$(this),c=b.data("country");if(!c)throw"No se encontró el pais clickado";pG.countryPop.activa(c)}).delegate(".activaYear","click",function(a){a.preventDefault();var b=$(this),c=b.data("year");if(!c)throw"No se encontró el año clickado";pG.evs.gotoYear(c)})},activa:function(a){pG.countryPop.clear();pG.tools.getdataCountry(a);pG.countryPop.active=a,$("#searchHelp").hide(),pG.viz.$wrap.addClass("actPop"),pG.breakPointSmallScreen||(setTimeout(function(){pG.countryPop.activaHover(a)},100),d3.selectAll("feGaussianBlur").transition().attr("stdDeviation",4))},activaHover:function(a){for(var b=0;b<pG.data.countries.length;b++)if(pG.data.countries[b].key==a)return void pG.evs.circsHover(pG.data.countries[b])},hide:function(){pG.countryPop.active=null,pG.viz.$wrap.removeClass("actPop"),pG.countryPop.clear(),pG.breakPointSmallScreen||(d3.selectAll("feGaussianBlur").transition().attr("stdDeviation",0),pG.evs.circOut())},clear:function(){pG.countryPop.active=null,pG.countryPop.$frases.find("*").remove(),pG.countryPop.$graphBars2.find("*").remove(),pG.countryPop.$graphBars1.find("*").remove(),pG.countryPop.$graphLines.find("*").remove(),pG.countryPop.$graphLines.append("<svg></svg>"),$("#searchHelp").show(),$("#searchSelected").hide().html("")},update:function(){pG.countryPop.active&&pG.countryPop.activa(pG.countryPop.active)},draw:function(a){var b=pG.tools.getFrases(a);$.each(b,function(a,b){pG.countryPop.$frases.append($("<li>"+b+'<i class="fa fa-twitter" aria-hidden="true"></i></li>'))}),$("#searchSelected").show().html('<a href="#" class="clearPop">'+a.actCountry.name+"</a>"),pG.breakPointSmallScreen||(pG.countryPop.drawEvol(pG.countryPop.$graphLines,a),2==pG.act.type.length?(pG.countryPop.drawBarras(pG.tools.getTop(a.actCountry.key,"exp"),a,pG.countryPop.$graphBars1,"exp"),pG.countryPop.drawBarras(pG.tools.getTop(a.actCountry.key,"imp"),a,pG.countryPop.$graphBars2,"imp")):-1==$.inArray("imp",pG.act.type)?(pG.countryPop.drawBarras(pG.tools.getTop(a.actCountry.key,"exp"),a,pG.countryPop.$graphBars1,"exp"),pG.countryPop.drawBarras(a.exports,a,pG.countryPop.$graphBars2,"expInternal")):(pG.countryPop.drawBarras(pG.tools.getTop(a.actCountry.key,"imp"),a,pG.countryPop.$graphBars1,"imp"),pG.countryPop.drawBarras(a.imports,a,pG.countryPop.$graphBars2,"impInternal")))},drawBarras:function(a,b,c,d){switch(d){case"exp":c.addClass("graphBarsExp").append('<h4 style="text-transform: uppercase">Ranking de países <br>exportadores</h4><p style="margin-bottom: 0.8em">En millones de dolares</p>');break;case"imp":c.addClass("graphBarsImp").append('<h4 style="text-transform: uppercase">Ranking de países <br>importadores</h4><p style="margin-bottom: 0.8em">En millones de dolares</p>');break;case"expInternal":c.addClass("graphBarsImp").append('<h4 style="text-transform: uppercase">Principales paises<br>a los que exporta</h4><p style="margin-bottom: 0.8em">En millones de dolares</p>');break;case"impInternal":c.addClass("graphBarsImp").append('<h4 style="text-transform: uppercase">Principales paises<br>de los que importa</h4><p style="margin-bottom: 0.8em">En millones de dolares</p>')}var e=d3.max(a,function(a){return a.data.val});$.each(a,function(a,f){a==pG.graphsElms&&pG.countryPop.$graphBars1.append("<li>....</li>");var g=null;g=$("exp"==d||"imp"==d?'<li><a data-toggle="tooltip" href="#" class="activaCountry'+(f.data.key==b.actCountry.key?" activeBar":"")+'" data-country="'+f.data.key+'"><span class="key">'+f.data.key+'</span><div class="bar" title="'+f.data.name+("imp"==d?" importó ":" exportó ")+pG.tools.parseAmmount(f.data.val)+" de "+pG.txt.productos[pG.act.prod]+" en "+pG.act.year+'" data-width=""><span class="text">'+millionsParser(f.data.val)+"</span></div></a></li>":'<li><a data-toggle="tooltip" href="#" class="activaCountry'+(f.data.key==b.actCountry.key?" activeBar":"")+'" data-country="'+f.data.key+'"><span class="key">'+f.data.key+'</span><div class="bar" title="'+b.actCountry.name+("impInternal"==d?" importó ":" exportó ")+pG.tools.parseAmmount(f.data.val)+" de "+pG.txt.productos[pG.act.prod]+("impInternal"==d?" de ":" a ")+f.data.name+" en "+pG.act.year+'" data-width=""><span class="text">'+millionsParser(f.data.val)+"</span></div></a></li>"),c.append(g);var h=100*f.data.val/e;g.find(".bar").tooltip(),g.find(".bar").stop(!1,!1).css("width",0).animate({width:h},1e3),40>h&&g.find(".bar").addClass("bar-left")})},drawEvol:function(a,b){a.prepend('<h4 style="text-transform: uppercase">Evolución importaciones y exportaciones de '+pG.txt.productos[pG.act.prod]+'</h4><p style="margin-bottom: 0.8em">En millones de dolares</p>');var c=d3.max([d3.max(d3.entries(b.expByYear),function(a){return parseInt(a.value,10)}),d3.max(d3.entries(b.impByYear),function(a){return parseInt(a.value,10)})]),d=30,e=5,f=210,g=.6*f,h=d3.scaleLinear().domain([0,c]).range([g,0]),i=d3.axisLeft(h).ticks(4).tickSize(0).tickFormat(function(a){return parseInt(a/1e6,10)}),j=pG.lastYear-pG.initYear,k=(f-d)/j,l="M"+d+" "+(g+e)+" L",m="M",n="M"+d+" "+(g+e)+" L",o="M",p="M"+d+" "+(g+e)+" L",q="M",r=d3.select(a.find("svg")[0]).attr("width",f+3).attr("height",g+2*e);r.append("g").attr("transform","translate("+(d-5)+" ,"+e+")").attr("class","axes").call(i);for(var s=r.append("g").attr("class","lines"),t=r.append("g").attr("class","dots"),u=0;j>=u;u++){var v=d+k*u,w=e+h(b.expByYear[pG.initYear+u]),x=e+h(b.impByYear[pG.initYear+u]);l+=v+" "+(g+e)+" L",m+=v+" "+(g+e)+" L",n+=v+" "+x+" L",o+=v+" "+x+" L",p+=v+" "+w+" L",q+=v+" "+w+" L",t.append("circle").attr("class","circLinesWhite").attr("cx",v).attr("cy",w).attr("r",4).attr("opacity",0).transition().duration(2e3).attr("opacity",1),t.append("circle").on("mouseenter",pG.evs.circGraphTooltip).on("mouseout",pG.evs.circGraphTooltipOut).attr("class","circLines linesExp activaYear"+(pG.initYear+u==pG.act.year?" linesExpFill":"")).attr("data-year",pG.initYear+u).attr("cx",v).attr("cy",w).attr("r",3).attr("stroke","#126567").attr("title",b.actCountry.name+" importó "+pG.tools.parseAmmount(b.expByYear[pG.initYear+u])+" de "+pG.txt.productos[pG.act.prod]+" en "+(pG.initYear+u)+".").attr("opacity",0).transition().duration(2e3).attr("opacity",1),t.append("circle").attr("class","circLinesWhite").attr("cx",v).attr("cy",x).attr("r",4).attr("opacity",0).transition().duration(2e3).attr("opacity",1),t.append("circle").on("mouseenter",pG.evs.circGraphTooltip).on("mouseout",pG.evs.circGraphTooltipOut).attr("class","circLines linesImp activaYear"+(pG.initYear+u==pG.act.year?" linesImpFill":"")).attr("data-year",pG.initYear+u).attr("cx",v).attr("cy",x).attr("r",3).attr("title",b.actCountry.name+" exportó "+pG.tools.parseAmmount(b.impByYear[pG.initYear+u])+" de "+pG.txt.productos[pG.act.prod]+" en "+(pG.initYear+u)+".").attr("opacity",0).transition().duration(2e3).attr("opacity",1)}l+=d+f+" "+(g+e)+" L"+d+" 0 Z",n+=d+f+" "+(g+e)+" Z",p+=d+f+" "+(g+e)+" Z",s.append("path").attr("d",l).attr("stroke","none").attr("fill","rgba(211, 93, 51, 0.1)").transition().duration(1e3).attr("d",n),s.append("path").attr("d",l).attr("stroke","none").attr("fill","rgba(150, 203, 81, 0.1)").transition().duration(1e3).attr("d",p),s.append("path").attr("d",m.slice(0,-1)).attr("stroke","rgb(211, 93, 51)").attr("stroke-width","1").attr("fill","none").transition().duration(1e3).attr("d",o.slice(0,-1)),s.append("path").attr("d",m.slice(0,-1)).attr("stroke","#126567").attr("stroke-width","1").attr("fill","none").transition().duration(1e3).attr("d",q.slice(0,-1))}},evs:{circGraphTooltipOut:function(){$("#pop .tooltip").remove()},circGraphTooltip:function(){var a=$(this),b=$("#pop"),c=a.offset().left-b.offset().left,d=b.height()-(a.offset().top-b.offset().top),e=$('<div class="tooltip top" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner">'+a.attr("title")+"</div></div>");e.css({bottom:d,left:c-98}),b.append(e),e.animate({opacity:1},400)},circTooltip:function(a){var b=a.y,c=a.x-100,d="";2==pG.act.type.length?(d="<strong>"+a.name+"</strong> exportó "+pG.tools.parseAmmount(a.totalExp)+" e importó "+pG.tools.parseAmmount(a.totalImp)+" de <strong>"+pG.txt.productos[pG.act.prod]+"</strong> en "+pG.act.year,b-=a.rTot+4):-1!=pG.act.type.indexOf("exp")?(d="<strong>"+a.name+"</strong> exportó "+pG.tools.parseAmmount(a.totalExp)+" de <strong>"+pG.txt.productos[pG.act.prod]+"</strong> en "+pG.act.year,b-=a.rExp+4):(d="<strong>"+a.name+"</strong> importó "+pG.tools.parseAmmount(a.totalImp)+" de <strong>"+pG.txt.productos[pG.act.prod]+"</strong> en "+pG.act.year,b-=a.rImp+4),b=$("#graph").height()-b;var e=$('<div class="tooltip top" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner">'+d+"</div></div>");e.css({bottom:b,left:c}).appendTo("#graph"),e.animate({opacity:1},400)},linksClass:function(a){return a.source.x>a.target.x?"link":"link link-left"},linksEnter:function(a){return pG.breakPointSmallScreen?!1:(pG.evs.linesHover(a),void pG.evs.linesTooltip(a))},linesHover:function(a){$("#graph").addClass("hover"),pG.viz.links.attr("class",function(b){var c=b.source.x>b.target.x?"link":"link link-left";return b==a?c+" linkAct":c}),pG.viz.circExp.attr("class",function(b){return a.target==b||a.source==b?"circExp circExpAct":"circExp"}),pG.viz.circsImp.attr("class",function(b){return a.target==b||a.source==b?"circImp circImpAct":"circImp"})},linesTooltip:function(a){var b=(a.source.x+a.target.x)/2-100,c=(a.source.y+a.target.y)/2-5,d="<strong>"+a.source.name+"</strong> exportó "+pG.tools.parseAmmount(a.val)+" de <strong>"+pG.txt.productos[pG.act.prod]+"</strong> a <strong>"+a.target.name+"</strong> en "+pG.act.year;c=$("#graph").height()-c;var e=$('<div class="tooltip top" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner">'+d+"</div></div>");e.css({bottom:c,left:b}).appendTo("#graph"),e.animate({opacity:1},400)},circsHover:function(a){$("#graph").addClass("hover"),pG.viz.circExp.attr("class",function(b){if(b.key==a.key)return"circExp circExpAct";var c=!1;return pG.viz.links.each(function(d){d.source.key==a.key&&d.target.key==b.key&&pG.viz.scale.lines(d.val)>pG.minLine&&(c=!0),d.source.key==b.key&&d.target.key==a.key&&pG.viz.scale.lines(d.val)>pG.minLine&&(c=!0)}),c?"circExp circExpAct":"circExp"}),pG.viz.circsImp.attr("class",function(b){if(b.key==a.key)return"circImp circImpAct";var c=!1;return pG.viz.links.each(function(d){d.source.key==a.key&&d.target.key==b.key&&pG.viz.scale.lines(d.val)>pG.minLine&&(c=!0),d.source.key==b.key&&d.target.key==a.key&&pG.viz.scale.lines(d.val)>pG.minLine&&(c=!0)}),c?"circImp circImpAct":"circImp"}),pG.viz.links.attr("class",function(b){var c=b.source.x>b.target.x?"link":"link link-left";return b.source.key==a.key||b.target.key==a.key?c+" linkAct":c})},circExpEnter:function(a){return $("#graph .tooltip").remove(),pG.breakPointSmallScreen?!1:(pG.evs.circsHover(a),void pG.evs.circTooltip(a))},circInEnter:function(a){pG.breakPointSmallScreen||(pG.evs.circsHover(a),pG.evs.circTooltip(a))},circClick:function(a){pG.countryPop.activa(a.key)},circOut:function(){$("#graph .tooltip").remove(),$("#graph").removeClass("hover"),pG.viz.links.attr("class",pG.evs.linksClass),pG.viz.circExp.attr("class","circExp"),pG.viz.circsImp.attr("class","circImp")},linksVisibilityCheck:function(a){return a.source.name&&!a.source.posX?"hidden":a.source.name&&!a.target.posX?"hidden":2!=pG.act.type.length?"hidden":pG.viz.scale.lines(a.val)<pG.minLine?"hidden":"visible"},textVisibilityCheck:function(a){return a.posX?2==pG.act.type.length?a.rTot<(pG.breakPointSmallScreen?pG.maxWidthTextMovil:pG.maxWidthText)?"hidden":"visible":-1==$.inArray("imp",pG.act.type)?a.rExp<(pG.breakPointSmallScreen?pG.maxWidthTextMovil:pG.maxWidthText)?"hidden":"visible":a.rImp<(pG.breakPointSmallScreen?pG.maxWidthTextMovil:pG.maxWidthText)?"hidden":"visible":"hidden"},circImpVisibilityCheck:function(a){return a.posX?-1==$.inArray("imp",pG.act.type)?"hidden":a.rImp<pG.minCirc?"hidden":"visible":"hidden"},circImpRadius:function(a){return a.posX?-1==$.inArray("imp",pG.act.type)?0:2==pG.act.type.length?a.rTotImp:a.rImp:0},circExpVisibilityCheck:function(a){return a.posX?-1==$.inArray("exp",pG.act.type)?"hidden":(-1==$.inArray("imp",pG.act.type)?a.rExp:a.rTot)<pG.minCirc?"hidden":"visible":"hidden"},circExpRadius:function(a){return a.posX?-1==$.inArray("exp",pG.act.type)?0:-1==$.inArray("imp",pG.act.type)?a.rExp:a.rTot:0},collideRadiusFn:function(a){var b=a.rTot;return 2!=pG.act.type.length&&(b=-1==$.inArray("imp",pG.act.type)?a.rExp:a.rImp),b+5},changeProduct:function(a){a.preventDefault(),$("#prods .act").removeClass("act");var b=$(this).addClass("act").data("prod");return b&&pG.act.prod!=b?(pG.act.prod=b,void pG.tools.update()):void console.log("no hay producto")},gotoYear:function(a){!a||pG.act.year==a||a>pG.lastYear||a<pG.initYear||(pG.act.year=a,$("#years .act").removeClass("act"),$("#years .disabled").removeClass("disabled"),$('#years [data-year="'+a+'"]').addClass("act"),a==pG.lastYear&&$("#years .nextYear").addClass("disabled"),a==pG.initYear&&$("#years .prevYear").addClass("disabled"),$("#activeYear").html(a),pG.tools.update())},changeYear:function(a){a.preventDefault(),pG.evs.gotoYear($(this).data("year"))},prevYear:function(a){a.preventDefault(),pG.act.year!=pG.initYear&&pG.evs.gotoYear(pG.act.year-1)},nextYear:function(a){a.preventDefault(),pG.act.year!=pG.lastYear&&pG.evs.gotoYear(pG.act.year+1)},changeType:function(a){a.preventDefault();var b=$(this),c=b.data("type");-1==$.inArray(c,pG.act.type)?(b.addClass("act"),pG.act.type.push(c)):1==pG.act.type.length?(pG.act.type=["imp","exp"],$("#type a").addClass("act")):(pG.act.type=[c],$("#type a.act").removeClass("act"),b.addClass("act")),pG.tools.update()}}};pG.init();